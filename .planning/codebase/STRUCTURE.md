# Codebase Structure

**Analysis Date:** 2026-02-17

## Directory Layout

```
/data/data/com.termux/files/home/repos/multibot2/
├── bot/                    # Main application code
│   ├── __init__.py         # Package marker (empty)
│   ├── main.py             # Application entry point
│   ├── config.py           # Configuration management (BotConfig)
│   ├── handlers.py         # Telegram handlers (commands, messages)
│   ├── error_handler.py    # Error handling and custom exceptions
│   ├── temp_manager.py     # Temporary file management
│   ├── validators.py       # Input validation (size, integrity, disk space)
│   ├── video_processor.py  # Video to video note conversion
│   ├── format_processor.py # Format conversion and audio extraction
│   ├── split_processor.py  # Video splitting functionality
│   └── join_processor.py   # Video joining functionality
├── .planning/              # Project planning documents
│   ├── codebase/           # Codebase analysis documents
│   ├── phases/             # Phase-specific plans and summaries
│   └── milestones/         # Milestone archives
├── run.py                  # Entry point script
├── requirements.txt        # Python dependencies
├── .env                    # Environment variables (not committed)
└── .env.example            # Environment variable template
```

## Directory Purposes

**bot/:**
- Purpose: All application code
- Contains: Python modules for handlers, processors, services
- Key files: `main.py`, `handlers.py`, `config.py`
- Import pattern: `from bot.module import Class`

**.planning/:**
- Purpose: Project documentation and planning
- Contains: Roadmaps, requirements, phase plans, codebase analysis
- Key files: `ROADMAP.md`, `REQUIREMENTS.md`
- Not imported by application code

**.planning/codebase/:**
- Purpose: Codebase analysis for GSD commands
- Contains: Architecture, structure, conventions, testing docs
- Generated by `/gsd:map-codebase` command

**.planning/phases/:**
- Purpose: Phase-specific implementation plans
- Contains: PLAN.md, RESEARCH.md, SUMMARY.md for each phase
- Naming: `{phase-number}-{phase-name}/`

## Key File Locations

**Entry Points:**
- `/data/data/com.termux/files/home/repos/multibot2/run.py`: Simple wrapper that calls main()
- `/data/data/com.termux/files/home/repos/multibot2/bot/main.py`: Actual application startup

**Configuration:**
- `/data/data/com.termux/files/home/repos/multibot2/bot/config.py`: BotConfig dataclass
- `/data/data/com.termux/files/home/repos/multibot2/.env`: Environment variables (BOT_TOKEN, etc.)
- `/data/data/com.termux/files/home/repos/multibot2/.env.example`: Template for required env vars

**Core Logic:**
- `/data/data/com.termux/files/home/repos/multibot2/bot/handlers.py`: All Telegram handlers (~1180 lines)
- `/data/data/com.termux/files/home/repos/multibot2/bot/video_processor.py`: Video note conversion
- `/data/data/com.termux/files/home/repos/multibot2/bot/format_processor.py`: Format conversion, audio extraction
- `/data/data/com.termux/files/home/repos/multibot2/bot/split_processor.py`: Video splitting
- `/data/data/com.termux/files/home/repos/multibot2/bot/join_processor.py`: Video joining

**Infrastructure:**
- `/data/data/com.termux/files/home/repos/multibot2/bot/temp_manager.py`: TempManager class
- `/data/data/com.termux/files/home/repos/multibot2/bot/validators.py`: Validation functions
- `/data/data/com.termux/files/home/repos/multibot2/bot/error_handler.py`: Error handling

**Testing:**
- No test directory detected in current codebase
- Tests would go in: `tests/` or `bot/tests/` (not yet created)

## Naming Conventions

**Files:**
- Pattern: `snake_case.py`
- Processor files: `{action}_processor.py` (video_processor, format_processor, etc.)
- Handler files: `{purpose}_handler.py` or `handlers.py`

**Directories:**
- Pattern: `snake_case/`
- Planning directories: numbered phases `{NN}-{name}/`

**Classes:**
- Pattern: PascalCase
- Processors: `{Action}Processor` (VideoProcessor, FormatConverter, AudioExtractor)
- Managers: `{Purpose}Manager` (TempManager)
- Config: `BotConfig`
- Exceptions: `{Error}Error` (VideoProcessingError, DownloadError)

**Functions:**
- Pattern: `snake_case`
- Handlers: `handle_{resource}_{action}` (handle_video, handle_convert_command)
- Private helpers: `_{action}_{purpose}` (_download_with_retry, _get_video_from_message)
- Validators: `validate_{aspect}` (validate_file_size, validate_video_file)

**Variables:**
- Pattern: `snake_case`
- Constants: `UPPER_SNAKE_CASE` (DEFAULT_SEGMENT_DURATION)
- Private: `_leading_underscore`

## Where to Add New Code

**New Audio Processor (for Phase 3):**
- Implementation: `bot/audio_processor.py`
- Follow pattern from `bot/video_processor.py`
- Class with `__init__(input_path, output_path)` and `process()` method

**New Audio Handlers:**
- Add to: `bot/handlers.py`
- Pattern: `handle_{audio_action}()` async functions
- Register in: `bot/main.py` handler registration section

**New Configuration Options:**
- Add field to: `bot/config.py` BotConfig dataclass
- Add default to: `_int_env()` or `os.getenv()` call in `load_config()`
- Add validation to: `__post_init__()` if needed

**New Validators:**
- Add to: `bot/validators.py`
- Pattern: Return `(bool, Optional[str])` tuple
- Spanish error messages

**New Error Types:**
- Add to: `bot/error_handler.py`
- Inherit from `VideoProcessingError` (or create `AudioProcessingError`)
- Add to `ERROR_MESSAGES` dict with Spanish message

## Special Directories

**__pycache__/:**
- Purpose: Python bytecode cache
- Generated: Yes (by Python interpreter)
- Committed: No (in .gitignore)

**temp directories:**
- Purpose: Temporary file storage during processing
- Location: System temp dir with `videonote_*` prefix
- Generated: Yes (by TempManager)
- Committed: No (auto-cleaned on startup and shutdown)

---

*Structure analysis: 2026-02-17*
