---
phase: 05-audio-format-conversion
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "User can use /convert_audio command to start format conversion"
    - "Bot presents inline keyboard with format options (MP3, WAV, OGG, AAC, FLAC)"
    - "User can select output format via callback"
    - "Bot converts and sends the converted file"
    - "Help text includes /convert_audio command description"
  artifacts:
    - path: "bot/handlers.py"
      provides: "handle_convert_audio_command and handle_format_selection callback"
      contains: ["async def handle_convert_audio_command", "async def handle_format_selection"]
    - path: "bot/main.py"
      provides: "Command and callback handler registration"
      contains: ["CommandHandler.*convert_audio", "CallbackQueryHandler.*format_selection"]
  key_links:
    - from: "bot/handlers.py"
      to: "bot/audio_format_converter.py"
      via: "import AudioFormatConverter"
      pattern: "from bot.audio_format_converter import"
    - from: "bot/main.py"
      to: "bot/handlers.py"
      via: "handler import and registration"
      pattern: "from bot.handlers import.*handle_convert_audio"
---

<objective>
Implement the /convert_audio command handler with format selection via inline keyboard, allowing users to convert audio files to their chosen format.

Purpose: Provide user-facing interface for audio format conversion with intuitive format selection.
Output: Handler functions registered in the bot for /convert_audio command and format selection callbacks.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-audio-format-conversion/05-01-SUMMARY.md
@bot/handlers.py
@bot/main.py
@bot/audio_format_converter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement handle_convert_audio_command and format selection</name>
  <files>bot/handlers.py</files>
  <action>
    Add to bot/handlers.py:

    1. Import AudioFormatConverter and detect_audio_format from bot.audio_format_converter
    2. Import AudioFormatConversionError from bot.error_handler

    3. Create handle_convert_audio_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
       - Check if message has an audio file attached (reply to audio or audio in same message)
       - If no audio file, reply with usage instructions (Spanish): "EnvÃ­a /convert_audio respondiendo a un archivo de audio o adjunta el audio al mensaje."
       - If audio file exists, show inline keyboard with format options using InlineKeyboardMarkup
       - Store file_id in context.user_data["convert_audio_file_id"] for later retrieval
       - Format buttons: MP3, WAV, OGG, AAC, FLAC (5 buttons in 2 rows: 3 + 2)
       - Callback data format: "format:mp3", "format:wav", etc.

    4. Create handle_format_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
       - Extract format from callback_query.data (e.g., "format:mp3" -> "mp3")
       - Answer callback query to remove loading state
       - Retrieve file_id from context.user_data
       - Download audio file to temp directory using TempManager
       - Validate audio file using validate_audio_file
       - Detect input format using detect_audio_format
       - If input format == output format, reply with error message
       - Convert using AudioFormatConverter
       - Send converted file back to user
       - Clean up temp files
       - Handle errors with AudioFormatConversionError

    5. Add Spanish user messages following existing patterns in handlers.py
    6. Add proper logging (English)
    7. Use correlation_id for request tracing

    Follow the exact pattern from handle_extract_audio and handle_split_audio_command.
  </action>
  <verify>grep -n "handle_convert_audio_command\|handle_format_selection" bot/handlers.py | head -20</verify>
  <done>Both handler functions exist with proper implementation for command and callback handling</done>
</task>

<task type="auto">
  <name>Task 2: Register handlers and update help text</name>
  <files>bot/main.py</files>
  <action>
    Modify bot/main.py:

    1. Import new handlers:
       - Add handle_convert_audio_command and handle_format_selection to imports from bot.handlers

    2. Register command handler:
       - Add CommandHandler("convert_audio", handle_convert_audio_command) to handlers list
       - Place after join_audio handler (alphabetical order)

    3. Register callback handler:
       - Add CallbackQueryHandler(handle_format_selection, pattern="^format:") to handlers list
       - Place after other callback handlers

    4. Update help text in handle_help function:
       - Add line: "/convert_audio - Convierte un audio a otro formato (MP3, WAV, OGG, AAC, FLAC)"
       - Place after /join_audio in the Audio section

    Follow the exact registration pattern from existing handlers like split_audio and join_audio.
  </action>
  <verify>grep -n "convert_audio\|format_selection" bot/main.py | head -20</verify>
  <done>Handlers registered in main.py and help text updated with /convert_audio description</done>
</task>

</tasks>

<verification>
- handle_convert_audio_command exists in handlers.py
- handle_format_selection callback handler exists
- Both handlers imported and registered in main.py
- Help text includes /convert_audio command
- Format selection uses inline keyboard with 5 format options
</verification>

<success_criteria>
1. User can send /convert_audio command (alone or replying to audio)
2. Bot presents inline keyboard with MP3, WAV, OGG, AAC, FLAC options
3. User can select format and bot converts the audio
4. Converted file is sent back to user
5. Help text documents the new command
6. Error handling provides Spanish user-friendly messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-audio-format-conversion/05-02-SUMMARY.md`
</output>
