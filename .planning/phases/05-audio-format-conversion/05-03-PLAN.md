---
phase: 05-audio-format-conversion
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - bot/audio_format_converter.py
autonomous: true

must_haves:
  truths:
    - "Audio metadata (title, artist, album, etc.) is preserved during conversion when format supports it"
    - "MP3 output includes ID3v2.3 tags from source"
    - "FLAC output includes Vorbis comments from source"
    - "OGG output includes Vorbis comments from source"
    - "WAV and AAC preserve metadata when possible"
  artifacts:
    - path: "bot/audio_format_converter.py"
      provides: "Metadata preservation in AudioFormatConverter.convert()"
      contains: ["-map_metadata", "0", "-id3v2_version"]
  key_links:
    - from: "bot/audio_format_converter.py"
      to: "ffmpeg metadata options"
      via: "-map_metadata 0 flag in ffmpeg command"
      pattern: "-map_metadata.*0"
---

<objective>
Implement metadata preservation during audio format conversion, ensuring that audio metadata (title, artist, album, etc.) is preserved when converting between formats that support metadata.

Purpose: Maintain audio metadata (ID3 tags, Vorbis comments) during format conversion for better user experience and file organization.
Output: Enhanced AudioFormatConverter with metadata preservation support for all applicable formats.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/05-audio-format-conversion/05-01-SUMMARY.md
@bot/audio_format_converter.py
@bot/audio_processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance AudioFormatConverter with metadata preservation</name>
  <files>bot/audio_format_converter.py</files>
  <action>
    Update bot/audio_format_converter.py to add metadata preservation:

    1. Update SUPPORTED_FORMATS configuration to include metadata options:
       - MP3: Add -map_metadata 0, -id3v2_version 3 (already in VoiceToMp3Converter pattern)
       - FLAC: Add -map_metadata 0, -compression_level 5
       - OGG: Add -map_metadata 0
       - AAC: Add -map_metadata 0
       - WAV: Add -map_metadata 0 (limited support but try)

    2. Update the convert() method to:
       - Add -map_metadata 0 flag before output file (copies all metadata streams)
       - Add format-specific metadata flags:
         * MP3: -id3v2_version 3 (for ID3 tag compatibility)
         * FLAC: -compression_level 5 (standard compression)

    3. Add helper function extract_metadata(file_path: str) -> dict:
       - Use ffprobe to extract common metadata fields:
         * title, artist, album, year, genre, comment
       - Return dict with available metadata
       - Used for logging/debugging metadata preservation

    4. Add helper function has_metadata_support(format_name: str) -> bool:
       - Returns True for MP3, FLAC, OGG, AAC
       - Returns False for WAV (limited metadata support)

    5. Add logging for metadata:
       - Log when metadata is being preserved
       - Log metadata fields found in source (debug level)
       - Log if metadata cannot be preserved for target format (warning level)

    6. Update __all__ to include new helper functions if added

    Follow the ffmpeg metadata patterns from VoiceToMp3Converter in audio_processor.py.
  </action>
  <verify>grep -n "map_metadata\|id3v2_version\|extract_metadata\|has_metadata_support" bot/audio_format_converter.py</verify>
  <done>AudioFormatConverter includes -map_metadata 0 for all formats, format-specific options applied, metadata helper functions exist</done>
</task>

</tasks>

<verification>
- AudioFormatConverter.convert() includes -map_metadata 0 flag
- MP3 output uses -id3v2_version 3 for compatibility
- FLAC uses -compression_level 5
- Metadata preservation is logged appropriately
- Code follows existing patterns from VoiceToMp3Converter
</verification>

<success_criteria>
1. AudioFormatConverter preserves metadata during conversion for formats that support it
2. MP3 output includes ID3v2.3 tags copied from source
3. FLAC output preserves Vorbis comments
4. OGG output preserves metadata
5. WAV conversion attempts metadata preservation (limited by format)
6. Metadata operations are logged for debugging
7. No breaking changes to existing convert() interface
</success_criteria>

<output>
After completion, create `.planning/phases/05-audio-format-conversion/05-03-SUMMARY.md`
</output>
