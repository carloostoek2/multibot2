---
phase: 05-audio-format-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/audio_format_converter.py
  - bot/error_handler.py
autonomous: true

must_haves:
  truths:
    - "AudioFormatConverter class exists and can convert between MP3, WAV, OGG, AAC, FLAC"
    - "Format detection works automatically using ffprobe"
    - "Each format uses appropriate codec and quality settings"
    - "AudioFormatConversionError exception exists for error handling"
  artifacts:
    - path: "bot/audio_format_converter.py"
      provides: "AudioFormatConverter class with convert() method"
      min_lines: 150
      exports: ["AudioFormatConverter", "detect_audio_format", "get_supported_audio_formats"]
    - path: "bot/error_handler.py"
      provides: "AudioFormatConversionError exception"
      contains: "class AudioFormatConversionError"
  key_links:
    - from: "bot/audio_format_converter.py"
      to: "bot/error_handler.py"
      via: "import AudioFormatConversionError"
      pattern: "from bot.error_handler import AudioFormatConversionError"
---

<objective>
Create the audio format conversion infrastructure with AudioFormatConverter class that can convert audio files between MP3, WAV, OGG, AAC, and FLAC formats with automatic format detection.

Purpose: Provide the core conversion engine that will be used by the /convert_audio command handler.
Output: bot/audio_format_converter.py with converter class and format detection utilities.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/format_processor.py
@bot/audio_processor.py
@bot/error_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AudioFormatConversionError exception</name>
  <files>bot/error_handler.py</files>
  <action>
    Add AudioFormatConversionError exception class to bot/error_handler.py following the existing pattern:
    - Inherit from VideoProcessingError
    - Default Spanish message: "Error convirtiendo el formato del audio"
    - Add to ERROR_MESSAGES dict with user-friendly Spanish message
    - Place after AudioJoinError class (alphabetical order)
  </action>
  <verify>grep -n "class AudioFormatConversionError" bot/error_handler.py && grep -n "AudioFormatConversionError" bot/error_handler.py | wc -l</verify>
  <done>AudioFormatConversionError class exists and is registered in ERROR_MESSAGES dict</done>
</task>

<task type="auto">
  <name>Task 2: Create AudioFormatConverter class</name>
  <files>bot/audio_format_converter.py</files>
  <action>
    Create bot/audio_format_converter.py with:

    1. AudioFormatConverter class following the pattern from AudioExtractor in format_processor.py:
       - __init__(self, input_path: str, output_path: str)
       - SUPPORTED_FORMATS dict mapping format to codec config (codec, bitrate, extra_options)
       - convert(self, output_format: str) -> bool method

    2. Format configurations:
       - MP3: libmp3lame, 192k, -q:a 2, -map_metadata 0, -id3v2_version 3
       - WAV: pcm_s16le, no bitrate, -map_metadata 0
       - OGG: libvorbis, 192k, -map_metadata 0
       - AAC: aac, 192k, -map_metadata 0
       - FLAC: flac, no bitrate, -map_metadata 0, -compression_level 5

    3. Static methods:
       - _check_ffmpeg() -> bool
       - get_supported_formats() -> list[str] (returns ["mp3", "wav", "ogg", "aac", "flac"])

    4. detect_audio_format(file_path: str) -> Optional[str] function using ffprobe to detect input format

    5. Proper error handling with AudioFormatConversionError
    6. English logging following existing patterns
    7. __all__ exports list

    Follow the exact code structure from AudioExtractor for ffmpeg command building.
  </action>
  <verify>python -c "from bot.audio_format_converter import AudioFormatConverter, detect_audio_format, get_supported_audio_formats; print('Imports OK'); print('Supported:', get_supported_audio_formats())"</verify>
  <done>AudioFormatConverter class exists with convert() method, format detection works, all 5 formats supported</done>
</task>

</tasks>

<verification>
- AudioFormatConversionError exists in error_handler.py
- AudioFormatConverter can be imported from audio_format_converter.py
- All 5 formats (MP3, WAV, OGG, AAC, FLAC) are supported
- Format detection function works with ffprobe
- Code follows existing patterns from format_processor.py
</verification>

<success_criteria>
1. AudioFormatConverter class can convert audio files between all supported formats
2. Format detection automatically identifies input format using ffprobe
3. Each format uses appropriate codec and quality settings
4. Error handling uses AudioFormatConversionError with Spanish messages
5. Module follows existing codebase patterns (logging, structure, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/05-audio-format-conversion/05-01-SUMMARY.md`
</output>
