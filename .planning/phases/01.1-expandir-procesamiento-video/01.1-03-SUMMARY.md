# Phase 1.1 Plan 03: Video Joining Summary

**One-liner:** VideoJoiner class with Telegram /join command for merging 2-10 videos into a single continuous video with automatic format normalization.

---

## Completed Tasks

| Task | Description | Commit |
|------|-------------|--------|
| 1 | Create VideoJoiner class with ffmpeg concat demuxer | d1430a0 |
| 2 | Extend TempManager for multi-file session tracking | ce6f218 |
| 3 | Add /join command and video collection flow | 21de8f6 |

---

## Key Features Implemented

### VideoJoiner Class (`bot/join_processor.py`)
- **Concat demuxer**: Uses ffmpeg concat demuxer for lossless joining when formats are compatible
- **Format normalization**: Automatic re-encoding to H.264+AAC when videos have incompatible codecs
- **Codec detection**: Uses ffprobe to detect video/audio codecs before joining
- **Quality preservation**: Direct stream copy when possible, medium preset for re-encoding
- **Error handling**: VideoJoinError exception with Spanish error messages

### Extended TempManager (`bot/temp_manager.py`)
- **File tracking**: `track_file()` and `get_tracked_files()` for session management
- **Subdirectory support**: `get_subdir()` for organizing multi-file operations
- **Backward compatible**: All existing functionality preserved

### Telegram Commands
- **`/join`**: Start a video join session
- **`/done`**: Complete and join all collected videos
- **`/cancel`**: Cancel session and cleanup files
- **Video messages**: During active session, videos are collected instead of processed

### Session Management
- **5-minute timeout**: Sessions expire after 5 minutes of inactivity
- **Video limits**: Minimum 2, maximum 10 videos per join operation
- **Order preservation**: Videos concatenated in the order they were sent
- **Automatic cleanup**: Temp files cleaned on completion, error, or cancellation

---

## Files Created/Modified

### Created
- `bot/join_processor.py` - VideoJoiner class with concat/normalization logic

### Modified
- `bot/error_handler.py` - Added VideoJoinError exception and error message
- `bot/temp_manager.py` - Added file tracking and subdirectory support
- `bot/handlers.py` - Added join session handlers (handle_join_start, handle_join_video, handle_join_done, handle_join_cancel)
- `bot/main.py` - Registered /join, /done, /cancel command handlers

---

## Decisions Made

### D01.1-03-01: Use ffmpeg concat demuxer for quality preservation
**Context**: Two approaches for joining videos: concat filter (re-encodes everything) vs concat demuxer (lossless when compatible).

**Decision**: Use concat demuxer with automatic normalization only when needed.

**Rationale**: Preserves quality for compatible videos while handling format mismatches gracefully.

### D01.1-03-02: H.264 + AAC as normalization target
**Context**: When videos have incompatible codecs, they must be re-encoded to a common format.

**Decision**: Normalize to H.264 video codec and AAC audio codec in MP4 container.

**Rationale**: Maximum compatibility across devices and platforms, well-supported by ffmpeg.

### D01.1-03-03: Double timeout for join operations
**Context**: Joining multiple videos takes longer than single video processing.

**Decision**: Use 120-second timeout for join operations vs 60 seconds for standard processing.

**Rationale**: Normalization requires re-encoding which is CPU-intensive and time-consuming.

### D01.1-03-04: Session-based collection with /done trigger
**Context**: Need to collect multiple videos before processing.

**Decision**: Use context.user_data for session storage with explicit /done command.

**Rationale**: Telegram doesn't support multi-file selection; session pattern allows ordered collection.

---

## Deviations from Plan

None - plan executed exactly as written.

---

## Technical Details

### ffmpeg Concat Command
```bash
ffmpeg -f concat -safe 0 -i filelist.txt -c copy -movflags +faststart output.mp4
```

### Normalization Command (when needed)
```bash
ffmpeg -i input.mp4 -c:v libx264 -preset medium -crf 23 -c:a aac -b:a 128k -movflags +faststart -pix_fmt yuv420p output.mp4
```

### Session Data Structure
```python
context.user_data["join_session"] = {
    "videos": ["/path/to/video1.mp4", "/path/to/video2.mp4"],
    "temp_mgr": TempManager(),
    "last_activity": 1234567890.0,  # timestamp
}
```

---

## Verification Steps

1. [ ] Use `/join`, send 3 videos, use `/done` - receive single joined video
2. [ ] Verify videos are concatenated in sent order
3. [ ] Test with videos of different formats - verify normalization works
4. [ ] Test session timeout - verify cleanup after 5 minutes
5. [ ] Test `/cancel` - verify session cleared and files cleaned up

---

## Next Phase Readiness

Phase 1.1 is now **COMPLETE**. All three plans implemented:
- 01.1-01: Format Conversion and Audio Extraction ✓
- 01.1-02: Video Splitting ✓
- 01.1-03: Video Joining ✓

Ready for Phase 2: Deployment

---

## Metrics

- **Duration**: ~30 minutes
- **Files created**: 1
- **Files modified**: 4
- **Commits**: 3
- **Lines added**: ~700

---

## Dependencies

**Requires**:
- ffmpeg (for concat demuxer)
- ffprobe (for codec detection)
- Existing bot infrastructure (config, logging, error handling)

**Used by**:
- Telegram bot users via /join command

---

*Completed: 2026-02-13*
