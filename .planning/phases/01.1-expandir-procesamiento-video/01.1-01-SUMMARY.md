---
phase: 01.1-expandir-procesamiento-video
plan: 01
subsystem: video-processing
tags: [ffmpeg, format-conversion, audio-extraction, telegram-bot]

dependency_graph:
  requires: [01-03]
  provides: [format-conversion, audio-extraction]
  affects: [01.1-02]

tech_stack:
  added: []
  patterns:
    - "FormatConverter class with codec mapping per format"
    - "AudioExtractor class with format-specific audio configurations"
    - "Telegram command handlers with reply-to-video support"
    - "TempManager context manager for automatic cleanup"

file_tracking:
  key_files:
    created:
      - bot/format_processor.py
    modified:
      - bot/handlers.py
      - bot/error_handler.py
      - bot/main.py

decisions:
  - id: D01.1-01-01
    text: "Use format-specific codec selection (libx264 for most, libvpx-vp9 for webm)"
    rationale: "Optimal quality and compatibility for each container format"
  - id: D01.1-01-02
    text: "Support both direct video messages and reply-to-video patterns"
    rationale: "Flexibility for user interaction - can use command with attached video or reply"
  - id: D01.1-01-03
    text: "Default to mp3 for audio extraction when no format specified"
    rationale: "MP3 is most widely compatible format for audio playback"
  - id: D01.1-01-04
    text: "Use -movflags +faststart for all video conversions"
    rationale: "Enables web playback optimization for Telegram web client"

metrics:
  duration: 201s
  completed: 2026-02-13
---

# Phase 1.1 Plan 01: Format Conversion and Audio Extraction Summary

**One-liner:** FormatConverter and AudioExtractor classes with /convert and /extract_audio Telegram commands supporting 5 video formats and 4 audio formats.

## What Was Built

### FormatConverter Class (`bot/format_processor.py`)
Video format conversion supporting MP4, AVI, MOV, MKV, and WEBM outputs:
- Format-specific video codec selection (libx264 for most, libvpx-vp9 for webm)
- Format-specific audio codec selection (aac for most, libopus for webm)
- Web optimization with faststart flag
- Static `_check_ffmpeg()` method following VideoProcessor patterns
- `get_supported_formats()` returns list of supported extensions
- Returns True/False for success/failure with comprehensive logging

### AudioExtractor Class (`bot/format_processor.py`)
Audio extraction from videos supporting MP3, AAC, WAV, and OGG outputs:
- Format-specific codec and bitrate configuration:
  - MP3: libmp3lame at 192k
  - AAC: aac at 128k
  - WAV: pcm_s16le (lossless)
  - OGG: libvorbis at 128k
- `-vn` flag for video exclusion
- Metadata preservation where possible
- Same patterns as VideoProcessor for consistency

### Telegram Command Handlers (`bot/handlers.py`)
Two new command handlers with full error handling:

**`/convert <formato>`**
- Accepts format argument (mp4, avi, mov, mkv, webm)
- Works with direct video attachment or reply-to-video
- Validates format before processing
- Sends converted video via `reply_video()`
- Spanish error messages for invalid formats

**`/extract_audio <formato>`**
- Accepts optional format argument (defaults to mp3)
- Works with direct video attachment or reply-to-video
- Sends extracted audio via `reply_audio()`
- Validates format before processing

Both handlers use:
- TempManager context manager for automatic cleanup
- PROCESSING_TIMEOUT (60s) protection against hangs
- Processing messages that are deleted on success
- Comprehensive error handling via handle_processing_error

### Error Handling Extensions (`bot/error_handler.py`)
Added custom exceptions:
- `FormatConversionError` - "Error convirtiendo el formato del video"
- `AudioExtractionError` - "Error extrayendo el audio del video"

Both added to ERROR_MESSAGES dictionary with Spanish user-friendly messages.

### Main Registration (`bot/main.py`)
Registered new handlers:
- `CommandHandler("convert", handle_convert_command)`
- `CommandHandler("extract_audio", handle_extract_audio_command)`

Updated start() message with command documentation.

## Verification Steps

1. **Format Conversion:** Send video with `/convert mov` - receive video in MOV format
2. **Audio Extraction:** Send video with `/extract_audio mp3` - receive audio file
3. **Error Messages:** Invalid format returns Spanish error message
4. **Temp Cleanup:** All temp files cleaned up after processing (via TempManager)

## Code Patterns Used

- **VideoProcessor patterns:** `_check_ffmpeg()`, Path validation, subprocess.run with capture_output
- **Handler patterns:** TempManager context manager, PROCESSING_TIMEOUT, processing messages
- **Error handling:** Custom exceptions, handle_processing_error, Spanish user messages
- **Command patterns:** context.args parsing, reply-to-message support

## Files Modified

| File | Changes |
|------|---------|
| `bot/format_processor.py` | Created with FormatConverter and AudioExtractor classes (257 lines) |
| `bot/handlers.py` | Added handle_convert_command, handle_extract_audio_command, _get_video_from_message helper, updated start() message (+272 lines) |
| `bot/error_handler.py` | Added FormatConversionError, AudioExtractionError exceptions and error messages |
| `bot/main.py` | Registered convert and extract_audio command handlers |

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

Ready for Phase 1.1 Plan 02 (video splitting/joining functionality). The format_processor module provides a foundation for additional video processing features.

## Commits

- `95d21f7`: feat(01.1-01): create FormatConverter and AudioExtractor classes
- `0a4906b`: feat(01.1-01): add Telegram command handlers for format conversion and audio extraction
