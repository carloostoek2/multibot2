---
phase: 01.1-expandir-procesamiento-video
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/format_processor.py
  - bot/handlers.py
  - bot/error_handler.py
autonomous: true

must_haves:
  truths:
    - "User can send a video and receive it converted to a different format (MP4, AVI, MOV, MKV)"
    - "User can extract audio from a video and receive it as an audio file (MP3, AAC, WAV)"
    - "Format conversion preserves video quality appropriately"
    - "Audio extraction produces valid audio files playable in Telegram"
  artifacts:
    - path: "bot/format_processor.py"
      provides: "FormatConverter and AudioExtractor classes"
      exports: ["FormatConverter", "AudioExtractor"]
    - path: "bot/handlers.py"
      provides: "Command handlers for /convert and /extract_audio"
  key_links:
    - from: "bot/handlers.py"
      to: "bot/format_processor.py"
      via: "import and call converter/extractor methods"
    - from: "bot/format_processor.py"
      to: "bot/error_handler.py"
      via: "raise FormatConversionError, AudioExtractionError"
---

<objective>
Implement format conversion and audio extraction functionality.

Purpose: Expand bot capabilities to handle common video processing needs - converting between video formats and extracting audio tracks.
Output: FormatConverter and AudioExtractor classes with Telegram command handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/video_processor.py
@bot/handlers.py
@bot/error_handler.py
@bot/temp_manager.py

# Existing patterns from video_processor.py:
- Uses ffmpeg via subprocess.run
- Static methods for one-shot processing
- Returns bool for success/failure
- Comprehensive logging
- Error handling with specific exceptions

# Existing patterns from handlers.py:
- Async handlers with Update/ContextTypes
- TempManager context manager for cleanup
- Processing timeout protection
- Spanish user messages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FormatConverter class</name>
  <files>bot/format_processor.py</files>
  <action>
    Create bot/format_processor.py with FormatConverter class:

    1. FormatConverter class with methods:
       - __init__(self, input_path: str, output_path: str)
       - convert(self, output_format: str) -> bool - Convert video to specified format
       - get_supported_formats() -> list[str] - Return supported output formats

    2. Supported formats: mp4, avi, mov, mkv, webm

    3. ffmpeg command structure:
       - Input: -i {input_path}
       - Video codec: copy if same format family, else libx264
       - Audio codec: copy if possible, else aac
       - Faststart flag for web playback

    4. Follow VideoProcessor patterns:
       - _check_ffmpeg() static method
       - Path validation
       - Proper logging
       - subprocess.run with capture_output
       - Return True/False for success

    5. Add custom exception FormatConversionError to error_handler.py
  </action>
  <verify>
    - File exists: bot/format_processor.py
    - Class FormatConverter exists with required methods
    - ffmpeg command generation works for each format
  </verify>
  <done>
    FormatConverter class created with convert() method supporting MP4, AVI, MOV, MKV, WEBM outputs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AudioExtractor class</name>
  <files>bot/format_processor.py</files>
  <action>
    Add AudioExtractor class to bot/format_processor.py:

    1. AudioExtractor class with methods:
       - __init__(self, input_path: str, output_path: str)
       - extract(self, output_format: str = "mp3") -> bool - Extract audio track
       - get_supported_formats() -> list[str] - Return supported audio formats

    2. Supported formats: mp3, aac, wav, ogg

    3. ffmpeg command structure for audio extraction:
       - Input: -i {input_path}
       -vn flag (no video)
       - Audio codec based on format:
         * mp3: libmp3lame, 192k bitrate
         * aac: aac, 128k bitrate
         * wav: pcm_s16le
         * ogg: libvorbis
       - Metadata preservation if possible

    4. Follow same patterns as VideoProcessor:
       - Static _check_ffmpeg()
       - Path validation
       - subprocess.run with proper error handling
       - Comprehensive logging

    5. Add custom exception AudioExtractionError to error_handler.py
  </action>
  <verify>
    - AudioExtractor class exists with extract() method
    - Supports mp3, aac, wav, ogg outputs
    - ffmpeg audio extraction commands are correct
  </verify>
  <done>
    AudioExtractor class created supporting MP3, AAC, WAV, OGG extraction
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Telegram command handlers</name>
  <files>bot/handlers.py, bot/main.py</files>
  <action>
    Update handlers.py and main.py to expose new functionality:

    1. In handlers.py, add:
       - handle_convert_command(update, context) - Handle /convert command
         * Reply to video messages with format selection
         * Parse format from command args or prompt user
       - handle_extract_audio_command(update, context) - Handle /extract_audio command
         * Reply to video with audio format selection
         * Default to mp3 if no format specified

    2. Command patterns:
       - /convert mp4 (when replying to video)
       - /extract_audio mp3 (when replying to video)

    3. Use existing patterns:
       - TempManager for file handling
       - PROCESSING_TIMEOUT for protection
       - Spanish user messages
       - Error handling via handle_processing_error

    4. In main.py, register new handlers:
       - CommandHandler("convert", handle_convert_command)
       - CommandHandler("extract_audio", handle_extract_audio_command)

    5. Add usage instructions to start() message
  </action>
  <verify>
    - /convert command registered and functional
    - /extract_audio command registered and functional
    - Commands work when replying to video messages
    - User receives converted file or extracted audio
  </verify>
  <done>
    Telegram commands /convert and /extract_audio working with proper error handling
  </done>
</task>

</tasks>

<verification>
1. Send a video to bot with /convert mov - receive video in MOV format
2. Send a video to bot with /extract_audio mp3 - receive audio file
3. Verify error messages in Spanish for invalid formats
4. Check temp files are cleaned up after processing
</verification>

<success_criteria>
- FormatConverter supports MP4, AVI, MOV, MKV, WEBM conversions
- AudioExtractor supports MP3, AAC, WAV, OGG extraction
- Telegram commands work when replying to videos
- Processing timeout protects against hangs
- User-friendly Spanish error messages
- All temp files cleaned up automatically
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-expandir-procesamiento-video/01.1-01-SUMMARY.md`
</output>
