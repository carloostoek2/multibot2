# Phase 01.1 Plan 02: Video Splitting Implementation Summary

**One-liner:** Implemented video splitting functionality with VideoSplitter class and /split command supporting duration-based and parts-based segmentation.

---

## Completed Tasks

### Task 1: Create VideoSplitter class
**Commit:** `8602f14`

Created `bot/split_processor.py` with VideoSplitter class:
- `split_by_duration(segment_duration)` - Split video into N-second segments using ffmpeg segment muxer
- `split_by_parts(num_parts)` - Split video into N equal parts by calculating duration per part
- `get_video_duration()` - Get video duration using ffprobe
- Added `VideoSplitError` exception to `bot/error_handler.py`
- Followed existing patterns: `_check_ffmpeg()`, `_check_ffprobe()`, subprocess error handling
- Comprehensive logging and Spanish error messages

### Task 2: Add /split command handler
**Commit:** `e2aad80`

Updated handlers and main:
- Added `handle_split_command()` in `bot/handlers.py`
- Command patterns:
  - `/split duration 30` - Split into 30-second segments
  - `/split parts 5` - Split into 5 equal parts
  - `/split` alone - Default 60-second segments
- Constraints enforced: max 10 segments, min 5 seconds per segment
- Progress messages during segment sending ("Enviando parte X de Y...")
- Segments sent with captions showing part number
- Spanish error messages for all error cases
- Registered handler in `bot/main.py`
- Updated `/start` command help text

---

## Key Design Decisions

### D01.1-02-01: Use ffmpeg segment muxer for splitting
**Decision:** Use ffmpeg's `-f segment` muxer with `-c copy` for fast splitting without re-encoding.

**Rationale:**
- Much faster than re-encoding (stream copy vs transcode)
- Preserves original quality
- Handles timestamp reset automatically with `-reset_timestamps 1`
- Simple pattern-based output naming

### D01.1-02-02: Calculate expected segments before splitting
**Decision:** For duration mode, calculate expected segments from video duration before calling ffmpeg.

**Rationale:**
- Prevents creating too many segments (spam protection)
- Provides clear user feedback before processing
- Avoids unnecessary ffmpeg execution

### D01.1-02-03: Send segments as separate video messages
**Decision:** Send each segment as a separate video message with caption indicating part number.

**Rationale:**
- Telegram doesn't support sending multiple videos in one message easily
- Users can save individual parts they need
- Clear progress indication through multiple messages

---

## Files Modified

| File | Changes |
|------|---------|
| `bot/split_processor.py` | Created - VideoSplitter class with split_by_duration, split_by_parts, get_video_duration |
| `bot/error_handler.py` | Added VideoSplitError exception and error message |
| `bot/handlers.py` | Added handle_split_command, imports, constants (MAX_SEGMENTS, MIN_SEGMENT_DURATION) |
| `bot/main.py` | Registered /split command handler, updated imports |

---

## API/Interface

### VideoSplitter Class

```python
class VideoSplitter:
    def __init__(self, input_path: str, output_dir: str)
    def split_by_duration(self, segment_duration: int) -> list[str]
    def split_by_parts(self, num_parts: int) -> list[str]
    def get_video_duration(self) -> float
```

### Telegram Commands

| Command | Description |
|---------|-------------|
| `/split duration N` | Split into N-second segments |
| `/split parts N` | Split into N equal parts |
| `/split` | Split into 60-second segments (default) |

---

## Verification Steps

1. Send a 2-minute video with `/split duration 30` → receive 4 segments
2. Send a 5-minute video with `/split parts 5` → receive 5 equal segments
3. Try `/split duration 5` on long video → error message about too many segments
4. Check temp files cleaned up after operation

---

## Success Criteria Status

| Criterion | Status |
|-----------|--------|
| VideoSplitter splits by duration correctly | ✅ Implemented |
| VideoSplitter splits by number of parts correctly | ✅ Implemented |
| Maximum 10 segments per operation enforced | ✅ Implemented |
| Minimum 5 seconds per segment enforced | ✅ Implemented |
| All segments sent as separate video files | ✅ Implemented |
| Progress messages inform user during sending | ✅ Implemented |
| Spanish error messages for all error cases | ✅ Implemented |
| Temp files cleaned up automatically | ✅ Implemented (via TempManager) |

---

## Deviations from Plan

None - plan executed exactly as written.

---

## Next Phase Readiness

This plan is complete. The video splitting functionality is ready for:
- Phase 01.1-03: Video merging (joining multiple videos)

No blockers identified.

---

## Metrics

- **Duration:** ~4 minutes
- **Tasks completed:** 2/2
- **Commits:** 2
- **Files created:** 1
- **Files modified:** 3
- **Lines added:** ~400

---

## Technical Notes

### ffmpeg segment command used:
```bash
ffmpeg -i input.mp4 -c copy -map 0 -segment_time {duration} \
       -f segment -reset_timestamps 1 output_part%03d.mp4
```

### ffprobe duration command:
```bash
ffprobe -v error -show_entries format=duration -of csv=p=0 input.mp4
```

### Key constants:
- `MAX_SEGMENTS = 10` - Maximum segments per operation
- `MIN_SEGMENT_DURATION = 5` - Minimum seconds per segment
- `DEFAULT_SEGMENT_DURATION = 60` - Default when no args provided
- `PROCESSING_TIMEOUT = 60` - Timeout for splitting operations
