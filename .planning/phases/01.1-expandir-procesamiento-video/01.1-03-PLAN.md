---
phase: 01.1-expandir-procesamiento-video
plan: 03
type: execute
wave: 2
depends_on: ["01.1-01"]
files_modified:
  - bot/join_processor.py
  - bot/handlers.py
  - bot/error_handler.py
  - bot/temp_manager.py
autonomous: true

must_haves:
  truths:
    - "User can select multiple videos and receive them joined into a single video"
    - "Joined video maintains consistent format and codec across all parts"
    - "Videos are concatenated in the order they were selected/sent"
    - "User receives the final joined video file"
  artifacts:
    - path: "bot/join_processor.py"
      provides: "VideoJoiner class"
      exports: ["VideoJoiner"]
    - path: "bot/handlers.py"
      provides: "Command handler for /join and video collection flow"
    - path: "bot/temp_manager.py"
      provides: "Extended for multi-file session management"
  key_links:
    - from: "bot/handlers.py"
      to: "bot/join_processor.py"
      via: "import and call VideoJoiner.join_videos"
    - from: "bot/join_processor.py"
      to: "bot/error_handler.py"
      via: "raise VideoJoinError"
    - from: "bot/join_processor.py"
      to: "bot/temp_manager.py"
      via: "TempManager for intermediate file list"
---

<objective>
Implement video joining/concatenation functionality to merge multiple videos.

Purpose: Allow users to combine multiple video files into a single continuous video.
Output: VideoJoiner class with Telegram command handler and video collection flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/video_processor.py
@bot/handlers.py
@bot/error_handler.py
@bot/temp_manager.py
@bot/format_processor.py

# Dependencies on Plan 01.1-01:
- Format conversion capability for normalizing video formats before join
- Similar ffmpeg command construction patterns

# Existing patterns:
- ffmpeg via subprocess with proper error handling
- TempManager for automatic cleanup
- Async handlers with timeout protection
- Spanish user messages
- Custom exceptions in error_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoJoiner class</name>
  <files>bot/join_processor.py</files>
  <action>
    Create bot/join_processor.py with VideoJoiner class:

    1. VideoJoiner class with methods:
       - __init__(self, output_path: str)
       - add_video(self, video_path: str) -> None - Add video to the join list
       - join_videos(self) -> bool - Concatenate all added videos
       - _create_concat_file(self) -> str - Create ffmpeg concat demuxer file list
       - _normalize_videos(self) -> list[str] - Convert videos to compatible format if needed

    2. Implementation details:
       - Store list of input video paths
       - Use ffmpeg concat demuxer (not concat filter) for quality preservation
       - Concat file format: file '/path/to/video1.mp4'\nfile '/path/to/video2.mp4'

    3. ffmpeg concat command:
       ffmpeg -f concat -safe 0 -i filelist.txt -c copy output.mp4

    4. Format normalization (when videos have different codecs):
       - Detect incompatible formats using ffprobe
       - Re-encode to common format (H.264 + AAC) before concat
       - Use libx264 with medium preset for re-encoding

    5. Follow existing patterns:
       - _check_ffmpeg() static method
       - Path validation for all inputs
       - subprocess.run with error handling
       - Comprehensive logging
       - Return True/False for success

    6. Add custom exception VideoJoinError to error_handler.py
  </action>
  <verify>
    - File exists: bot/join_processor.py
    - VideoJoiner class exists with add_video and join_videos methods
    - Concat demuxer file list generation works correctly
    - Format normalization handles codec mismatches
  </verify>
  <done>
    VideoJoiner class created supporting concat demuxer and format normalization
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend TempManager for multi-file sessions</name>
  <files>bot/temp_manager.py</files>
  <action>
    Extend TempManager to support multi-file collection scenarios:

    1. Add session tracking capabilities:
       - track_file(self, file_path: str) -> None - Track a file for cleanup
       - get_tracked_files(self) -> list[str] - Get all tracked files
       - clear_tracked_files(self) -> None - Clear tracking list (without deleting)

    2. Add subdirectory support:
       - get_subdir(self, subdir_name: str) -> str - Create and return subdirectory path
       - Useful for organizing multiple videos in a join session

    3. Maintain backward compatibility:
       - Existing __enter__, __exit__, get_temp_path behavior unchanged
       - New methods are additive only

    4. Implementation notes:
       - tracked_files list stores paths for reference
       - Cleanup still happens via rmtree on temp_dir (no change needed)
       - Subdirectories are cleaned up with parent temp_dir
  </action>
  <verify>
    - TempManager has track_file and get_tracked_files methods
    - TempManager has get_subdir method
    - Existing TempManager usage still works
  </verify>
  <done>
    TempManager extended with file tracking and subdirectory support
  </done>
</task>

<task type="auto">
  <name>Task 3: Add /join command and video collection flow</name>
  <files>bot/handlers.py, bot/main.py</files>
  <action>
    Update handlers.py and main.py for video joining:

    1. In handlers.py, implement collection flow:
       - handle_join_start(update, context) - Start join session
         * Initialize user session in context.user_data
         * Prompt user to send videos
       - handle_join_video(update, context) - Collect videos
         * Download each video to temp directory
         * Track in user's join session
         * Show count: "Video 3 agregado. Envía más o usa /done para unir."
       - handle_join_done(update, context) - Execute join
         * Call VideoJoiner with collected videos
         * Send result
         * Clear session
       - handle_join_cancel(update, context) - Cancel session
         * Clear session data
         * Clean up temp files

    2. Command structure:
       - /join - Start a join session
       - /done - Complete and join videos (during session)
       - /cancel - Cancel join session

    3. Session storage in context.user_data:
       - user_data["join_session"] = {"videos": [], "temp_mgr": TempManager}
       - Session timeout: 5 minutes (check on each message)

    4. Constraints:
       - Minimum 2 videos to join
       - Maximum 10 videos per join operation
       - All videos must be valid video files
       - Session expires after 5 minutes of inactivity

    5. In main.py, register handlers:
       - CommandHandler("join", handle_join_start)
       - CommandHandler("done", handle_join_done)
       - CommandHandler("cancel", handle_join_cancel)
       - MessageHandler(filters.VIDEO & ~filters.COMMAND, handle_join_video) - Only during active session

    6. Error handling:
       - VideoJoinError: "No pude unir los videos"
       - Not enough videos: "Necesitas al menos 2 videos para unir"
       - Too many videos: "Máximo 10 videos permitidos"
       - Session expired: "La sesión expiró. Usa /join para comenzar de nuevo."
  </action>
  <verify>
    - /join starts a collection session
    - Videos are collected when sent during active session
    - /done joins videos and sends result
    - /cancel clears session
    - Session timeout works correctly
  </verify>
  <done>
    /join command flow working with video collection, /done execution, and session management
  </done>
</task>

</tasks>

<verification>
1. Use /join, send 3 videos, use /done - receive single joined video
2. Verify videos are concatenated in sent order
3. Test with videos of different formats - verify normalization works
4. Test session timeout - verify cleanup after 5 minutes
5. Test /cancel - verify session cleared and files cleaned up
</verification>

<success_criteria>
- VideoJoiner concatenates multiple videos correctly
- Format normalization handles codec mismatches
- Collection flow: /join -> send videos -> /done
- Minimum 2, maximum 10 videos per join operation
- Session timeout after 5 minutes of inactivity
- Videos concatenated in order they were sent
- TempManager tracks files for proper cleanup
- Spanish error messages for all error cases
- /cancel command clears session and cleans up files
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-expandir-procesamiento-video/01.1-03-SUMMARY.md`
</output>
