---
phase: 08-interfaz-usuario-menu-inline
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - bot/main.py
  - bot/handlers.py
autonomous: true

must_haves:
  truths:
    - "Los handlers de callback del menú inline están registrados en main.py"
    - "Los patrones de callback no entran en conflicto con los existentes"
    - "Los comandos existentes siguen funcionando correctamente"
    - "El bot responde a videos y audios con menús inline"
  artifacts:
    - path: "bot/main.py"
      provides: "Callback handler registrations"
      contains: ["handle_video_menu_callback", "handle_video_format_selection", "handle_audio_menu_callback", "handle_audio_menu_format_selection"]
  key_links:
    - from: "bot/main.py"
      to: "CallbackQueryHandler"
      via: "handler registration with pattern"
---

<objective>
Registrar los nuevos handlers de callback del menú inline en main.py y actualizar las importaciones, asegurando que los patrones de callback no entren en conflicto con los existentes.

Purpose: Conectar los nuevos handlers de menú inline con el sistema de routing del bot.
Output: main.py actualizado con todos los nuevos handlers registrados y handlers.py con exportaciones correctas.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@/data/data/com.termux/files/home/repos/multibot2/bot/main.py
@/data/data/com.termux/files/home/repos/multibot2/bot/handlers.py

## Existing Callback Handler Registrations (in main.py)

Current callback handlers registered:
```python
# Line 97: Format selection for audio conversion
application.add_handler(CallbackQueryHandler(handle_format_selection, pattern="^format:"))

# Line 105: Intensity selection for bass/treble boost
application.add_handler(CallbackQueryHandler(handle_intensity_selection, pattern="^(bass|treble):\\d+$"))

# Line 108: Equalizer adjustments
application.add_handler(CallbackQueryHandler(handle_equalizer_adjustment, pattern="^eq_"))

# Line 116: Effect selection for denoise/compress
application.add_handler(CallbackQueryHandler(handle_effect_selection, pattern="^(denoise|compress):"))

# Line 119: Normalize selection
application.add_handler(CallbackQueryHandler(handle_normalize_selection, pattern="^normalize:"))

# Line 125: Pipeline builder
application.add_handler(CallbackQueryHandler(handle_pipeline_builder, pattern="^pipeline_"))
```

## New Callback Patterns to Register

From plans 08-01 and 08-02:
- `video_action:<action>` - Video menu actions (videonote, extract_audio, convert, split)
- `video_format:<format>` - Video format selection (mp4, avi, mov, mkv, webm)
- `video_audio_format:<format>` - Audio extraction format selection (mp3, aac, wav, ogg)
- `audio_action:<action>` - Audio menu actions (voicenote, convert, bass_boost, etc.)
- `audio_menu_format:<format>` - Audio format selection from menu (mp3, wav, ogg, aac, flac)

## Import Pattern in main.py

Current imports (lines 28-40):
```python
from bot.handlers import (
    start, handle_video, handle_convert_command, handle_extract_audio_command,
    handle_split_command, handle_join_start, handle_join_done, handle_join_cancel,
    handle_voice_message, handle_audio_file,
    handle_split_audio_command, handle_join_audio_start, handle_join_audio_file,
    handle_join_audio_done, handle_join_audio_cancel,
    handle_convert_audio_command, handle_format_selection,
    handle_bass_boost_command, handle_treble_boost_command, handle_intensity_selection,
    handle_equalize_command, handle_equalizer_adjustment,
    handle_denoise_command, handle_compress_command, handle_effect_selection,
    handle_normalize_command, handle_normalize_selection,
    handle_effects_command, handle_pipeline_builder
)
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update imports in main.py</name>
  <files>bot/main.py</files>
  <action>
    Update the imports in bot/main.py to include the new handlers from plans 08-01 and 08-02.

    Add to the import list:
    - `handle_video_menu_callback`
    - `handle_video_format_selection`
    - `handle_audio_menu_callback`
    - `handle_audio_menu_format_selection`

    The updated import should look like:
    ```python
from bot.handlers import (
    start, handle_video, handle_convert_command, handle_extract_audio_command,
    handle_split_command, handle_join_start, handle_join_done, handle_join_cancel,
    handle_voice_message, handle_audio_file,
    handle_split_audio_command, handle_join_audio_start, handle_join_audio_file,
    handle_join_audio_done, handle_join_audio_cancel,
    handle_convert_audio_command, handle_format_selection,
    handle_bass_boost_command, handle_treble_boost_command, handle_intensity_selection,
    handle_equalize_command, handle_equalizer_adjustment,
    handle_denoise_command, handle_compress_command, handle_effect_selection,
    handle_normalize_command, handle_normalize_selection,
    handle_effects_command, handle_pipeline_builder,
    handle_video_menu_callback, handle_video_format_selection,
    handle_audio_menu_callback, handle_audio_menu_format_selection
)
    ```

    IMPORTANT: Make sure the import is on a single line or properly continued with parentheses.
  </action>
  <verify>grep -E "handle_video_menu_callback|handle_video_format_selection|handle_audio_menu_callback|handle_audio_menu_format_selection" /data/data/com.termux/files/home/repos/multibot2/bot/main.py</verify>
  <done>All four new handlers are imported in main.py</done>
</task>

<task type="auto">
  <name>Task 2: Register video menu callback handlers</name>
  <files>bot/main.py</files>
  <action>
    Add CallbackQueryHandler registrations for video menu callbacks in bot/main.py.

    Add after the existing callback handlers (after line 125 where pipeline_builder is registered):

    ```python
    # Video menu callback handlers
    application.add_handler(CallbackQueryHandler(handle_video_menu_callback, pattern="^video_action:"))
    application.add_handler(CallbackQueryHandler(handle_video_format_selection, pattern="^video_(format|audio_format):"))
    ```

    The pattern `^video_action:` matches callbacks like:
    - video_action:videonote
    - video_action:extract_audio
    - video_action:convert
    - video_action:split

    The pattern `^video_(format|audio_format):` matches callbacks like:
    - video_format:mp4
    - video_format:avi
    - video_audio_format:mp3
    - video_audio_format:aac

    IMPORTANT: Place these after the pipeline_builder handler but before the message handlers.
    The order matters - more specific patterns should come before general ones if there's overlap.
  </action>
  <verify>grep -n "handle_video_menu_callback\|handle_video_format_selection" /data/data/com.termux/files/home/repos/multibot2/bot/main.py</verify>
  <done>Video menu callback handlers are registered with proper patterns</done>
</task>

<task type="auto">
  <name>Task 3: Register audio menu callback handlers</name>
  <files>bot/main.py</files>
  <action>
    Add CallbackQueryHandler registrations for audio menu callbacks in bot/main.py.

    Add after the video menu callback handlers:

    ```python
    # Audio menu callback handlers
    application.add_handler(CallbackQueryHandler(handle_audio_menu_callback, pattern="^audio_action:"))
    application.add_handler(CallbackQueryHandler(handle_audio_menu_format_selection, pattern="^audio_menu_format:"))
    ```

    The pattern `^audio_action:` matches callbacks like:
    - audio_action:voicenote
    - audio_action:convert
    - audio_action:bass_boost
    - audio_action:treble_boost
    - audio_action:equalize
    - audio_action:denoise
    - audio_action:compress
    - audio_action:normalize
    - audio_action:effects

    The pattern `^audio_menu_format:` matches callbacks like:
    - audio_menu_format:mp3
    - audio_menu_format:wav
    - audio_menu_format:ogg
    - audio_menu_format:aac
    - audio_menu_format:flac

    IMPORTANT: This pattern `^audio_menu_format:` is distinct from the existing `^format:` pattern used by handle_format_selection, so there's no conflict.
  </action>
  <verify>grep -n "handle_audio_menu_callback\|handle_audio_menu_format_selection" /data/data/com.termux/files/home/repos/multibot2/bot/main.py</verify>
  <done>Audio menu callback handlers are registered with proper patterns</done>
</task>

<task type="auto">
  <name>Task 4: Verify callback pattern uniqueness</name>
  <files>bot/main.py</files>
  <action>
    Verify that all callback patterns in main.py are unique and don't conflict:

    Current patterns:
    - `^format:` - Audio format selection (existing)
    - `^(bass|treble):\d+$` - Intensity selection (existing)
    - `^eq_` - Equalizer adjustments (existing)
    - `^(denoise|compress):` - Effect selection (existing)
    - `^normalize:` - Normalize selection (existing)
    - `^pipeline_` - Pipeline builder (existing)
    - `^video_action:` - Video menu actions (new)
    - `^video_(format|audio_format):` - Video format selection (new)
    - `^audio_action:` - Audio menu actions (new)
    - `^audio_menu_format:` - Audio format from menu (new)

    Check for conflicts:
    1. `^format:` vs `^audio_menu_format:` - NO CONFLICT (different prefixes)
    2. `^video_format:` vs `^format:` - NO CONFLICT (different prefixes)
    3. `^audio_action:` vs other patterns - NO CONFLICT (unique prefix)
    4. `^video_action:` vs other patterns - NO CONFLICT (unique prefix)

    Document in a comment that patterns are ordered by specificity.

    Add a comment block before the callback handlers:
    ```python
    # Callback handlers - ordered by pattern specificity
    # More specific patterns should be registered before general ones
    ```
  </action>
  <verify>grep -E "CallbackQueryHandler.*pattern" /data/data/com.termux/files/home/repos/multibot2/bot/main.py | wc -l</verify>
  <done>All 10 callback patterns are registered without conflicts</done>
</task>

<task type="auto">
  <name>Task 5: Update help text in start command</name>
  <files>bot/handlers.py</files>
  <action>
    Update the help text in the `start` function (around line 246) to mention the new inline menu functionality.

    Current help text mentions commands only. Add a note about the inline menus:

    ```python
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Send a welcome message when the command /start is issued."""
    await update.message.reply_text(
        "¡Hola! Envíame un video o audio y te mostraré opciones de procesamiento.\n\n"
        "También puedes usar comandos:\n"
        "Video:\n"
        "/convert <formato> - Convierte video a otro formato\n"
        "/extract_audio <formato> - Extrae audio del video\n"
        "/split [duration|parts] <valor> - Divide video en segmentos\n"
        "/join - Une múltiples videos\n\n"
        "Audio:\n"
        "/split_audio - Divide audio en segmentos\n"
        "/join_audio - Une múltiples audios\n"
        "/convert_audio - Convierte formato de audio\n"
        "/bass_boost - Aumenta bajos\n"
        "/treble_boost - Aumenta agudos\n"
        "/equalize - Ecualizador 3 bandas\n"
        "/denoise - Reduce ruido\n"
        "/compress - Comprime rango dinámico\n"
        "/normalize - Normaliza volumen\n"
        "/effects - Pipeline de efectos"
    )
    ```

    The key change is adding the first line about sending video/audio to see processing options.
  </action>
  <verify>grep -A 5 "¡Hola!" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | head -10</verify>
  <done>Help text updated to mention inline menu functionality</done>
</task>

</tasks>

<verification>
After implementation:
1. Start the bot and verify it loads without errors
2. Send a video - should show inline menu
3. Click each menu option and verify it works
4. Send an audio file - should show inline menu
5. Click each menu option and verify it works
6. Test existing commands to ensure they still work
7. Check logs for any callback pattern conflicts
</verification>

<success_criteria>
- All new handlers are imported in main.py
- All callback patterns are registered with correct regex patterns
- No pattern conflicts between new and existing handlers
- Video uploads show inline menu and all options work
- Audio uploads show inline menu and all options work
- Existing commands continue to work
- Bot starts without import or registration errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-interfaz-usuario-menu-inline/08-03-SUMMARY.md`
</output>
