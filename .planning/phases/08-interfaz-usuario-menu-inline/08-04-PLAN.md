---
phase: 08-interfaz-usuario-menu-inline
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - bot/handlers.py
autonomous: true

gap_closure: true

must_haves:
  truths:
    - "Todos los menús inline de múltiples pasos tienen botones de Cancelar y Volver"
    - "Al cancelar, se limpia el estado del usuario y se muestra mensaje de confirmación"
    - "Al volver, se regresa al menú anterior correcto según el contexto"
    - "La navegación funciona consistentemente en todos los flujos de video y audio"
  artifacts:
    - path: "bot/handlers.py"
      provides: "Navigation handlers and updated keyboards with cancel/back buttons"
      contains: ["handle_cancel_callback", "handle_back_callback", "cancel_menu_keyboard_row", "back_menu_keyboard_row"]
  key_links:
    - from: "inline keyboards"
      to: "handle_cancel_callback"
      via: "callback_data=cancel"
    - from: "submenu keyboards"
      to: "handle_back_callback"
      via: "callback_data=back:<menu_type>"
---

<objective>
Agregar navegación (Cancelar/Volver) a todos los menús inline de múltiples pasos para que el usuario pueda salir del flujo o regresar al menú anterior en cualquier momento.

Purpose: Permitir al usuario cancelar operaciones en progreso o regresar si se equivocó de opción, mejorando la UX del bot.
Output: Handlers de navegación y teclados actualizados con botones de Cancelar y Volver.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@/data/data/com.termux/files/home/repos/multibot2/bot/handlers.py

## Current Inline Keyboards (without navigation)

1. **Video menus:**
   - `_get_video_menu_keyboard` - Menú principal (4 opciones)
   - `_get_video_format_keyboard` - Selección de formato de video
   - `_get_video_audio_format_keyboard` - Selección de formato de audio

2. **Audio menus:**
   - `_get_audio_menu_keyboard` - Menú principal (9 opciones)
   - Format selection keyboard (format:*) - Para /convert_audio
   - Intensity keyboards (bass:*, treble:*) - Para bass/treble boost
   - `_get_equalizer_keyboard` - Ecualizador 3 bandas
   - Denoise strength keyboard (denoise:*)
   - Compress preset keyboard (compress:*)
   - Normalize preset keyboard (normalize:*)
   - `_get_pipeline_keyboard` - Pipeline builder (ya tiene cancelar)

## Context Keys to Clean on Cancel

Video menu context keys:
- `video_menu_file_id`
- `video_menu_correlation_id`
- `video_menu_action`

Audio menu context keys:
- `audio_menu_file_id`
- `audio_menu_correlation_id`
- `audio_menu_action`
- `convert_audio_file_id`
- `convert_audio_correlation_id`
- `enhance_audio_file_id`, `enhance_type`
- `eq_file_id`, `eq_bass`, `eq_mid`, `eq_treble`
- `effect_audio_file_id`, `effect_type`
- `pipeline_file_id`, `pipeline_effects`

## Navigation Patterns

Cancel button callback: `cancel` (universal)
Back button callback: `back:video` or `back:audio` (context-specific)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cancel and back callback handlers</name>
  <files>bot/handlers.py</files>
  <action>
    Create two new async callback handlers for navigation:

    1. `handle_cancel_callback(update, context)` - Handles cancel action
       - Edit message to show "Operación cancelada."
       - Clean up ALL context.user_data keys related to ongoing operations
       - Clear video menu keys: video_menu_file_id, video_menu_correlation_id, video_menu_action
       - Clear audio menu keys: audio_menu_file_id, audio_menu_correlation_id, audio_menu_action
       - Clear convert keys: convert_audio_file_id, convert_audio_correlation_id
       - Clear enhance keys: enhance_audio_file_id, enhance_audio_correlation_id, enhance_type
       - Clear EQ keys: eq_file_id, eq_correlation_id, eq_bass, eq_mid, eq_treble
       - Clear effect keys: effect_audio_file_id, effect_audio_correlation_id, effect_type
       - Clear pipeline keys: pipeline_file_id, pipeline_correlation_id, pipeline_effects
       - Always call `await query.answer()` first

    2. `handle_back_callback(update, context)` - Handles back navigation
       - Parse callback data: `back:video` or `back:audio`
       - For `back:video`: Re-show video menu with stored file_id
       - For `back:audio`: Re-show audio menu with stored file_id
       - Check if file_id still exists in context, if not show error

    Place these handlers after the existing callback handlers (after handle_pipeline_builder).
  </action>
  <verify>grep -n "async def handle_cancel_callback\|async def handle_back_callback" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py</verify>
  <done>Both handle_cancel_callback and handle_back_callback functions exist with proper implementation</done>
</task>

<task type="auto">
  <name>Task 2: Update video format keyboard with Cancel/Back</name>
  <files>bot/handlers.py</files>
  <action>
    Modify `_get_video_format_keyboard()` to add Cancel and Back buttons.

    Current keyboard (lines 2573-2586):
    ```python
    def _get_video_format_keyboard() -> InlineKeyboardMarkup:
        keyboard = [
            [MP4, AVI, MOV],
            [MKV, WEBM],
        ]
    ```

    Updated keyboard:
    ```python
    def _get_video_format_keyboard() -> InlineKeyboardMarkup:
        keyboard = [
            [MP4, AVI, MOV],
            [MKV, WEBM],
            [
                InlineKeyboardButton("← Volver", callback_data="back:video"),
                InlineKeyboardButton("❌ Cancelar", callback_data="cancel"),
            ],
        ]
    ```
  </action>
  <verify>grep -A 15 "def _get_video_format_keyboard" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Volver|Cancelar|back:video|cancel"</verify>
  <done>_get_video_format_keyboard includes Cancel and Back buttons</done>
</task>

<task type="auto">
  <name>Task 3: Update video audio format keyboard with Cancel/Back</name>
  <files>bot/handlers.py</files>
  <action>
    Modify `_get_video_audio_format_keyboard()` to add Cancel and Back buttons.

    Add row at the end:
    ```python
    [
        InlineKeyboardButton("← Volver", callback_data="back:video"),
        InlineKeyboardButton("❌ Cancelar", callback_data="cancel"),
    ],
    ```
  </action>
  <verify>grep -A 15 "def _get_video_audio_format_keyboard" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Volver|Cancelar"</verify>
  <done>_get_video_audio_format_keyboard includes Cancel and Back buttons</done>
</task>

<task type="auto">
  <name>Task 4: Update audio format keyboard with Cancel</name>
  <files>bot/handlers.py</files>
  <action>
    Modify the format selection keyboard in `handle_convert_audio_command` (around line 2071) to add Cancel button.

    Current keyboard:
    ```python
    keyboard = [
        [MP3, WAV, OGG],
        [AAC, FLAC],
    ]
    ```

    Updated:
    ```python
    keyboard = [
        [MP3, WAV, OGG],
        [AAC, FLAC],
        [InlineKeyboardButton("❌ Cancelar", callback_data="cancel")],
    ]
    ```

    IMPORTANT: The existing handle_format_selection already uses `format:*` pattern. We need to add the cancel handler registration BEFORE it in main.py.
  </action>
  <verify>grep -A 15 "async def handle_convert_audio_command" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Cancelar|cancel"</verify>
  <done>Audio format selection keyboard includes Cancel button</done>
</task>

<task type="auto">
  <name>Task 5: Update intensity keyboards with Cancel</name>
  <files>bot/handlers.py</files>
  <action>
    Add Cancel button to bass/treble intensity keyboards.

    In `handle_bass_boost_command` (around line 2280-2300), add cancel button row:
    ```python
    keyboard = [
        [1, 2, 3, 4, 5],
        [6, 7, 8, 9, 10],
        [InlineKeyboardButton("❌ Cancelar", callback_data="cancel")],
    ]
    ```

    Do the same for `handle_treble_boost_command`.
  </action>
  <verify>grep -A 20 "Selecciona la intensidad" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Cancelar|cancel"</verify>
  <done>Intensity keyboards include Cancel button</done>
</task>

<task type="auto">
  <name>Task 6: Update equalizer keyboard with Cancel</name>
  <files>bot/handlers.py</files>
  <action>
    Modify `_get_equalizer_keyboard` to add Cancel button alongside Reset and Apply.

    Current row:
    ```python
    [
        InlineKeyboardButton("Reset", callback_data="eq_reset_all"),
        InlineKeyboardButton("Aplicar", callback_data="eq_apply"),
    ],
    ```

    Updated:
    ```python
    [
        InlineKeyboardButton("Reset", callback_data="eq_reset_all"),
        InlineKeyboardButton("Aplicar", callback_data="eq_apply"),
        InlineKeyboardButton("❌ Cancelar", callback_data="cancel"),
    ],
    ```
  </action>
  <verify>grep -A 5 "Reset.*Aplicar" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Cancelar|cancel"</verify>
  <done>Equalizer keyboard includes Cancel button</done>
</task>

<task type="auto">
  <name>Task 7: Update denoise keyboard with Cancel</name>
  <files>bot/handlers.py</files>
  <action>
    Add Cancel button to denoise strength keyboard in `handle_denoise_command`.

    Add row at end of keyboard:
    ```python
    [InlineKeyboardButton("❌ Cancelar", callback_data="cancel")],
    ```
  </action>
  <verify>grep -A 25 "handle_denoise_command" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Cancelar|cancel" | head -5</verify>
  <done>Denoise keyboard includes Cancel button</done>
</task>

<task type="auto">
  <name>Task 8: Update compress keyboard with Cancel</name>
  <files>bot/handlers.py</files>
  <action>
    Add Cancel button to compress preset keyboard in `handle_compress_command`.

    Add row at end of keyboard:
    ```python
    [InlineKeyboardButton("❌ Cancelar", callback_data="cancel")],
    ```
  </action>
  <verify>grep -A 20 "handle_compress_command" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Cancelar|cancel" | head -5</verify>
  <done>Compress keyboard includes Cancel button</done>
</task>

<task type="auto">
  <name>Task 9: Update normalize keyboard with Cancel</name>
  <files>bot/handlers.py</files>
  <action>
    Add Cancel button to normalize preset keyboard in `handle_normalize_command`.

    Add row at end of keyboard:
    ```python
    [InlineKeyboardButton("❌ Cancelar", callback_data="cancel")],
    ```
  </action>
  <verify>grep -A 20 "handle_normalize_command" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -E "Cancelar|cancel" | head -5</verify>
  <done>Normalize keyboard includes Cancel button</done>
</task>

<task type="auto">
  <name>Task 10: Update audio menu format selection with Cancel/Back</name>
  <files>bot/handlers.py</files>
  <action>
    Find the audio_menu_format keyboard (used when user selects "Convertir Formato" from audio menu) and add Cancel and Back buttons.

    This should be in `handle_audio_menu_callback` around line 3618 where it creates the format keyboard for `audio_menu_format:*`.

    Add row:
    ```python
    [
        InlineKeyboardButton("← Volver", callback_data="back:audio"),
        InlineKeyboardButton("❌ Cancelar", callback_data="cancel"),
    ],
    ```
  </action>
  <verify>grep -A 30 "handle_audio_menu_callback" /data/data/com.termux/files/home/repos/multibot2/bot/handlers.py | grep -B5 -A5 "audio_menu_format" | head -20</verify>
  <done>Audio menu format keyboard includes Cancel and Back buttons</done>
</task>

<task type="auto">
  <name>Task 11: Register cancel and back handlers in main.py</name>
  <files>bot/main.py</files>
  <action>
    Add imports and registrations for the new handlers.

    1. Add to imports in main.py:
    ```python
    handle_cancel_callback, handle_back_callback,
    ```

    2. Add handler registrations BEFORE other callback handlers (order matters - specific before general):
    ```python
    # Navigation handlers - must be first to catch cancel/back before other patterns
    application.add_handler(CallbackQueryHandler(handle_cancel_callback, pattern="^cancel$"))
    application.add_handler(CallbackQueryHandler(handle_back_callback, pattern="^back:"))
    ```

    Place these before the format: pattern handler.
  </action>
  <verify>grep -n "handle_cancel_callback\|handle_back_callback" /data/data/com.termux/files/home/repos/multibot2/bot/main.py</verify>
  <done>Cancel and back handlers are imported and registered in main.py</done>
</task>

</tasks>

<verification>
After implementation:
1. Send a video, click "Convertir Formato" - should see Cancel and Back buttons
2. Click Cancel - should show "Operación cancelada" and clean context
3. Send another video, click "Extraer Audio", click Back - should return to video menu
4. Test audio menus similarly
5. Test /convert_audio and cancel - should clean context
6. Verify existing functionality still works
</verification>

<success_criteria>
- All submenu keyboards have Cancel button
- Video format/audio format keyboards have Back button to return to video menu
- Audio format keyboards have Back button to return to audio menu
- Cancel cleans all relevant context.user_data keys
- Back re-shows the appropriate parent menu
- Navigation handlers registered before other handlers in main.py
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-interfaz-usuario-menu-inline/08-04-SUMMARY.md`
</output>
