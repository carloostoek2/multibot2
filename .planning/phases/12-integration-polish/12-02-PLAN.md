---
phase: 12-integration-polish
plan: 02
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - bot/handlers.py
  - bot/downloaders/download_session.py
autonomous: true

must_haves:
  truths:
    - "Downloaded videos can be converted to video notes via inline menu"
    - "Downloaded audio can be processed with audio tools via inline menu"
    - "Download + Convert flow works end-to-end"
    - "Recent downloads list shows last 5 items (ephemeral, per session)"
  artifacts:
    - path: bot/handlers.py
      provides: "Post-download integration handlers"
      contains: "handle_postdownload_menu, handle_convert_to_videonote"
    - path: bot/downloaders/download_session.py
      provides: "Ephemeral download session storage"
      contains: "DownloadSession class with recent downloads"
  key_links:
    - from: bot/handlers.py
      to: bot/downloaders/download_session.py
      via: "context.user_data storage"
      pattern: "download_session"
---

<objective>
Implement post-download integration with existing video/audio processing tools and ephemeral recent downloads list.

Purpose: Allow users to seamlessly process downloaded content with existing tools (video notes, audio effects) and view recent downloads per session.
Output: Post-download inline menus, integration handlers, and session-based download tracking.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@bot/handlers.py
@bot/video_processor.py
@bot/audio_processor.py

## Phase Context

Existing processing tools from v1.0 and v2.0:
- VideoProcessor.process_video() - converts to circular video note
- AudioFormatConverter - converts between audio formats
- AudioEnhancer - bass/treble boost, equalizer
- AudioEffects - denoise, compress, normalize
- VoiceNoteConverter - converts audio to voice note

Existing menu patterns:
- `_get_video_menu_keyboard()` - Nota de Video, Extraer Audio, Convertir Formato, Dividir Video
- `_get_audio_menu_keyboard()` - Nota de Voz, Convertir Formato, Bass Boost, etc.
- Post-action menus allow further processing

Requirements to implement:
- INT-01: Downloaded videos can be processed to video notes
- INT-02: Downloaded audio can be processed with audio tools
- INT-03: Inline menu offers "Download + Convert" flow
- INT-04: Download history not persisted (privacy)
- UI-06: Recent downloads list (last 5, ephemeral)

Dependencies:
- 12-01 must be complete (download handlers and format selection)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DownloadSession for ephemeral tracking</name>
  <files>bot/downloaders/download_session.py</files>
  <action>
Create new file bot/downloaders/download_session.py for ephemeral download tracking:

1. `DownloadSession` class:
   - Stores downloads per user session (not persisted)
   - Max 5 recent downloads (UI-06 requirement)
   - FIFO eviction when limit exceeded
   - Stores: correlation_id, url, file_path, metadata, timestamp, status

2. Class structure:
   ```python
   @dataclass
   class DownloadEntry:
       correlation_id: str
       url: str
       file_path: str
       metadata: Dict[str, Any]
       timestamp: datetime
       status: str  # completed, failed, cancelled

   class DownloadSession:
       MAX_RECENT = 5

       def __init__(self):
           self._downloads: Dict[str, DownloadEntry] = {}
           self._order: List[str] = []  # correlation_ids in order

       def add(self, entry: DownloadEntry) -> None:
           # Add new, remove oldest if > MAX_RECENT

       def get_recent(self, n: int = 5) -> List[DownloadEntry]:
           # Return last n downloads

       def get(self, correlation_id: str) -> Optional[DownloadEntry]:
           # Get specific download

       def clear(self) -> None:
           # Clear all (optional, for privacy)
   ```

3. Integration with handlers:
   - Store session in context.user_data["download_session"]
   - Initialize on first use
   - Add entry when download completes
   - No persistence (INT-04 requirement)

4. Export from bot/downloaders/__init__.py:
   - Add DownloadSession, DownloadEntry to exports

5. Add helper function:
   ```python
   def get_user_download_session(context) -> DownloadSession:
       if "download_session" not in context.user_data:
           context.user_data["download_session"] = DownloadSession()
       return context.user_data["download_session"]
   ```
  </action>
  <verify>
    python -c "from bot.downloaders.download_session import DownloadSession, DownloadEntry; print('Import OK')"
  </verify>
  <done>
    DownloadSession class exists with MAX_RECENT=5, FIFO eviction, no persistence. Can add/get/clear entries. Exported from downloaders package.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement post-download video processing menu</name>
  <files>bot/handlers.py</files>
  <action>
Add post-download video processing to bot/handlers.py:

1. `_get_postdownload_video_keyboard(correlation_id)` - Menu for downloaded videos:
   - "Convertir a Nota de Video" (callback: `postdownload:videonote:{correlation_id}`)
   - "Extraer Audio" (callback: `postdownload:extract_audio:{correlation_id}`)
   - "Convertir Formato" (callback: `postdownload:convert_video:{correlation_id}`)
   - "Descargas Recientes" (callback: `postdownload:recent:{correlation_id}`)
   - "Cerrar" (callback: `cancel`)

2. `handle_postdownload_callback()` - Handle post-download actions:
   - Parse callback: `postdownload:action:correlation_id`
   - Retrieve download entry from DownloadSession
   - Route to appropriate handler based on action:
     * videonote: convert to video note
     * extract_audio: extract audio from video
     * convert_video: show format selection
     * recent: show recent downloads list

3. `handle_convert_to_videonote()` - Convert downloaded video to video note:
   - Get file_path from DownloadSession entry
   - Use existing VideoProcessor.process_video()
   - Show progress message
   - Send as video_note
   - Offer post-processing menu again

4. `handle_extract_audio_from_video()` - Extract audio from downloaded video:
   - Use existing AudioExtractor
   - Show format selection (MP3, AAC, WAV, OGG)
   - Process and send audio file

5. Integration with download completion:
   - After successful download, show post-download menu instead of just sending file
   - Store download in DownloadSession
   - Send file with caption + inline menu

6. Error handling:
   - If file no longer exists (cleaned up), show error
   - If processing fails, show error with retry option
   - All messages in Spanish

Reuse existing processing logic from handle_video_menu_callback where possible.
  </action>
  <verify>
    grep -n "postdownload\|_get_postdownload_video_keyboard\|handle_convert_to_videonote" bot/handlers.py | head -20
  </verify>
  <done>
    Post-download video menu exists with videonote, extract_audio, convert options. Handlers route to existing processing tools. Menu shown after successful download.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement post-download audio processing menu</name>
  <files>bot/handlers.py</files>
  <action>
Add post-download audio processing to bot/handlers.py:

1. `_get_postdownload_audio_keyboard(correlation_id)` - Menu for downloaded audio:
   - "Convertir a Nota de Voz" (callback: `postdownload:voicenote:{correlation_id}`)
   - "Convertir Formato" (callback: `postdownload:convert_audio:{correlation_id}`)
   - "Bass Boost" (callback: `postdownload:bass:{correlation_id}`)
   - "Reducir Ruido" (callback: `postdownload:denoise:{correlation_id}`)
   - "MÃ¡s Opciones..." (callback: `postdownload:more:{correlation_id}`)
   - "Descargas Recientes" (callback: `postdownload:recent:{correlation_id}`)
   - "Cerrar" (callback: `cancel`)

2. Extended menu `_get_postdownload_audio_more_keyboard()`:
   - "Treble Boost", "Ecualizar", "Comprimir", "Normalizar"
   - Back button to main audio menu

3. `handle_postdownload_audio_callback()` - Handle audio-specific actions:
   - voicenote: convert to voice note using VoiceNoteConverter
   - convert_audio: show format selection (reuse existing)
   - bass: show intensity selection (1-10)
   - denoise: show strength selection
   - more: show extended menu
   - treble/compress/normalize/equalize: route to respective handlers

4. Reuse existing processing functions:
   - Import and call existing handler logic
   - Adapt to work with downloaded file path instead of Telegram file_id
   - Pass correlation_id for tracking

5. `handle_recent_downloads()` - Show recent downloads list:
   - Get DownloadSession from context
   - Format list: "1. {title} ({platform}) - {time ago}"
   - Each item has "Reprocesar" button
   - Show "Limpiar Lista" option
   - Max 5 items as per UI-06

6. `handle_reprocess_download()` - Reprocess a recent download:
   - Get entry from DownloadSession
   - Check if file still exists
   - Show appropriate post-download menu based on file type
   - If file cleaned up, show error

7. Integration with download completion:
   - Detect file type from extension
   - Show video menu for video files
   - Show audio menu for audio files
   - Add to DownloadSession

File type detection:
```python
video_exts = {'.mp4', '.avi', '.mov', '.mkv', '.webm'}
audio_exts = {'.mp3', '.aac', '.wav', '.ogg', '.flac', '.m4a', '.opus'}
```
  </action>
  <verify>
    grep -n "postdownload.*audio\|handle_recent_downloads\|DownloadSession" bot/handlers.py | head -20
  </verify>
  <done>
    Post-download audio menu exists with voice note, format conversion, and effects. Recent downloads list shows last 5 items. Reprocessing works for existing files. File type detection routes to correct menu.
  </done>
</task>

<task type="auto">
  <name>Task 4: Register post-download handlers</name>
  <files>bot/main.py</files>
  <action>
Update bot/main.py to register post-download handlers:

1. Import new handlers:
   - handle_postdownload_callback
   - handle_postdownload_audio_callback
   - handle_recent_downloads
   - handle_reprocess_download

2. Add handler registrations:
   ```python
   # Post-download callbacks (must be before generic handlers)
   application.add_handler(CallbackQueryHandler(handle_postdownload_callback, pattern="^postdownload:(videonote|extract_audio|convert_video|recent):"))
   application.add_handler(CallbackQueryHandler(handle_postdownload_audio_callback, pattern="^postdownload:(voicenote|convert_audio|bass|denoise|more|treble|compress|normalize|equalize):"))
   application.add_handler(CallbackQueryHandler(handle_reprocess_download, pattern="^reprocess:"))
   ```

3. Ensure handler order is correct:
   - Specific patterns first (postdownload:action:)
   - Then more general patterns
   - Cancel/Back handlers should be early

4. No changes needed to MessageHandler order - post-download is callback-based.
  </action>
  <verify>
    grep -n "postdownload\|reprocess" bot/main.py
  </verify>
  <done>
    All post-download handlers registered with correct patterns. Handler order ensures specific callbacks match before general ones.
  </done>
</task>

</tasks>

<verification>
- After video download: menu shows with "Convertir a Nota de Video" option
- After audio download: menu shows with audio processing options
- Video note conversion works from post-download menu
- Audio effects work from post-download menu
- Recent downloads shows last 5 downloads
- Reprocessing works for files still in temp
- No download history persisted (privacy)
</verification>

<success_criteria>
1. Downloaded videos show post-download menu with video note option
2. Downloaded audio shows post-download menu with audio tools
3. Video note conversion works end-to-end
4. Audio processing works end-to-end
5. Recent downloads list shows last 5 items
6. Download history is ephemeral (not persisted)
7. Reprocessing works for recent downloads
</success_criteria>

<output>
After completion, create `.planning/phases/12-integration-polish/12-02-SUMMARY.md`
</output>
