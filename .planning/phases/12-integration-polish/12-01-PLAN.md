---
phase: 12-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "/download <url> command initiates download with progress"
    - "URL in any message triggers inline download menu"
    - "Format selection menu offers video/audio options"
    - "Large downloads (>50MB) show confirmation prompt"
    - "Cancel button is available during active download"
  artifacts:
    - path: bot/handlers.py
      provides: "Download command handler and URL message handler"
      contains: "handle_download_command, handle_url_detection"
    - path: bot/main.py
      provides: "Handler registration for /download and URL detection"
      contains: "CommandHandler, MessageHandler with URL filter"
  key_links:
    - from: bot/main.py
      to: bot/handlers.py
      via: "handler imports and registration"
      pattern: "add_handler.*download"
---

<objective>
Implement the /download command and automatic URL detection with inline menus for format selection and large download confirmation.

Purpose: Provide users with both explicit (/download) and implicit (auto-detect) ways to initiate downloads, with clear UI for format selection and safety prompts for large files.
Output: Handler functions for /download command, URL detection in messages, inline keyboards for format selection and confirmation.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/handlers.py
@bot/main.py
@bot/downloaders/download_facade.py
@bot/downloaders/url_detector.py

## Phase Context

Phase 11 completed the DownloadFacade which provides:
- `download_url()` convenience function for one-off downloads
- `DownloadFacade.download_with_progress()` with progress tracking
- Automatic retry logic and error handling
- Integration with all platform handlers

Existing handler patterns from Phase 8:
- `_get_video_menu_keyboard()` - inline menu for video actions
- `_get_audio_menu_keyboard()` - inline menu for audio actions
- Callback handlers use pattern `action:type` (e.g., `video_action:videonote`)
- Cancel/Back navigation with `cancel` and `back:type` patterns

Requirements to implement:
- UI-01: /download <url> command initiates download
- UI-02: Auto-detect URL in any message and offer download menu
- UI-03: Inline menu for format selection (video/audio) when URL detected
- UI-04: Confirmation prompt before large downloads (>50MB)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create URL detection and inline menu handlers</name>
  <files>bot/handlers.py</files>
  <action>
Add handler functions for URL-based downloads to bot/handlers.py:

1. `handle_url_detection()` - Message handler that detects URLs and shows inline menu
   - Use existing `url_detector.detect_urls()` to find URLs
   - Store URL and correlation_id in context.user_data
   - Show inline keyboard with options: Descargar Video, Descargar Audio, Cancelar
   - Callback data format: `download:format:{correlation_id}` where format is video/audio

2. `handle_download_command()` - Command handler for /download <url>
   - Parse URL from context.args
   - If no URL provided, show usage message
   - If URL provided, proceed directly to format selection menu
   - Reuse same menu logic as handle_url_detection

3. `_get_download_format_keyboard(correlation_id)` - Helper to create format selection keyboard
   - Two buttons: Descargar Video (callback: `download:video:{correlation_id}`), Descargar Audio (callback: `download:audio:{correlation_id}`)
   - Cancel button (callback: `cancel`)
   - Store URL in context.user_data["download_url_{correlation_id}"]

4. `handle_download_format_callback()` - Handle format selection
   - Parse callback data: `download:format:correlation_id`
   - Retrieve URL from context.user_data
   - Check file size via facade metadata extraction (use router to get downloader, call can_handle/get_metadata)
   - If size > 50MB, show confirmation keyboard
   - If size <= 50MB or unknown, proceed with download

5. `_get_large_download_confirmation_keyboard(correlation_id)` - Helper for confirmation
   - Show file size info and warning
   - Buttons: Confirmar Descarga, Cancelar
   - Callback: `download:confirm:{correlation_id}` or `cancel`

6. `handle_download_confirm_callback()` - Handle confirmation and start download
   - Start download via DownloadFacade
   - Add cancel button during download (callback: `download:cancel:{correlation_id}`)
   - Store facade instance in context.user_data for cancellation support

7. `handle_download_cancel_callback()` - Handle cancellation
   - Call facade.cancel_download(correlation_id)
   - Update message to show cancelled status
   - Clean up user_data

Use existing patterns from handle_video_menu_callback and handle_audio_menu_callback. Error messages in Spanish per existing convention.
  </action>
  <verify>
    grep -n "handle_download_command\|handle_url_detection\|handle_download_format_callback" bot/handlers.py | head -20
  </verify>
  <done>
    Handler functions exist for URL detection, /download command, format selection, confirmation, and cancellation. Callback patterns follow existing convention (action:type:id).
  </done>
</task>

<task type="auto">
  <name>Task 2: Register handlers in main.py</name>
  <files>bot/main.py</files>
  <action>
Update bot/main.py to register new handlers:

1. Import new handlers from bot.handlers:
   - handle_download_command
   - handle_url_detection
   - handle_download_format_callback
   - handle_download_confirm_callback
   - handle_download_cancel_callback

2. Add handler registrations (order matters - specific before general):
   - CommandHandler("download", handle_download_command) - before message handlers
   - CallbackQueryHandler for download:format: pattern
   - CallbackQueryHandler for download:confirm: pattern
   - CallbackQueryHandler for download:cancel: pattern
   - MessageHandler with TEXT filter for URL detection (after command handlers, before catch-all)

3. URL detection should use a filter that:
   - Checks if message contains URLs via url_detector
   - Does not trigger on commands (already handled)
   - Does not trigger on replies to existing downloads

4. Import url_detector in main.py or pass it to handlers via context

Handler registration order (important):
```python
# Commands first
application.add_handler(CommandHandler("download", handle_download_command))

# Download callbacks (specific patterns)
application.add_handler(CallbackQueryHandler(handle_download_format_callback, pattern="^download:(video|audio):"))
application.add_handler(CallbackQueryHandler(handle_download_confirm_callback, pattern="^download:confirm:"))
application.add_handler(CallbackQueryHandler(handle_download_cancel_callback, pattern="^download:cancel:"))

# ... existing handlers ...

# URL detection (text messages with URLs)
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_url_detection))
```
  </action>
  <verify>
    grep -n "download\|handle_url_detection" bot/main.py | head -20
  </verify>
  <done>
    All download handlers are registered in main.py with correct order. Command handler registered before message handlers. Callback handlers use correct regex patterns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement size checking and confirmation flow</name>
  <files>bot/handlers.py</files>
  <action>
Implement the large download confirmation flow in handlers:

1. In handle_download_format_callback:
   - Extract metadata before downloading using PlatformRouter
   - Get filesize_approx or filesize from metadata
   - TELEGRAM_MAX_FILE_SIZE = 50 * 1024 * 1024 bytes (already defined in base.py)
   - If size > 50MB or size unknown (be conservative):
     * Show confirmation message with size info
     * Store metadata in context.user_data["download_meta_{correlation_id}"]
   - If size <= 50MB:
     * Proceed directly to download

2. Metadata extraction pattern:
   ```python
   from bot.downloaders import PlatformRouter
   router = PlatformRouter()
   route_result = await router.route(url)
   metadata = await route_result.downloader.get_metadata(url)
   size = metadata.get('filesize') or metadata.get('filesize_approx', 0)
   ```

3. Confirmation message format (Spanish):
   ```
   El archivo es grande (~{size_mb} MB).

   Esto puede tomar tiempo y consumir datos.
   Â¿Deseas continuar?
   ```

4. Download execution with progress:
   - Use DownloadFacade for actual download
   - Create progress callback that updates the message
   - Add Cancel button during active download
   - Handle completion: send file, show post-download menu

5. Post-download menu for integration (UI-03, INT-01, INT-02):
   - For video: show menu with "Convertir a Nota de Video" option
   - For audio: show menu with audio processing options
   - Callback: `postdownload:action:{correlation_id}`

6. Error handling:
   - FileTooLargeError: Show friendly message about Telegram limits
   - URLValidationError: Invalid URL message
   - UnsupportedURLError: Platform not supported message
   - All messages in Spanish per existing convention
  </action>
  <verify>
    grep -n "filesize\|confirm\|50MB\|TELEGRAM_MAX" bot/handlers.py | head -20
  </verify>
  <done>
    Size checking implemented before download. Confirmation shown for files >50MB. Progress updates during download. Post-download menu offers conversion options. Error handling with Spanish messages.
  </done>
</task>

</tasks>

<verification>
- /download <url> command shows format selection menu
- URL in message shows inline menu with download options
- Format selection triggers size check
- Files >50MB show confirmation prompt
- Cancel button works during download
- Progress updates shown during download
- Downloaded files sent to user on completion
</verification>

<success_criteria>
1. /download command accepts URL argument and shows format menu
2. URLs in regular messages are detected and show inline menu
3. Format selection (video/audio) works correctly
4. Large downloads (>50MB) require confirmation
5. Cancel button cancels active download
6. Progress shown during download
7. Downloaded file sent to user
</success_criteria>

<output>
After completion, create `.planning/phases/12-integration-polish/12-01-SUMMARY.md`
</output>
