---
phase: 12-integration-polish
plan: 03
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "Cancel button stops active download immediately"
    - "Progress updates show percentage, size, speed, ETA"
    - "Error messages are user-friendly in Spanish"
    - "Download status is tracked throughout lifecycle"
  artifacts:
    - path: bot/handlers.py
      provides: "Cancel callback and enhanced progress handling"
      contains: "handle_download_cancel_callback, progress callback with cancel button"
    - path: bot/main.py
      provides: "Cancel handler registration"
      contains: "CallbackQueryHandler for download:cancel"
  key_links:
    - from: bot/handlers.py
      to: bot.downloaders.download_facade.DownloadFacade
      via: "facade.cancel_download()"
      pattern: "cancel_download"
---

<objective>
Implement cancel functionality during active downloads and enhance progress tracking with real-time updates.

Purpose: Give users control to cancel long-running downloads and provide clear visibility into download progress.
Output: Cancel button during downloads, enhanced progress messages, status tracking.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@bot/handlers.py
@bot/downloaders/download_facade.py
@bot/downloaders/download_manager.py
@bot/downloaders/progress_tracker.py

## Phase Context

Existing progress tracking from Phase 11:
- `ProgressTracker` class with throttled updates (3s interval, 5% change)
- `format_progress_message()` creates visual progress bars
- `format_bytes()`, `format_speed()`, `format_eta()` utilities
- Progress callback receives: percent, downloaded_bytes, total_bytes, speed, eta, status

DownloadFacade from Phase 11 provides:
- `cancel_download(correlation_id)` method
- `get_download_status(correlation_id)` for status checking
- `get_active_downloads()` for listing active downloads

Requirements to implement:
- UI-05: Cancel button during active download
- PT-01~05 already implemented in Phase 11 (progress tracking)
- This plan focuses on UI integration of cancel functionality

Dependencies:
- 12-01 must be complete (basic download handlers)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cancel button during download</name>
  <files>bot/handlers.py</files>
  <action>
Enhance download handlers to support cancellation:

1. Modify download execution to show cancel button:
   - When starting download, send message with inline keyboard
   - Keyboard has single "Cancelar Descarga" button
   - Callback: `download:cancel:{correlation_id}`
   - Store message_id for updating

2. Update progress callback to include cancel button:
   - Progress message should include cancel button
   - Use edit_message_text with reply_markup to update both text and button
   - Button remains available until download completes/fails

3. Implement `handle_download_cancel_callback()`:
   ```python
   async def handle_download_cancel_callback(update, context):
       query = update.callback_query
       await query.answer()

       # Parse correlation_id from callback_data
       parts = query.data.split(":")
       if len(parts) != 3:
           await query.edit_message_text("Error: callback inválido")
           return

       correlation_id = parts[2]

       # Get facade from context (stored during download)
       facade = context.user_data.get(f"download_facade_{correlation_id}")
       if not facade:
           await query.edit_message_text("La descarga ya no está activa")
           return

       # Cancel the download
       cancelled = await facade.cancel_download(correlation_id)

       if cancelled:
           await query.edit_message_text("Descarga cancelada")
           # Clean up user_data
           context.user_data.pop(f"download_facade_{correlation_id}", None)
           context.user_data.pop(f"download_url_{correlation_id}", None)
       else:
           await query.edit_message_text("No se pudo cancelar (¿ya completada?)")
   ```

4. Store facade reference in context.user_data:
   - Key: `download_facade_{correlation_id}`
   - Value: DownloadFacade instance
   - Clean up on completion, error, or cancel

5. Update progress message format:
   ```
   Descargando...
   [████████░░░] 75%
   15.2 MB / 20.3 MB @ 2.5 MB/s
   Tiempo restante: 2s

   [Cancelar]
   ```

6. Handle race conditions:
   - If download completes before cancel is processed, show "Descarga completada"
   - If cancel fails because download already done, show appropriate message
   - Use try/except around cancel operation
  </action>
  <verify>
    grep -n "download:cancel\|handle_download_cancel\|cancel_download" bot/handlers.py | head -20
  </verify>
  <done>
    Cancel button shown during active download. Cancel callback stops download via facade. Progress message includes cancel button. Race conditions handled gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance progress tracking with detailed updates</name>
  <files>bot/handlers.py</files>
  <action>
Enhance progress display in download handlers:

1. Create enhanced progress callback:
   ```python
   async def download_progress_callback(progress: Dict[str, Any], message, correlation_id: str):
       """Update download progress message with cancel button."""
       percent = progress.get('percent', 0)
       downloaded = progress.get('downloaded_bytes', 0)
       total = progress.get('total_bytes', 0)
       speed = progress.get('speed', 0)
       eta = progress.get('eta', 0)
       status = progress.get('status', 'downloading')

       # Format message
       if status == 'downloading':
           text = format_progress_message(progress)

           # Add cancel button
           keyboard = [[InlineKeyboardButton("Cancelar", callback_data=f"download:cancel:{correlation_id}")]]
           reply_markup = InlineKeyboardMarkup(keyboard)

           try:
               await message.edit_text(text, reply_markup=reply_markup)
           except Exception as e:
               logger.debug(f"Progress update failed: {e}")

       elif status == 'completed':
           # Remove cancel button, show completed
           try:
               await message.edit_text("Descarga completada")
           except Exception:
               pass

       elif status == 'error':
           error_msg = progress.get('error', 'Error desconocido')
           try:
               await message.edit_text(f"Error: {error_msg}")
           except Exception:
               pass
   ```

2. Integrate with DownloadFacade.download_with_progress():
   - Pass custom progress callback
   - Callback updates message with progress + cancel button
   - Use throttling to avoid rate limits

3. Handle Telegram message edit rate limits:
   - Track last edit time
   - Only edit if >1 second since last edit
   - Or use ProgressTracker's built-in throttling

4. Show platform info in progress message:
   - Extract platform from URL during initial analysis
   - Show "Descargando de YouTube..." etc.
   - Include title if available from metadata

5. Progress states:
   - "Analizando..." - Initial metadata extraction
   - "Descargando... [progress]" - Active download
   - "Procesando..." - Post-download processing (if any)
   - "Completado" - Done
   - "Cancelado" - User cancelled
   - "Error: {message}" - Failed

6. Add download speed smoothing:
   - Average speed over last few updates
   - Prevents jittery display
   - Use existing format_speed() utility
  </action>
  <verify>
    grep -n "download_progress_callback\|format_progress_message\|edit_text.*reply_markup" bot/handlers.py | head -20
  </verify>
  <done>
    Progress callback updates message with detailed info. Cancel button included in progress message. Rate limiting respected. Platform info shown. All states handled.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add download status command</name>
  <files>bot/handlers.py</files>
  <action>
Add /downloads command to show active and recent downloads:

1. `handle_downloads_command()` - Show download status:
   ```python
   async def handle_downloads_command(update, context):
       """Show active and recent downloads."""
       user_id = update.effective_user.id

       # Get active downloads from facade
       facade = context.user_data.get('active_facade')
       active = []
       if facade:
           active = facade.get_active_downloads()

       # Get recent from DownloadSession
       session = context.user_data.get('download_session')
       recent = []
       if session:
           recent = session.get_recent(5)

       # Format message
       lines = ["Descargas activas:"]
       if active:
           for d in active:
               lines.append(f"  {d['correlation_id']}: {d['progress']}%")
       else:
           lines.append("  Ninguna")

       lines.append("\nDescargas recientes:")
       if recent:
           for entry in recent:
               status_icon = "✅" if entry.status == "completed" else "❌"
               lines.append(f"  {status_icon} {entry.metadata.get('title', 'Sin título')}")
       else:
           lines.append("  Ninguna")

       await update.message.reply_text("\n".join(lines))
   ```

2. Register in main.py:
   ```python
   application.add_handler(CommandHandler("downloads", handle_downloads_command))
   ```

3. Show active download count in status:
   - Badge on /downloads command
   - Or show in start command help text

4. Allow cancelling from /downloads list:
   - Each active download has cancel button
   - Recent downloads have reprocess button

This provides visibility into download queue (UI-06 requirement).
  </action>
  <verify>
    grep -n "handle_downloads_command\|/downloads" bot/handlers.py bot/main.py
  </verify>
  <done>
    /downloads command shows active and recent downloads. Lists progress for active, status for recent. Cancel/reprocess buttons available.
  </done>
</task>

<task type="auto">
  <name>Task 4: Register cancel and downloads handlers</name>
  <files>bot/main.py</files>
  <action>
Update bot/main.py with cancel and status handlers:

1. Import new handlers:
   ```python
   from bot.handlers import (
       # ... existing imports ...
       handle_download_cancel_callback,
       handle_downloads_command,
   )
   ```

2. Add handler registrations:
   ```python
   # Download status command
   application.add_handler(CommandHandler("downloads", handle_downloads_command))

   # Cancel callback (specific pattern, register early)
   application.add_handler(CallbackQueryHandler(
       handle_download_cancel_callback,
       pattern="^download:cancel:"
   ))
   ```

3. Ensure correct handler order:
   - /downloads command before message handlers
   - download:cancel before other download callbacks
   - Pattern specificity: download:cancel: > download:video: > download:

4. Add /downloads to help text in start command:
   - Update start handler to include /downloads in command list
   - "Ver descargas activas y recientes"
  </action>
  <verify>
    grep -n "downloads\|download:cancel" bot/main.py
  </verify>
  <done>
    /downloads command and cancel callback registered. Handler order correct. Help text updated.
  </done>
</task>

</tasks>

<verification>
- Cancel button appears during active download
- Clicking cancel stops download immediately
- Progress shows percentage, size, speed, ETA
- /downloads command shows active and recent downloads
- Error messages are user-friendly in Spanish
- Download status tracked from start to finish
</verification>

<success_criteria>
1. Cancel button visible during download
2. Cancel stops download within 1-2 seconds
3. Progress updates every 3-5 seconds or 5-10%
4. Progress shows: percentage bar, downloaded/total size, speed, ETA
5. /downloads command lists active and recent downloads
6. Error states handled gracefully with Spanish messages
</success_criteria>

<output>
After completion, create `.planning/phases/12-integration-polish/12-03-SUMMARY.md`
</output>
