---
phase: 02-error-handling-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/validators.py
  - bot/handlers.py
autonomous: true

must_haves:
  truths:
    - "Video file size is validated before download to prevent excessive memory usage"
    - "Video integrity is checked with ffprobe before processing"
    - "Disk space is verified before operations that require temporary storage"
    - "Users receive clear error messages for validation failures"
  artifacts:
    - path: "bot/validators.py"
      provides: "Video validation and disk space checking functions"
      exports: ["validate_video_file", "check_disk_space", "validate_file_size", "ValidationError"]
  key_links:
    - from: "bot/handlers.py"
      to: "bot/validators.py"
      via: "import and call validation functions"
      pattern: "validate_.*\("
---

<objective>
Implement pre-processing validation to fail fast on invalid or problematic videos.

Purpose: Prevent wasted processing time, improve user experience with early error detection, avoid resource exhaustion from oversized files.
Output: validators.py module with video integrity, file size, and disk space validation; integration in handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/handlers.py
@bot/config.py
@.planning/phases/02-error-handling-configuration/02-RESEARCH.md

## Current State
No pre-processing validation exists. Videos are downloaded and processed without checking:
- File size (could be very large)
- Video integrity (could be corrupted)
- Available disk space

## Research Findings
Validation requirements:
1. File size check before download (Telegram limit: 20MB for bots)
2. Video integrity check using ffprobe (duration > 0, valid streams)
3. Disk space check before operations (require ~2x video size for processing)

Error messages should be in Spanish for user-facing communication.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validators.py module</name>
  <files>bot/validators.py</files>
  <action>
Create bot/validators.py with validation functions:

1. Imports: shutil, subprocess, os, logging, typing (Tuple, Optional)

2. Create ValidationError exception class inheriting from Exception

3. Create validate_file_size(file_size_bytes: int, max_size_mb: int) -> Tuple[bool, Optional[str]]:
   - Convert max_size_mb to bytes
   - Return (True, None) if file_size_bytes <= max_size_bytes
   - Return (False, "El archivo es demasiado grande (máximo {max_size_mb}MB)") if too large

4. Create validate_video_file(file_path: str) -> Tuple[bool, Optional[str]]:
   - Check file exists
   - Check file size > 0 (not empty)
   - Use ffprobe to validate video integrity:
     * Get video duration
     * Check duration > 0
     * Check video stream exists
   - Return (True, None) if valid
   - Return (False, "El archivo de video parece estar corrupto") if invalid
   - If ffprobe not available, log warning and return (True, None) - don't fail

5. Create check_disk_space(required_mb: int, path: str = "/") -> Tuple[bool, Optional[str]]:
   - Use os.statvfs to get available space
   - Return (True, None) if available >= required_mb
   - Return (False, "Espacio insuficiente en disco") if not enough space
   - On exception, log warning and return (True, None) - don't fail if we can't check

6. Create estimate_required_space(video_file_size_mb: int) -> int:
   - Return estimated space needed (2x file size for processing + 100MB buffer)

All functions should log debug/info messages about what they're checking.
  </action>
  <verify>python -c "from bot.validators import validate_video_file, check_disk_space, ValidationError; print('Validators module loads correctly')"</verify>
  <done>validators.py exists with all validation functions, imports work correctly</done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation in video handlers</name>
  <files>bot/handlers.py</files>
  <action>
Add pre-processing validation to handlers.py:

1. Add imports from bot.validators:
   - validate_file_size
   - validate_video_file
   - check_disk_space
   - estimate_required_space
   - ValidationError

2. In handle_video(), before downloading:
   - Get video.file_size from Telegram
   - Call validate_file_size(video.file_size, config.MAX_FILE_SIZE_MB)
   - If fails, send error message to user and return early
   - Log the validation failure

3. In handle_video(), after downloading but before processing:
   - Call validate_video_file(input_path)
   - If fails, send error message and return early
   - Call check_disk_space with estimated required space
   - If fails, send error message and return early

4. Apply same validation pattern to:
   - handle_convert_command
   - handle_extract_audio_command
   - handle_split_command
   - handle_join_video (for each video added)

5. For handle_join_video, validate each video as it's added to the session

Error messages to user should be in Spanish and come from the validation functions.
  </action>
  <verify>grep -n "validate_file_size\|validate_video_file\|check_disk_space" bot/handlers.py | head -10</verify>
  <done>All handlers have validation integrated, validation functions are called before processing</done>
</task>

<task type="auto">
  <name>Task 3: Add validation error handling</name>
  <files>bot/error_handler.py</files>
  <action>
Add ValidationError to error handling:

1. Import ValidationError in error_handler.py

2. Add ValidationError to ERROR_MESSAGES dict with Spanish message:
   ValidationError: "El archivo no es válido. Verifica que sea un video correcto."

3. Ensure handle_processing_error catches ValidationError and sends appropriate user message

4. Update wrap_with_error_handler decorator to handle ValidationError

This ensures validation failures result in user-friendly error messages.
  </action>
  <verify>grep -n "ValidationError" bot/error_handler.py</verify>
  <done>ValidationError is imported, has error message mapping, and is handled by error handlers</done>
</task>

</tasks>

<verification>
1. Validators module loads: python -c "from bot.validators import *"
2. Validation functions work: python -c "from bot.validators import validate_file_size; print(validate_file_size(10*1024*1024, 20))"
3. Handlers import correctly: python -c "from bot.handlers import handle_video"
4. Error handler has ValidationError: grep "ValidationError" bot/error_handler.py
</verification>

<success_criteria>
- validators.py exists with validate_file_size, validate_video_file, check_disk_space functions
- ValidationError exception class exists
- Handlers validate file size before download
- Handlers validate video integrity after download
- Handlers check disk space before processing
- Validation failures result in clear Spanish error messages to users
- Bot continues to work normally for valid videos
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling-configuration/02-02-SUMMARY.md`
</output>
