---
phase: 02-error-handling-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/config.py
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Bot configuration is fully customizable via environment variables"
    - "Invalid configuration values are caught at startup with clear error messages"
    - "All hardcoded constants in handlers are replaced with config values"
  artifacts:
    - path: "bot/config.py"
      provides: "BotConfig dataclass with all settings"
      exports: ["config", "BotConfig"]
    - path: ".env.example"
      provides: "Documentation of all configuration options"
  key_links:
    - from: "bot/handlers.py"
      to: "bot/config.py"
      via: "import config"
      pattern: "config\.[A-Z_]+"
---

<objective>
Enhance bot configuration to support all operational parameters via environment variables.

Purpose: Enable flexible deployment and tuning without code changes, validate configuration at startup for fail-fast behavior.
Output: Complete BotConfig dataclass with validation, .env.example documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/config.py
@bot/handlers.py

## Current State
The config.py only has BOT_TOKEN. Handlers.py has hardcoded constants:
- PROCESSING_TIMEOUT = 60
- JOIN_SESSION_TIMEOUT = 300
- MAX_SEGMENTS = 10
- MIN_SEGMENT_DURATION = 5
- JOIN_MIN_VIDEOS = 2
- JOIN_MAX_VIDEOS = 10

## Research Findings (from 02-RESEARCH.md)
Configuration should include:
- Timeouts: PROCESSING_TIMEOUT, DOWNLOAD_TIMEOUT, JOIN_TIMEOUT, JOIN_SESSION_TIMEOUT
- Limits: MAX_FILE_SIZE_MB, MAX_SEGMENTS, MIN_SEGMENT_SECONDS, JOIN_MAX_VIDEOS, JOIN_MIN_VIDEOS
- Logging: LOG_LEVEL
- Paths: TEMP_DIR (optional)

Use dataclass with __post_init__ validation. Fail fast on invalid config.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BotConfig dataclass with validation</name>
  <files>bot/config.py</files>
  <action>
Replace the existing config.py with a complete BotConfig dataclass:

1. Import required modules: os, sys, dataclasses (dataclass, field), typing (Optional)
2. Keep python-dotenv loading at top
3. Create @dataclass(frozen=True) class BotConfig with fields:
   - BOT_TOKEN: str (required)
   - PROCESSING_TIMEOUT: int = 60
   - DOWNLOAD_TIMEOUT: int = 60
   - JOIN_TIMEOUT: int = 120
   - JOIN_SESSION_TIMEOUT: int = 300
   - MAX_FILE_SIZE_MB: int = 20
   - MAX_SEGMENTS: int = 10
   - MIN_SEGMENT_SECONDS: int = 5
   - JOIN_MAX_VIDEOS: int = 10
   - JOIN_MIN_VIDEOS: int = 2
   - LOG_LEVEL: str = "INFO"
   - TEMP_DIR: Optional[str] = None

4. Implement __post_init__ validation:
   - Validate BOT_TOKEN is not empty
   - Validate all timeout fields are positive integers (> 0)
   - Validate all limit fields are positive integers
   - Validate JOIN_MIN_VIDEOS < JOIN_MAX_VIDEOS
   - Validate LOG_LEVEL is one of: DEBUG, INFO, WARNING, ERROR, CRITICAL
   - Raise ValueError with descriptive message if any validation fails

5. Create load_config() function that:
   - Reads all values from os.getenv with defaults
   - Converts string env vars to int where needed
   - Returns BotConfig instance

6. Create global config instance: config = load_config()

7. Export: config, BotConfig, load_config

Validation error messages should be in English (internal) and clearly indicate which config value is invalid and why.
  </action>
  <verify>python -c "from bot.config import config, BotConfig; print('Config loads:', config.BOT_TOKEN is not None); print('Timeouts:', config.PROCESSING_TIMEOUT, config.DOWNLOAD_TIMEOUT, config.JOIN_TIMEOUT)"</verify>
  <done>BotConfig dataclass exists with all fields, validation works, config loads without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create .env.example documentation</name>
  <files>.env.example</files>
  <action>
Create .env.example file documenting all configuration options:

```
# Video Note Bot Configuration
# Copy this file to .env and fill in your values

# Required
BOT_TOKEN=your_bot_token_here

# Timeouts (seconds)
PROCESSING_TIMEOUT_SECONDS=60
DOWNLOAD_TIMEOUT_SECONDS=60
JOIN_TIMEOUT_SECONDS=120
JOIN_SESSION_TIMEOUT_SECONDS=300

# Limits
MAX_FILE_SIZE_MB=20
MAX_SEGMENTS=10
MIN_SEGMENT_SECONDS=5
JOIN_MAX_VIDEOS=10
JOIN_MIN_VIDEOS=2

# Logging
LOG_LEVEL=INFO
# Options: DEBUG, INFO, WARNING, ERROR, CRITICAL

# Optional Paths
# TEMP_DIR=/tmp
```

Include comments explaining each section and what the values control.
  </action>
  <verify>cat .env.example | grep -c "BOT_TOKEN"</verify>
  <done>.env.example exists with all configuration options documented</done>
</task>

<task type="auto">
  <name>Task 3: Update handlers.py to use config values</name>
  <files>bot/handlers.py</files>
  <action>
Replace hardcoded constants in handlers.py with config imports:

1. Add import: from bot.config import config

2. Replace PROCESSING_TIMEOUT constant with config.PROCESSING_TIMEOUT

3. Replace JOIN_SESSION_TIMEOUT constant with config.JOIN_SESSION_TIMEOUT

4. Replace MAX_SEGMENTS constant with config.MAX_SEGMENTS

5. Replace MIN_SEGMENT_DURATION constant with config.MIN_SEGMENT_SECONDS

6. Replace JOIN_MIN_VIDEOS constant with config.JOIN_MIN_VIDEOS

7. Replace JOIN_MAX_VIDEOS constant with config.JOIN_MAX_VIDEOS

8. In handle_join_done, use config.JOIN_TIMEOUT for the join operation timeout (currently hardcoded as PROCESSING_TIMEOUT * 2)

9. Remove the old constant definitions that are now redundant

Ensure all references are updated correctly - search for each constant name to find all usages.
  </action>
  <verify>grep -n "config\." bot/handlers.py | head -20</verify>
  <done>All hardcoded constants replaced with config references, no old constant definitions remain</done>
</task>

</tasks>

<verification>
1. Config loads successfully: python -c "from bot.config import config; print(config)"
2. Validation works: unset BOT_TOKEN and verify it raises ValueError
3. Handlers import correctly: python -c "from bot.handlers import handle_video"
4. No hardcoded constants remain: grep -n "PROCESSING_TIMEOUT =" bot/handlers.py should return nothing
</verification>

<success_criteria>
- BotConfig dataclass exists with all required fields
- Configuration validation catches invalid values at startup
- All operational parameters are configurable via environment variables
- .env.example documents all options
- Handlers use config values instead of hardcoded constants
- Bot starts successfully with valid configuration
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling-configuration/02-01-SUMMARY.md`
</output>
