---
phase: 01-core-video-processing
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - bot/main.py
  - bot/handlers.py
  - bot/error_handler.py
  - README.md
autonomous: false

must_haves:
  truths:
    - "Bot maneja errores gracefulmente sin crashear"
    - "Usuario recibe mensaje claro cuando algo falla"
    - "Archivos temporales se limpian incluso en caso de error"
    - "Timeout evita bloqueos en videos problemáticos"
    - "Bot puede ejecutarse con instrucciones claras"
  artifacts:
    - path: "bot/error_handler.py"
      provides: "Manejo centralizado de errores"
      min_lines: 30
      exports: ["error_handler", "VideoProcessingError"]
    - path: "bot/handlers.py"
      provides: "Handlers con manejo de errores robusto"
      min_lines: 60
    - path: "README.md"
      provides: "Instrucciones de uso"
      min_lines: 40
  key_links:
    - from: "bot/main.py"
      to: "bot/error_handler.py"
      via: "registro de error_handler"
    - from: "bot/handlers.py"
      to: "bot/error_handler.py"
      via: "try/except con errores personalizados"
---

<objective>
Agregar manejo de errores robusto, logging y documentación para completar el MVP funcional.

Purpose: Asegurar que el bot sea confiable y usable en producción, con feedback claro al usuario.
Output: Bot completo con manejo de errores, logging y documentación de uso.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-video-processing/01-01-SUMMARY.md
@.planning/phases/01-core-video-processing/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implementar manejo de errores centralizado</name>
  <files>bot/error_handler.py</files>
  <action>
Crear `bot/error_handler.py` con:

1. Excepciones personalizadas:
   - VideoProcessingError: Error general de procesamiento
   - DownloadError: Error descargando video
   - FFmpegError: Error en ffmpeg
   - TimeoutError: Timeout en procesamiento

2. Función error_handler(update, context):
   - Detectar tipo de error
   - Enviar mensaje amigable al usuario según el error:
     * DownloadError: "No pude descargar el video. Intenta con otro archivo."
     * FFmpegError: "Hubo un problema procesando el video. Asegúrate de que sea un archivo válido."
     * TimeoutError: "El video tardó demasiado en procesarse. Intenta con uno más corto."
     * Otros: "Ocurrió un error inesperado. Por favor intenta de nuevo."
   - Loggear error completo para debugging

3. Función wrap_with_error_handler(func) como decorator

IMPORTANTE: Mensajes de error en español, amigables para el usuario final.
  </action>
  <verify>
python -c "from bot.error_handler import VideoProcessingError, error_handler; print('Error handler OK')"
  </verify>
  <done>Excepciones personalizadas y handler de errores implementados</done>
</task>

<task type="auto">
  <name>Task 2: Agregar logging y timeout a handlers</name>
  <files>bot/handlers.py, bot/main.py</files>
  <action>
Actualizar `bot/handlers.py`:

1. Agregar logging:
   - import logging
   - logger = logging.getLogger(__name__)
   - Loggear inicio de procesamiento
   - Loggear éxito o error

2. Agregar timeout con asyncio.wait_for:
   - Envolver procesamiento en asyncio.wait_for(timeout=60)
   - Convertir asyncio.TimeoutError a TimeoutError personalizado

3. Try/except completo:
   - try: descargar -> procesar -> enviar
   - except Exception as e: llamar error_handler
   - finally: asegurar cleanup de temporales

4. Mensaje de "procesando" al usuario mientras trabaja

Actualizar `bot/main.py`:
- Configurar logging básico en main()
- Agregar error handler global al Application
  </action>
  <verify>
python -c "import logging; logging.basicConfig(); from bot.handlers import handle_video; print('Handlers with logging OK')"
  </verify>
  <done>Logging configurado, timeout implementado, cleanup garantizado</done>
</task>

<task type="auto">
  <name>Task 3: Crear README con instrucciones</name>
  <files>README.md</files>
  <action>
Crear `README.md` con:

1. Título y descripción del bot
2. Requisitos:
   - Python 3.9+
   - ffmpeg instalado
   - Token de bot de Telegram (@BotFather)
3. Instalación:
   - git clone
   - python -m venv venv
   - source venv/bin/activate
   - pip install -r requirements.txt
4. Configuración:
   - cp .env.example .env
   - Editar .env con BOT_TOKEN
5. Ejecución:
   - python run.py
6. Uso:
   - Enviar /start
   - Enviar cualquier video
   - Recibir video note circular
7. Limitaciones:
   - Max 60 segundos
   - Procesamiento síncrono

IMPORTANTE: Instrucciones claras paso a paso, incluso para usuarios no técnicos.
  </action>
  <verify>
head -20 README.md | grep -q "Video Note Bot" && echo "README OK"
  </verify>
  <done>README.md con instrucciones completas de instalación y uso</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Bot de Telegram completo con:
- Estructura de proyecto organizada
- Procesamiento de videos con ffmpeg
- Manejo de errores robusto
- Logging de operaciones
- Documentación completa</what-built>
  <how-to-verify>
1. Configurar BOT_TOKEN en .env
2. Ejecutar: python run.py
3. Enviar /start al bot - debe responder
4. Enviar un video corto (< 10 segundos) - debe procesar y devolver video note
5. Verificar que el video note es circular y se reproduce
6. Probar con video muy largo (> 60s) - debe truncar o rechazar
7. Verificar que no quedan archivos en /tmp después del procesamiento
  </how-to-verify>
  <resume-signal>Type "approved" si todo funciona, o describe los problemas encontrados</resume-signal>
</task>

</tasks>

<verification>
- [ ] Error handler captura y reporta errores gracefulmente
- [ ] Logging registra operaciones del bot
- [ ] Timeout de 60 segundos en procesamiento
- [ ] Cleanup de temporales en finally block
- [ ] README tiene instrucciones claras
- [ ] Bot puede iniciarse sin errores de import
</verification>

<success_criteria>
1. Errores se manejan sin crashear el bot
2. Usuario recibe mensajes claros en español
3. Logging registra todas las operaciones
4. Timeout evita bloqueos indefinidos
5. Archivos temporales siempre se limpian
6. README permite a cualquiera usar el bot
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-video-processing/01-03-SUMMARY.md`
</output>
