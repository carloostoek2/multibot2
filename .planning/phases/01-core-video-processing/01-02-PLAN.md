---
phase: 01-core-video-processing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/video_processor.py
  - bot/temp_manager.py
  - bot/handlers.py
autonomous: true

must_haves:
  truths:
    - "Videos se descargan correctamente desde Telegram"
    - "Videos se procesan con ffmpeg a formato 1:1"
    - "Archivos temporales se gestionan apropiadamente"
    - "Video de salida cumple especificaciones de video notes"
  artifacts:
    - path: "bot/temp_manager.py"
      provides: "Gestión de archivos temporales"
      min_lines: 30
      exports: ["TempManager"]
    - path: "bot/video_processor.py"
      provides: "Procesamiento de video con ffmpeg"
      min_lines: 50
      exports: ["VideoProcessor", "process_video"]
    - path: "bot/handlers.py"
      provides: "Handlers de Telegram"
      min_lines: 40
      exports: ["handle_video"]
  key_links:
    - from: "bot/handlers.py"
      to: "bot/video_processor.py"
      via: "import y llamada a process_video"
    - from: "bot/handlers.py"
      to: "bot/temp_manager.py"
      via: "uso de TempManager para archivos temporales"
    - from: "bot/video_processor.py"
      to: "bot/temp_manager.py"
      via: "uso de directorios temporales"
---

<objective>
Implementar el procesamiento de videos con ffmpeg: descarga, conversión a formato 1:1, y envío como video note.

Purpose: Core functionality del bot - convertir videos recibidos a notas de video circulares.
Output: Videos procesados correctamente con formato circular 1:1, max 640x640, max 60s.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-core-video-processing/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Crear gestor de archivos temporales</name>
  <files>bot/temp_manager.py</files>
  <action>
Crear `bot/temp_manager.py` con clase TempManager:

1. __init__(): Crear directorio temporal único por sesión (tempfile.mkdtemp)
2. get_temp_path(filename): Retornar ruta completa dentro del temp dir
3. cleanup(): Eliminar todo el directorio temporal y su contenido
4. Context manager support (__enter__, __exit__) para auto-cleanup

El directorio temporal debe estar en /tmp o equivalente del sistema.
Asegurar que cleanup() no falle si archivos están bloqueados.

IMPORTANTE: Siempre usar paths absolutos. No hardcodear rutas.
  </action>
  <verify>
python -c "from bot.temp_manager import TempManager; import tempfile; t = TempManager(); print(t.temp_dir); t.cleanup()"
  </verify>
  <done>TempManager crea, gestiona y limpia archivos temporales correctamente</done>
</task>

<task type="auto">
  <name>Task 2: Implementar procesador de video con ffmpeg</name>
  <files>bot/video_processor.py</files>
  <action>
Crear `bot/video_processor.py` con:

1. Clase VideoProcessor con métodos:
   - __init__(input_path, output_path)
   - process(): Ejecutar ffmpeg y retornar éxito/fracaso

2. Comando ffmpeg debe:
   - Recortar a formato 1:1 (square) centrado: crop=ih:ih (altura como ancho, centrado)
   - Escalar a max 640x640: scale=640:640:force_original_aspect_ratio=decrease
   - Limitar duración a 60 segundos: -t 60
   - Mantener calidad razonable: -crf 23, preset medium
   - Formato de salida MP4 compatible con Telegram

3. Método estático process_video(input_path, output_path) como shortcut

4. Manejo de errores: Capturar subprocess.CalledProcessError, retornar False

5. Verificar que ffmpeg esté instalado antes de procesar (shutil.which)

IMPORTANTE: El video note de Telegram requiere formato cuadrado 1:1.
El recorte debe ser centrado (crop=ih:ih centrado en el video original).
  </action>
  <verify>
python -c "from bot.video_processor import VideoProcessor; print('VideoProcessor OK')"
  </verify>
  <done>VideoProcessor puede procesar videos con ffmpeg a formato 1:1</done>
</task>

<task type="auto">
  <name>Task 3: Crear handlers de Telegram y actualizar main.py</name>
  <files>bot/handlers.py, bot/main.py</files>
  <action>
Crear `bot/handlers.py` con función handle_video:

1. Recibir update con mensaje de video
2. Usar TempManager como context manager
3. Descargar el video a archivo temporal:
   - video = update.message.video
   - file = await video.get_file()
   - await file.download_to_drive(temp_path)
4. Procesar con VideoProcessor.process_video()
5. Enviar resultado como video note:
   - await update.message.reply_video_note(video=open(output_path, 'rb'))
6. Manejar errores: try/except que envíe mensaje de error al usuario
7. Cleanup automático al salir del context manager

Actualizar `bot/main.py`:
- Importar handle_video desde bot.handlers
- Cambiar el handler de video para usar la nueva función
- Mantener handler de /start

IMPORTANTE: reply_video_note envía como nota de video circular.
El video debe ser formato 1:1 para que se vea correctamente.
  </action>
  <verify>
python -c "from bot.handlers import handle_video; from bot.main import main; print('Handlers OK')"
  </verify>
  <done>Handler descarga, procesa y envía videos como video notes</done>
</task>

</tasks>

<verification>
- [ ] TempManager crea y limpia directorios temporales
- [ ] VideoProcessor ejecuta ffmpeg con parámetros correctos
- [ ] Handler integra descarga, procesamiento y envío
- [ ] Todos los imports funcionan correctamente
- [ ] Manejo de errores implementado
</verification>

<success_criteria>
1. Videos se descargan desde Telegram a archivos temporales
2. ffmpeg procesa videos a formato 1:1 cuadrado centrado
3. Duración limitada a 60 segundos
4. Resolución máxima 640x640
5. Resultado se envía como video note circular
6. Archivos temporales se limpian después del procesamiento
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-video-processing/01-02-SUMMARY.md`
</output>
