---
phase: 03-voice-notes-voice-message-processing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "Bot detecta automáticamente cuando usuario envía nota de voz (voice message)"
    - "Usuario recibe archivo MP3 descargable al enviar nota de voz"
    - "Conversión preserva calidad de audio en MP3"
    - "No se requieren comandos para la conversión"
  artifacts:
    - path: "bot/handlers.py"
      provides: "Handler para voice messages a MP3"
      contains: "handle_voice_message"
      exports: ["handle_voice_message"]
    - path: "bot/main.py"
      provides: "Registro de handler de voice messages"
      contains: "filters.VOICE"
  key_links:
    - from: "bot/main.py"
      to: "bot/handlers.py"
      via: "MessageHandler(filters.VOICE)"
      pattern: "filters.VOICE.*handle_voice_message"
    - from: "bot/handlers.py"
      to: "bot/audio_processor.py"
      via: "VoiceToMp3Converter"
      pattern: "VoiceToMp3Converter.*process"
---

<objective>
Implementar la detección automática de notas de voz (voice messages) de Telegram y su conversión a archivos MP3 descargables.

Purpose: Permitir a los usuarios enviar notas de voz nativas de Telegram y recibirlas como archivos MP3 que pueden descargar y usar fuera de Telegram.
Output: Handler handle_voice_message en bot/handlers.py y registro en bot/main.py para detección automática.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@bot/handlers.py
@bot/main.py
@bot/audio_processor.py
@bot/temp_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implementar handle_voice_message handler</name>
  <files>bot/handlers.py</files>
  <action>
Agregar la función `handle_voice_message` a `bot/handlers.py`:

1. Importar VoiceToMp3Converter desde bot.audio_processor

2. Agregar función `handle_voice_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None`:
   - Obtener la nota de voz de update.message.voice
   - Generar correlation_id con uuid
   - Validar tamaño del archivo usando validate_file_size
   - Enviar mensaje "Convirtiendo nota de voz a MP3..." al usuario

3. Usar TempManager como context manager:
   ```python
   with TempManager() as temp_mgr:
       # procesamiento
   ```

4. Dentro del context manager:
   - Generar nombres de archivo seguros:
     - input: voice_{user_id}_{file_unique_id}.oga (Telegram usa .oga para voice)
     - output: voice_{user_id}_{file_unique_id}.mp3
   - Descargar archivo usando _download_with_retry
   - El archivo de entrada será OGG Opus (formato nativo de Telegram)
   - Verificar espacio en disco con check_disk_space

5. Procesar con VoiceToMp3Converter:
   ```python
   converter = VoiceToMp3Converter(str(input_path), str(output_path))
   success = await asyncio.wait_for(
       loop.run_in_executor(None, converter.process),
       timeout=config.PROCESSING_TIMEOUT
   )
   ```

6. Enviar resultado:
   - Si éxito: usar update.message.reply_audio(
       audio=open(output_path, "rb"),
       title="Nota de voz",
       performer="Telegram Voice",
       filename=f"voice_{user_id}.mp3"
     )
   - reply_audio muestra el reproductor con metadatos
   - Eliminar mensaje de "Convirtiendo..." en éxito

7. Manejar errores:
   - DownloadError: "No pude descargar la nota de voz"
   - asyncio.TimeoutError: "La conversión tardó demasiado"
   - Errores genéricos con handle_processing_error

IMPORTANTE: Las notas de voz de Telegram vienen en formato OGG Opus (extensión .oga). VoiceToMp3Converter debe manejar este formato de entrada. Seguir el patrón de handle_video.
  </action>
  <verify>
python -c "from bot.handlers import handle_voice_message; print('handle_voice_message imported OK')"
  </verify>
  <done>Handler handle_voice_message implementado con conversión a MP3</done>
</task>

<task type="auto">
  <name>Task 2: Agregar error específico para conversión Voice a MP3</name>
  <files>bot/error_handler.py</files>
  <action>
Agregar clase de error específica para conversión de voice a MP3 en `bot/error_handler.py`:

1. Agregar clase `VoiceToMp3Error`:
   ```python
   class VoiceToMp3Error(VideoProcessingError):
       """Exception raised when voice to MP3 conversion fails."""
       def __init__(self, message: str = "Error convirtiendo nota de voz a MP3"):
           self.message = message
           super().__init__(self.message)
   ```

2. Agregar entrada a ERROR_MESSAGES:
   ```python
   VoiceToMp3Error: "No pude convertir la nota de voz a MP3. Intenta de nuevo.",
   ```

IMPORTANTE: Mantener consistencia con errores existentes. Mensaje en español.
  </action>
  <verify>
python -c "from bot.error_handler import VoiceToMp3Error; print('VoiceToMp3Error imported OK')"
  </verify>
  <done>Clase VoiceToMp3Error agregada a error_handler.py</done>
</task>

<task type="auto">
  <name>Task 3: Registrar handler en bot/main.py</name>
  <files>bot/main.py</files>
  <action>
Actualizar `bot/main.py` para registrar el handler de notas de voz:

1. Importar handle_voice_message desde bot.handlers:
   ```python
   from bot.handlers import (
       start, handle_video, handle_convert_command, handle_extract_audio_command,
       handle_split_command, handle_join_start, handle_join_done, handle_join_cancel,
       handle_voice_message
   )
   ```

2. Agregar handler para notas de voz (voice messages):
   ```python
   # Add handler for voice messages (OGG Opus from Telegram)
   application.add_handler(MessageHandler(filters.VOICE, handle_voice_message))
   ```

3. Agregar handler para archivos de audio (MP3, etc.):
   ```python
   # Add handler for audio files (MP3, OGG, etc.)
   application.add_handler(MessageHandler(filters.AUDIO, handle_audio_file))
   ```

4. IMPORTANTE: El orden de handlers importa. Los handlers más específicos deben ir antes:
   - CommandHandlers primero (ya están)
   - MessageHandler(filters.VIDEO) - ya existe
   - MessageHandler(filters.VOICE) - agregar
   - MessageHandler(filters.AUDIO) - agregar

5. Verificar que no hay conflictos con handlers existentes.

IMPORTANTE: filters.VOICE detecta notas de voz nativas de Telegram (circulares). filters.AUDIO detecta archivos de audio enviados como documentos (MP3, etc.). Son mutuamente excluyentes.
  </action>
  <verify>
python -c "from bot.main import main; print('Main imports OK with new handlers')"
  </verify>
  <done>Handlers de voz registrados en main.py con filters.VOICE y filters.AUDIO</done>
</task>

</tasks>

<verification>
- [ ] handle_voice_message existe en bot/handlers.py
- [ ] VoiceToMp3Error existe en error_handler.py
- [ ] Handler registrado en main.py con filters.VOICE
- [ ] Handler de audio (filters.AUDIO) también registrado
- [ ] Orden de handlers es correcto (no hay conflictos)
- [ ] Usa TempManager para limpieza
- [ ] Envía resultado como reply_audio con metadatos
- [ ] Mensajes de error en español
</verification>

<success_criteria>
1. Handler handle_voice_message implementado y funcional
2. Detección automática de notas de voz nativas (filters.VOICE)
3. Conversión OGG Opus → MP3 funciona correctamente
4. Archivo MP3 enviado como audio descargable con metadatos
5. Handler registrado correctamente en main.py sin conflictos
6. Errores manejados apropiadamente
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-notes-voice-message-processing/03-03-SUMMARY.md`
</output>
