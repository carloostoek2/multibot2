---
phase: 07-audio-effects
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "User can send /normalize command and see target loudness selection keyboard"
    - "Normalize offers presets: Podcast (-16 LUFS), Music (-14 LUFS), Streaming (-23 LUFS)"
    - "Each preset maps to appropriate target LUFS value"
    - "Processed audio is normalized to EBU R128 standard"
    - "User receives confirmation with target loudness applied"
    - "Help text includes /normalize command"
  artifacts:
    - path: "bot/handlers.py"
      provides: "handle_normalize_command and handle_normalize_selection handlers"
      contains: ["def handle_normalize_command", "def handle_normalize_selection"]
    - path: "bot/main.py"
      provides: "Handler registration for normalize command"
      contains: ["normalize", "CallbackQueryHandler.*normalize"]
  key_links:
    - from: "bot/handlers.py"
      to: "bot/audio_effects.py"
      via: "import AudioEffects"
      pattern: "from bot.audio_effects import AudioEffects"
    - from: "handle_normalize_command"
      to: "inline keyboard"
      via: "InlineKeyboardMarkup with preset buttons"
      pattern: "callback_data=\"normalize:\\w+\""
    - from: "handle_normalize_selection"
      to: "AudioEffects.normalize"
      via: "effects.normalize(target_lufs)"
      pattern: "\.normalize\(.*target_lufs"
---

<objective>
Implement /normalize command with inline keyboard preset selection for EBU R128 loudness normalization.

Purpose: Provide users with professional loudness normalization to standardize audio volume levels for different use cases (podcast, music, streaming).
Output: Normalize command handler with preset selection UI
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/data/data/com.termux/files/home/repos/multibot2/bot/handlers.py
@/data/data/com.termux/files/home/repos/multibot2/bot/main.py
@/data/data/com.termux/files/home/repos/multibot2/bot/audio_effects.py

Reference patterns:
- handle_denoise_command for command structure
- handle_effect_selection for callback handling
- Inline keyboard pattern for preset selection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement /normalize command handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_normalize_command function to handlers.py:

    1. Function signature: async def handle_normalize_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Input validation (follow handle_denoise_command pattern):
       - Get audio from message or reply using _get_audio_from_message helper
       - If no audio, reply: "Envía /normalize respondiendo a un archivo de audio o adjunta el audio al mensaje."
       - Validate file size using validate_file_size

    3. Store state in context.user_data:
       - "effect_audio_file_id": audio.file_id
       - "effect_audio_correlation_id": correlation_id
       - "effect_type": "normalize"

    4. Create inline keyboard for normalization presets:
       - Layout: 1 button per row (3 rows) for clarity
       - Callback data format: "normalize:music", "normalize:podcast", "normalize:streaming"
       - Button text and mappings:
         * "music" -> -14 LUFS (Música/General -14 LUFS)
         * "podcast" -> -16 LUFS (Podcast/Voz -16 LUFS)
         * "streaming" -> -23 LUFS (Streaming/Broadcast -23 LUFS)

    5. Send message:
       "Selecciona el perfil de normalización:\n\nLa normalización ajusta el volumen al estándar EBU R128."

    6. Import AudioEffects and AudioEffectsError at top of file (if not already imported in 07-02)
  </action>
  <verify>grep -n "def handle_normalize_command" bot/handlers.py</verify>
  <done>handle_normalize_command exists with preset keyboard, proper validation, and state storage</done>
</task>

<task type="auto">
  <name>Task 2: Implement normalize selection callback handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_normalize_selection function to handlers.py:

    1. Function signature: async def handle_normalize_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Register with pattern: "^normalize:\w+$"

    3. Parse callback data:
       - Format: "normalize:music", "normalize:podcast", or "normalize:streaming"
       - Split by ":" to get preset name
       - Map preset to target_lufs value:
         * "music" -> -14.0 LUFS
         * "podcast" -> -16.0 LUFS
         * "streaming" -> -23.0 LUFS

    4. Retrieve state from context.user_data:
       - file_id, correlation_id
       - Verify effect_type is "normalize"

    5. Processing flow:
       - Update message to show processing: "Normalizando audio a {preset} ({lufs} LUFS)..."
       - Use TempManager for automatic cleanup
       - Download audio file with _download_with_retry
       - Validate audio with validate_audio_file
       - Check disk space with check_disk_space

    6. Apply normalization:
       - Create AudioEffects instance
       - Call effects.normalize(target_lufs=target_lufs)
       - On success: send normalized audio document
       - On error: raise AudioEffectsError

    7. Success message:
       "¡Listo! Audio normalizado a {preset} ({lufs} LUFS).\n\nEl volumen ahora está optimizado para {use_case}."
       - music: "reproducción general"
       - podcast: "contenido de voz"
       - streaming: "plataformas de streaming"

    8. Error handling:
       - Catch AudioEffectsError, ValidationError, DownloadError
       - Use handle_processing_error for consistent error messages
  </action>
  <verify>grep -n "def handle_normalize_selection" bot/handlers.py</verify>
  <done>handle_normalize_selection callback handler exists with full processing flow for normalization</done>
</task>

<task type="auto">
  <name>Task 3: Register handler and update help text</name>
  <files>bot/main.py, bot/handlers.py</files>
  <action>
    1. In bot/main.py:
       - Import handle_normalize_command, handle_normalize_selection
       - Add CommandHandler("normalize", handle_normalize_command)
       - Add CallbackQueryHandler(handle_normalize_selection, pattern="^normalize:")
       - Place handlers after compress handlers

    2. In bot/handlers.py (help text):
       - Add to help_text: "/normalize - Normaliza el volumen del audio (EBU R128)"
       - Place after /compress in the list
  </action>
  <verify>grep -n "normalize" bot/main.py bot/handlers.py | head -15</verify>
  <done>Normalize handlers registered, help text updated with /normalize command</done>
</task>

</tasks>

<verification>
1. /normalize command shows inline keyboard with 3 presets (music/podcast/streaming)
2. Selecting preset applies normalization and sends processed audio
3. Success message includes LUFS value and use case description
4. Help text includes /normalize command
5. Error handling works for invalid files
</verification>

<success_criteria>
- handle_normalize_command exists and shows preset keyboard (music/podcast/streaming)
- handle_normalize_selection processes callbacks and applies normalization
- Presets map to correct LUFS values: music=-14, podcast=-16, streaming=-23
- Callback pattern "^normalize:" properly registered
- Command listed in help text
- Handlers follow existing patterns from audio effects
- AudioEffects.normalize integration works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-audio-effects/07-03-SUMMARY.md`
</output>
