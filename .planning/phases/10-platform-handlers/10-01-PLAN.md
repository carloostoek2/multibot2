---
phase: 10-platform-handlers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/downloaders/platforms/__init__.py
  - bot/downloaders/platforms/youtube.py
  - bot/downloaders/__init__.py
autonomous: true

must_haves:
  truths:
    - "YouTube videos download with best quality under 50MB limit"
    - "YouTube Shorts are detected and handled with vertical format preference"
    - "YouTube metadata includes title, duration, channel, view count, and thumbnail"
    - "Audio-only extraction works for YouTube videos (YT-02)"
  artifacts:
    - path: "bot/downloaders/platforms/__init__.py"
      provides: "Platform handlers package"
      min_lines: 20
    - path: "bot/downloaders/platforms/youtube.py"
      provides: "YouTube-specific downloader with Shorts detection"
      exports: ["YouTubeDownloader", "is_youtube_shorts"]
      min_lines: 200
  key_links:
    - from: "bot/downloaders/platforms/youtube.py"
      to: "bot/downloaders/ytdlp_downloader.py"
      via: "class inheritance"
      pattern: "class YouTubeDownloader(YtDlpDownloader)"
    - from: "bot/downloaders/platforms/__init__.py"
      to: "bot/downloaders/__init__.py"
      via: "package export"
      pattern: "from .platforms import YouTubeDownloader"
---

<objective>
Implement YouTube-specific downloader with enhanced metadata extraction and Shorts detection. Extends YtDlpDownloader with YouTube-specific features like view count extraction, Shorts aspect ratio hints, and age-restricted content handling.

Purpose: Provide optimized YouTube downloading with platform-specific metadata and Shorts support (YT-01, YT-02, YT-03).
Output: YouTubeDownloader class with Shorts detection and enhanced metadata.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/downloaders/ytdlp_downloader.py
@bot/downloaders/base.py
@bot/downloaders/exceptions.py
@bot/downloaders/url_detector.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platforms package structure</name>
  <files>bot/downloaders/platforms/__init__.py</files>
  <action>
Create the bot/downloaders/platforms/ directory and __init__.py file. This package will contain platform-specific downloader implementations.

The __init__.py should:
1. Define the public API exports for the platforms package
2. Set up proper logging for the platforms module
3. Import and re-export platform handlers as they are created

Create the package structure:
```python
"""Platform-specific downloader implementations.

This package provides specialized downloaders for specific platforms
that extend the base yt-dlp functionality with platform-specific
features and metadata extraction.
"""
import logging

logger = logging.getLogger(__name__)

# Platform handlers will be imported here as they are created
# from .youtube import YouTubeDownloader
# from .instagram import InstagramDownloader
# etc.

__all__ = [
    # Platform handlers will be listed here
]
```

Ensure the directory structure exists:
- bot/downloaders/platforms/__init__.py
  </action>
  <verify>
    - Python can import bot.downloaders.platforms without errors
    - Directory bot/downloaders/platforms/ exists with __init__.py
    - Package logger is configured
  </verify>
  <done>
    - bot/downloaders/platforms/__init__.py created
    - Package structure exists and is importable
    - Logger configured for platforms module
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement YouTubeDownloader with Shorts detection</name>
  <files>bot/downloaders/platforms/youtube.py</files>
  <action>
Create the YouTubeDownloader class that extends YtDlpDownloader with YouTube-specific features.

Implement:

1. **YouTube URL patterns**:
   ```python
   YOUTUBE_PATTERNS = [
       r'(?:https?://)?(?:www\.)?youtube\.com/watch\?v=[\w-]+',
       r'(?:https?://)?(?:www\.)?youtube\.com/shorts/[\w-]+',
       r'(?:https?://)?youtu\.be/[\w-]+',
       r'(?:https?://)?(?:www\.)?youtube\.com/embed/[\w-]+',
   ]
   ```

2. **is_youtube_url(url: str) -> bool**:
   - Check if URL matches any YouTube pattern
   - Return True for youtube.com, youtu.be domains

3. **is_youtube_shorts(url: str) -> bool**:
   - Check if URL contains /shorts/ path
   - Return True for Shorts URLs

4. **YouTubeDownloader class** extending YtDlpDownloader:
   ```python
   class YouTubeDownloader(YtDlpDownloader):
       """YouTube-specific downloader with Shorts support."""

       @property
       def name(self) -> str:
           return "YouTube Downloader"

       @property
       def supported_platforms(self) -> list[str]:
           return ["YouTube", "YouTube Shorts"]
   ```

5. **Override can_handle(url: str) -> bool**:
   - Return True if is_youtube_url(url) returns True
   - Use super().can_handle() as fallback for validation

6. **Override extract_metadata() for YouTube-specific fields**:
   - Call super().extract_metadata() to get base metadata
   - Add YouTube-specific fields:
     - view_count: Number of views
     - like_count: Number of likes (if available)
     - upload_date: Video upload date
     - tags: Video tags
     - categories: Video categories
     - is_shorts: Boolean indicating if it's a Short
     - aspect_ratio: For Shorts, hint at 9:16 format
   - Parse upload_date from YYYYMMDD format

7. **Override _build_ydl_options() for YouTube optimizations**:
   - For Shorts: Add format preference for vertical video
   - For regular videos: Use standard format selection
   - Add 'noplaylist': True to prevent playlist downloads
   - Handle age-restricted content gracefully (YT-03)

8. **Helper methods**:
   - `_extract_youtube_id(url: str) -> str` - Extract video ID from URL
   - `_format_view_count(count: int) -> str` - Format as "1.2M views", "500K views"
   - `_is_age_restricted(info: dict) -> bool` - Check if video is age-restricted

9. **Age-restricted content handling (YT-03)**:
   - Detect age-restricted videos in metadata
   - Return clear error message if content cannot be downloaded
   - Try to use yt-dlp's age-gate bypass if available

Example metadata return:
```python
{
    'title': 'Video Title',
    'duration': 60,
    'uploader': 'Channel Name',
    'thumbnail': 'https://i.ytimg.com/vi/...',
    'filesize': 10485760,
    'view_count': 1500000,
    'like_count': 50000,
    'upload_date': '2024-01-15',
    'is_shorts': True,
    'aspect_ratio': '9:16',
    'description': 'Video description...',
}
```
  </action>
  <verify>
    - YouTubeDownloader can be instantiated
    - can_handle returns True for youtube.com URLs
    - can_handle returns True for youtu.be URLs
    - is_youtube_shorts returns True for /shorts/ URLs
    - extract_metadata includes view_count, upload_date
    - extract_metadata sets is_shorts=True for Shorts
    - Age-restricted videos are detected and handled
  </verify>
  <done>
    - YouTubeDownloader extends YtDlpDownloader
    - Shorts detection implemented
    - YouTube-specific metadata extraction (views, likes, upload date)
    - Age-restricted content handling (YT-03)
    - Format preferences for vertical video on Shorts
  </done>
</task>

<task type="auto">
  <name>Task 3: Update package exports</name>
  <files>bot/downloaders/platforms/__init__.py, bot/downloaders/__init__.py</files>
  <action>
Update package exports to include YouTubeDownloader.

1. Update bot/downloaders/platforms/__init__.py:
```python
from .youtube import YouTubeDownloader, is_youtube_url, is_youtube_shorts

__all__ = [
    'YouTubeDownloader',
    'is_youtube_url',
    'is_youtube_shorts',
]
```

2. Update bot/downloaders/__init__.py to export from platforms:
```python
# Import platform handlers
from .platforms import (
    YouTubeDownloader,
    is_youtube_shorts,
    is_youtube_url,
)

# Add to __all__
__all__ = [
    # ... existing exports ...
    # Platform handlers
    'YouTubeDownloader',
    'is_youtube_shorts',
    'is_youtube_url',
]
```

Ensure no circular imports are created.
  </action>
  <verify>
    - YouTubeDownloader is importable from bot.downloaders.platforms
    - YouTubeDownloader is importable from bot.downloaders
    - is_youtube_shorts and is_youtube_url are exportable
    - No circular import errors
  </verify>
  <done>
    - Platform handlers exported from platforms package
    - YouTubeDownloader available from bot.downloaders
    - Helper functions is_youtube_url, is_youtube_shorts exported
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Import test**: `python -c "from bot.downloaders import YouTubeDownloader; print('OK')"`
2. **Shorts detection**: Test is_youtube_shorts with Shorts URL
3. **Metadata test**: Extract metadata from public YouTube video
4. **View count test**: Verify view_count field is populated
5. **Integration test**: Full download flow (optional, network-dependent)

Run: `python -c "from bot.downloaders.platforms.youtube import is_youtube_shorts; print(is_youtube_shorts('https://youtube.com/shorts/abc123'))"`
</verification>

<success_criteria>
- YouTubeDownloader extends YtDlpDownloader correctly
- YouTube Shorts are detected via is_youtube_shorts()
- Metadata includes YouTube-specific fields (views, likes, upload date)
- Shorts have is_shorts=True and aspect_ratio hint
- Age-restricted content is detected and handled gracefully
- Package exports are updated correctly
- No breaking changes to existing downloader functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-platform-handlers/10-01-SUMMARY.md`
</output>
