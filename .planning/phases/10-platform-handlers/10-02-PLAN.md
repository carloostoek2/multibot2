---
phase: 10-platform-handlers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/downloaders/platforms/instagram.py
  - bot/downloaders/platforms/__init__.py
  - bot/downloaders/__init__.py
autonomous: true

must_haves:
  truths:
    - "Instagram posts with single video download successfully"
    - "Instagram Reels are detected and download with correct aspect ratio"
    - "Instagram Stories download if publicly accessible"
    - "Instagram metadata includes username, caption, likes, and post type"
  artifacts:
    - path: "bot/downloaders/platforms/instagram.py"
      provides: "Instagram-specific downloader with Reels/Stories support"
      exports: ["InstagramDownloader", "InstagramContentType", "is_instagram_reel", "is_instagram_story"]
      min_lines: 250
  key_links:
    - from: "bot/downloaders/platforms/instagram.py"
      to: "bot/downloaders/ytdlp_downloader.py"
      via: "class inheritance"
      pattern: "class InstagramDownloader(YtDlpDownloader)"
---

<objective>
Implement Instagram-specific downloader with support for posts, Reels, and Stories. Extends YtDlpDownloader with Instagram-specific metadata extraction including username, caption, likes count, and content type detection (post vs Reel vs Story).

Purpose: Provide optimized Instagram downloading with proper content type detection and metadata (IG-01, IG-02, IG-03).
Output: InstagramDownloader class with Reels/Stories detection and enhanced metadata.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/downloaders/ytdlp_downloader.py
@bot/downloaders/base.py
@bot/downloaders/exceptions.py
@bot/downloaders/platforms/youtube.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Instagram content type enum and URL helpers</name>
  <files>bot/downloaders/platforms/instagram.py</files>
  <action>
Create Instagram-specific content type definitions and URL parsing utilities.

Implement:

1. **InstagramContentType Enum**:
   ```python
   from enum import Enum, auto

   class InstagramContentType(Enum):
       POST = auto()      # Regular post (/p/)
       REEL = auto()      # Reel (/reel/ or /reels/)
       STORY = auto()     # Story (/stories/)
       UNKNOWN = auto()
   ```

2. **Instagram URL patterns**:
   ```python
   INSTAGRAM_PATTERNS = {
       'post': [
           r'instagram\.com/p/[\w-]+',
           r'instagram\.com/tv/[\w-]+',  # IGTV (legacy)
       ],
       'reel': [
           r'instagram\.com/reel/[\w-]+',
           r'instagram\.com/reels/[\w-]+',
       ],
       'story': [
           r'instagram\.com/stories/[\w-]+/[\d-]+',
       ],
   }
   ```

3. **Helper functions**:
   ```python
   def is_instagram_url(url: str) -> bool:
       """Check if URL is an Instagram URL."""
       return 'instagram.com' in url.lower()

   def detect_instagram_content_type(url: str) -> InstagramContentType:
       """Detect the type of Instagram content from URL."""
       url_lower = url.lower()

       if '/reel/' in url_lower or '/reels/' in url_lower:
           return InstagramContentType.REEL
       elif '/stories/' in url_lower:
           return InstagramContentType.STORY
       elif '/p/' in url_lower or '/tv/' in url_lower:
           return InstagramContentType.POST
       else:
           return InstagramContentType.UNKNOWN

   def is_instagram_reel(url: str) -> bool:
       """Check if URL is an Instagram Reel."""
       return detect_instagram_content_type(url) == InstagramContentType.REEL

   def is_instagram_story(url: str) -> bool:
       """Check if URL is an Instagram Story."""
       return detect_instagram_content_type(url) == InstagramContentType.STORY

   def extract_shortcode(url: str) -> Optional[str]:
       """Extract Instagram shortcode from URL."""
       # Patterns like /p/ABC123/, /reel/ABC123/
       patterns = [
           r'/p/([\w-]+)',
           r'/reel/([\w-]+)',
           r'/reels/([\w-]+)',
           r'/tv/([\w-]+)',
       ]
       for pattern in patterns:
           match = re.search(pattern, url)
           if match:
               return match.group(1)
       return None
   ```

4. **Username extraction**:
   ```python
   def extract_username_from_url(url: str) -> Optional[str]:
       """Extract username from Instagram URL (for stories)."""
       # Pattern: /stories/username/123456/
       match = re.search(r'/stories/([\w.]+)/', url.lower())
       if match:
           return match.group(1)
       return None
   ```

These utilities form the foundation for the InstagramDownloader class.
  </action>
  <verify>
    - is_instagram_url returns True for instagram.com URLs
    - detect_instagram_content_type correctly identifies posts, reels, stories
    - is_instagram_reel returns True for /reel/ and /reels/ URLs
    - is_instagram_story returns True for /stories/ URLs
    - extract_shortcode returns the shortcode from various URL formats
    - extract_username_from_url returns username from story URLs
  </verify>
  <done>
    - InstagramContentType enum defined
    - URL helper functions implemented
    - Content type detection working correctly
    - Shortcode and username extraction working
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement InstagramDownloader class</name>
  <files>bot/downloaders/platforms/instagram.py</files>
  <action>
Create the InstagramDownloader class that extends YtDlpDownloader with Instagram-specific features.

Implement:

1. **Class definition**:
   ```python
   class InstagramDownloader(YtDlpDownloader):
       """Instagram-specific downloader for posts, Reels, and Stories."""

       @property
       def name(self) -> str:
           return "Instagram Downloader"

       @property
       def supported_platforms(self) -> list[str]:
           return ["Instagram", "Instagram Reels", "Instagram Stories"]
   ```

2. **Override can_handle(url: str) -> bool**:
   - Return True if is_instagram_url(url) returns True
   - Validate that content type is not UNKNOWN
   - Use super().can_handle() as secondary check

3. **Override extract_metadata() for Instagram-specific fields**:
   ```python
   async def extract_metadata(self, url: str, options: DownloadOptions) -> dict[str, Any]:
       # Get base metadata from parent
       metadata = await super().extract_metadata(url, options)

       # Add Instagram-specific fields
       content_type = detect_instagram_content_type(url)
       metadata['content_type'] = content_type.name.lower()
       metadata['is_reel'] = content_type == InstagramContentType.REEL
       metadata['is_story'] = content_type == InstagramContentType.STORY
       metadata['shortcode'] = extract_shortcode(url)

       # Extract additional fields from yt-dlp info
       info = metadata.get('_raw_info', {})  # Store raw info if needed

       # Instagram-specific metadata
       metadata['username'] = info.get('uploader') or info.get('channel')
       metadata['caption'] = info.get('description', '')
       metadata['likes_count'] = info.get('like_count')
       metadata['comments_count'] = info.get('comment_count')
       metadata['upload_date'] = info.get('upload_date')

       # For Reels, mark aspect ratio
       if metadata['is_reel']:
           metadata['aspect_ratio'] = '9:16'

       return metadata
   ```

4. **Override _build_ydl_options() for Instagram optimizations**:
   ```python
   def _build_ydl_options(self, options: DownloadOptions, output_path: str, correlation_id: str) -> dict:
       ydl_opts = super()._build_ydl_options(options, output_path, correlation_id)

       # Instagram-specific options
       ydl_opts['socket_timeout'] = 30  # Instagram can be slow

       # Add headers to avoid blocks
       ydl_opts['http_headers'] = {
           'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
       }

       return ydl_opts
   ```

5. **Handle private/unavailable content (IG-03)**:
   - Detect when content is private (403 errors)
   - Detect when story has expired
   - Provide clear error messages:
     - Private: "Este contenido de Instagram es privado. No puedo acceder a posts privados."
     - Story expired: "Esta historia de Instagram ha expirado o no está disponible."
     - Rate limited: "Instagram está limitando las solicitudes. Intenta de nuevo más tarde."

6. **Caption formatting**:
   ```python
   def _format_caption(self, caption: str, max_length: int = 200) -> str:
       """Format caption for display, truncating if needed."""
       if not caption:
           return ""

       # Remove excessive newlines
       caption = ' '.join(caption.split())

       if len(caption) > max_length:
           caption = caption[:max_length].rsplit(' ', 1)[0] + '...'

       return caption
   ```

7. **Format likes/comments count**:
   ```python
   def _format_count(self, count: Optional[int]) -> str:
       """Format count as human-readable string."""
       if count is None:
           return "Unknown"

       if count >= 1000000:
           return f"{count / 1000000:.1f}M"
       elif count >= 1000:
           return f"{count / 1000:.1f}K"
       else:
           return str(count)
   ```

Example metadata return:
```python
{
    'title': 'Post by username',
    'duration': 15,
    'uploader': 'username',
    'thumbnail': 'https://instagram.com/...',
    'filesize': 5242880,
    'content_type': 'reel',
    'is_reel': True,
    'is_story': False,
    'shortcode': 'ABC123xyz',
    'username': 'username',
    'caption': 'Video caption text...',
    'likes_count': 15000,
    'comments_count': 500,
    'aspect_ratio': '9:16',
    'upload_date': '2024-01-15',
}
```
  </action>
  <verify>
    - InstagramDownloader can be instantiated
    - can_handle returns True for instagram.com URLs
    - detect_instagram_content_type identifies posts, reels, stories
    - extract_metadata includes username, caption, likes_count
    - Reels have is_reel=True and aspect_ratio='9:16'
    - Stories have is_story=True
    - Private content errors are handled gracefully
  </verify>
  <done>
    - InstagramDownloader extends YtDlpDownloader
    - Content type detection (post/reel/story) working
    - Instagram-specific metadata extraction (username, caption, likes)
    - Private/unavailable content handling
    - Aspect ratio hints for Reels
  </done>
</task>

<task type="auto">
  <name>Task 3: Update package exports</name>
  <files>bot/downloaders/platforms/__init__.py, bot/downloaders/__init__.py</files>
  <action>
Update package exports to include InstagramDownloader and related utilities.

1. Update bot/downloaders/platforms/__init__.py:
```python
from .instagram import (
    InstagramDownloader,
    InstagramContentType,
    detect_instagram_content_type,
    is_instagram_reel,
    is_instagram_story,
    is_instagram_url,
    extract_shortcode,
)

__all__ = [
    # YouTube (from 10-01)
    'YouTubeDownloader',
    'is_youtube_url',
    'is_youtube_shorts',
    # Instagram
    'InstagramDownloader',
    'InstagramContentType',
    'detect_instagram_content_type',
    'is_instagram_reel',
    'is_instagram_story',
    'is_instagram_url',
    'extract_shortcode',
]
```

2. Update bot/downloaders/__init__.py to include Instagram exports:
```python
# Import platform handlers
from .platforms import (
    # YouTube
    YouTubeDownloader,
    is_youtube_shorts,
    is_youtube_url,
    # Instagram
    InstagramDownloader,
    InstagramContentType,
    is_instagram_reel,
    is_instagram_story,
)

# Add to __all__
__all__ = [
    # ... existing exports ...
    # Platform handlers
    'YouTubeDownloader',
    'is_youtube_shorts',
    'is_youtube_url',
    'InstagramDownloader',
    'InstagramContentType',
    'is_instagram_reel',
    'is_instagram_story',
]
```
  </action>
  <verify>
    - InstagramDownloader is importable from bot.downloaders.platforms
    - InstagramDownloader is importable from bot.downloaders
    - Helper functions and enums are exportable
    - No circular import errors
  </verify>
  <done>
    - Instagram handlers exported from platforms package
    - InstagramDownloader available from bot.downloaders
    - All helper functions exported
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Import test**: `python -c "from bot.downloaders import InstagramDownloader; print('OK')"`
2. **Content type test**: Verify detect_instagram_content_type with different URLs
3. **Reel detection**: Test is_instagram_reel with /reel/ URL
4. **Story detection**: Test is_instagram_story with /stories/ URL
5. **Metadata test**: Verify metadata includes username, caption, likes

Run: `python -c "from bot.downloaders.platforms.instagram import detect_instagram_content_type, InstagramContentType; print(detect_instagram_content_type('https://instagram.com/reel/ABC123'))"`
</verification>

<success_criteria>
- InstagramDownloader extends YtDlpDownloader correctly
- Content type detection (post/reel/story) working
- is_instagram_reel and is_instagram_story functions work
- Metadata includes Instagram-specific fields (username, caption, likes, comments)
- Reels have is_reel=True and aspect_ratio='9:16'
- Private/unavailable content is handled with clear error messages
- Package exports are updated correctly
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-platform-handlers/10-02-SUMMARY.md`
</output>
