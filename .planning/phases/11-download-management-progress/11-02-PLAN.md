---
phase: 11-download-management-progress
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/downloaders/progress_tracker.py
  - bot/downloaders/__init__.py
autonomous: true

must_haves:
  truths:
    - Progress updates are sent every 5-10% or 3-5 seconds
    - Progress message shows percentage, downloaded/total size, speed
    - Progress bar visualization uses ASCII or emoji characters
    - Final completion message includes file info
    - Progress updates are throttled to avoid message spam
  artifacts:
    - path: bot/downloaders/progress_tracker.py
      provides: ProgressTracker class with throttled updates
      min_lines: 150
      exports:
        - ProgressTracker
        - format_progress_bar
        - format_progress_message
    - path: bot/downloaders/__init__.py
      provides: Package exports updated
      contains: ProgressTracker
  key_links:
    - from: ProgressTracker
      to: DownloadTask
      via: progress callback registration
      pattern: task.progress = progress_data
    - from: format_progress_bar
      to: percentage calculation
      via: downloaded/total ratio
      pattern: int(percent / 100 * bar_width)
---

<objective>
Implement ProgressTracker for real-time download progress with throttled updates and visual progress bars.

Purpose: Provide users with clear visual feedback during downloads, showing percentage, size, speed, and ETA.
Output: ProgressTracker class with throttled updates and progress bar formatting utilities.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/downloaders/base.py
@bot/downloaders/ytdlp_downloader.py
@bot/downloaders/generic_downloader.py
@bot/downloaders/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress formatting utilities</name>
  <files>bot/downloaders/progress_tracker.py</files>
  <action>
Create progress formatting utilities in bot/downloaders/progress_tracker.py:

1. Import required modules: typing, datetime, math
2. Create format_progress_bar(percent: float, width: int = 20) -> str:
   - Use Unicode block characters: █ (full), ▌ (half), ▏ (quarter) for smooth progress
   - Calculate filled = int(percent / 100 * width)
   - Calculate partial for sub-character precision
   - Return string like "████████████░░░░░░░░ 60%"

3. Create format_bytes(bytes_value: int) -> str:
   - Convert bytes to human-readable: B, KB, MB, GB
   - Use 1024 base
   - Format: "12.5 MB", "850 KB"

4. Create format_speed(speed_bytes_per_sec: Optional[float]) -> str:
   - Format download speed
   - Return "--" if None
   - Format: "2.5 MB/s", "850 KB/s"

5. Create format_eta(seconds: Optional[int]) -> str:
   - Format ETA in human-readable form
   - Return "--" if None
   - Format: "2m 30s", "45s"

6. Create format_progress_message(progress: dict) -> str:
   - Accept progress dict with: percent, downloaded_bytes, total_bytes, speed, eta, status
   - Build formatted message in Spanish:
     "Descargando: [████████░░░░░░░░░░░░] 45% (12.5 MB / 25.0 MB) - 2.5 MB/s - ETA: 30s"
   - For completed status: "Descarga completada: archivo.mp4 (25.0 MB)"
   - Include emoji indicators: ⬇️ for downloading, ✅ for completed, ❌ for error

Use Spanish messages to match bot language convention.
  </action>
  <verify>python -c "from bot.downloaders.progress_tracker import format_progress_bar, format_bytes, format_progress_message; print(format_progress_bar(45)); print(format_bytes(13107200))"</verify>
  <done>Formatting utilities exist and produce correct output</done>
</task>

<task type="auto">
  <name>Task 2: Create ProgressTracker class with throttling</name>
  <files>bot/downloaders/progress_tracker.py</files>
  <action>
Create the ProgressTracker class with throttled updates:

1. Create ProgressTracker class:
   - __init__(
       min_update_interval: float = 3.0,  # seconds (per PT-02: 3-5 seconds)
       min_percent_change: float = 5.0,   # percent (per PT-02: 5-10%)
       on_update: Optional[Callable[[dict], None]] = None
     )
   - _last_update_time: datetime
   - _last_percent: float
   - _on_update: callback function

2. Implement should_update(percent: float) -> bool:
   - Check if enough time has passed (min_update_interval)
   - Check if enough progress has been made (min_percent_change)
   - Always update for status changes (finished, error)
   - Return True if update should be sent

3. Implement update(progress: dict) -> bool:
   - Extract percent from progress dict
   - Check should_update()
   - If yes: update internal state, call _on_update callback, return True
   - If no: return False

4. Implement create_callback() -> Callable:
   - Return a callback function suitable for DownloadOptions.progress_callback
   - The callback receives progress dict and calls self.update()
   - Handle async callback properly

5. Implement get_summary() -> dict:
   - Return summary of download: total bytes, average speed, duration
   - Useful for final completion message

6. Add configuration constants at module level:
   - DEFAULT_MIN_UPDATE_INTERVAL = 3.0
   - DEFAULT_MIN_PERCENT_CHANGE = 5.0
   - PROGRESS_BAR_WIDTH = 20

Use Spanish docstrings and comments to match codebase.
  </action>
  <verify>python -c "from bot.downloaders.progress_tracker import ProgressTracker; pt = ProgressTracker(); print('ProgressTracker created')"</verify>
  <done>ProgressTracker class exists with throttling logic</done>
</task>

<task type="auto">
  <name>Task 3: Update package exports and add integration helper</name>
  <files>bot/downloaders/__init__.py, bot/downloaders/progress_tracker.py</files>
  <action>
1. Update bot/downloaders/__init__.py:
   - Add import: from .progress_tracker import ProgressTracker, format_progress_bar, format_progress_message
   - Add to __all__: "ProgressTracker", "format_progress_bar", "format_progress_message"

2. Add integration helper function in progress_tracker.py:
   create_progress_callback(
       message_func: Callable[[str], Awaitable[None]],
       min_interval: float = 3.0,
       min_percent: float = 5.0
   ) -> Callable:
   - Creates a callback that sends progress messages via message_func
   - Uses ProgressTracker for throttling
   - Formats messages using format_progress_message()
   - Handles Telegram message editing for live updates

3. Verify imports work without errors.
  </action>
  <verify>python -c "from bot.downloaders import ProgressTracker, format_progress_bar, format_progress_message, create_progress_callback; print('All imports OK')"</verify>
  <done>Package exports updated, integration helper available</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for progress tracking</name>
  <files>bot/downloaders/progress_tracker.py</files>
  <action>
Add test code at the bottom of progress_tracker.py in if __name__ == "__main__" block:

1. Test format_progress_bar with various percentages (0, 25, 50, 75, 100)
2. Test format_bytes with various sizes
3. Test ProgressTracker throttling:
   - Create tracker with 1 second interval
   - Call update() multiple times rapidly
   - Verify only first update is sent
   - Wait and verify subsequent update is sent
4. Test format_progress_message with sample progress dicts

Use asyncio.run() for async test execution.
  </action>
  <verify>python bot/downloaders/progress_tracker.py</verify>
  <done>Tests pass, demonstrating progress formatting and throttling</done>
</task>

</tasks>

<verification>
- Progress bar renders correctly at different percentages
- Format functions produce human-readable output
- ProgressTracker throttles updates correctly
- Integration helper creates valid callbacks
- Package imports work correctly
</verification>

<success_criteria>
1. format_progress_bar creates visual progress bars
2. format_bytes, format_speed, format_eta work correctly
3. format_progress_message produces Spanish messages
4. ProgressTracker throttles updates per PT-02 requirements
5. create_progress_callback integrates with download flow
6. Package exports are updated
</success_criteria>

<output>
After completion, create `.planning/phases/11-download-management-progress/11-02-SUMMARY.md`
</output>
