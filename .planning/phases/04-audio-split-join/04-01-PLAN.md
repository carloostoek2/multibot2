---
phase: 04-audio-split-join
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/audio_splitter.py
autonomous: true

must_haves:
  truths:
    - "AudioSplitter class exists with split_by_duration method"
    - "AudioSplitter class has split_by_parts method"
    - "Split generates files numbered sequentially (part1, part2, etc.)"
    - "Spanish error messages for all failure cases"
    - "English logging for debugging"
  artifacts:
    - path: "bot/audio_splitter.py"
      provides: "AudioSplitter class for splitting audio files"
      min_lines: 200
      exports: ["AudioSplitter"]
  key_links:
    - from: "bot/audio_splitter.py"
      to: "bot/error_handler.py"
      via: "AudioSplitError exception"
      pattern: "from bot.error_handler import AudioSplitError"
---

<objective>
Create AudioSplitter class for splitting audio files into segments by duration or number of parts.

Purpose: Enable users to divide audio files into smaller segments for easier sharing or processing.
Output: bot/audio_splitter.py with AudioSplitter class following VideoSplitter patterns.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/split_processor.py
@bot/audio_processor.py
@bot/error_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AudioSplitError exception class</name>
  <files>bot/error_handler.py</files>
  <action>
    Add AudioSplitError exception class to bot/error_handler.py following the existing pattern:
    - Inherit from VideoProcessingError
    - Default Spanish message: "No pude dividir el audio"
    - Add to ERROR_MESSAGES dict with user-friendly Spanish message
    - Place after VoiceToMp3Error class (around line 104)

    Follow the exact same pattern as VideoSplitError but for audio operations.
  </action>
  <verify>grep -n "class AudioSplitError" bot/error_handler.py</verify>
  <done>AudioSplitError class exists with proper inheritance and error message mapping</done>
</task>

<task type="auto">
  <name>Task 2: Create AudioSplitter class</name>
  <files>bot/audio_splitter.py</files>
  <action>
    Create bot/audio_splitter.py with AudioSplitter class following VideoSplitter patterns:

    **Class structure:**
    - __init__(self, input_path: str, output_dir: str)
    - _check_ffmpeg() -> bool (static)
    - _check_ffprobe() -> bool (static)
    - get_audio_duration() -> float (uses ffprobe, raises AudioSplitError)
    - split_by_duration(segment_duration: int) -> List[str] (segments of N seconds)
    - split_by_parts(num_parts: int) -> List[str] (N equal parts)

    **Implementation details:**
    - Use ffmpeg segment muxer for splitting (same as video)
    - Output naming: {basename}_part{NNN}.{ext} (e.g., audio_part001.mp3)
    - Support common audio formats: MP3, OGG, WAV, AAC, FLAC
    - Use -c copy for lossless splitting when possible
    - Minimum segment duration: 5 seconds (same as video)
    - Maximum parts: 20 (generous limit for audio)

    **Error handling:**
    - All error messages in Spanish
    - All logging in English
    - Raise AudioSplitError for operational failures

    **Follow VideoSplitter patterns from split_processor.py:**
    - Same method signatures where applicable
    - Same ffmpeg command structure
    - Same file collection pattern using glob
  </action>
  <verify>
    python3 -c "from bot.audio_splitter import AudioSplitter; print('Import OK')"
  </verify>
  <done>AudioSplitter class exists with split_by_duration and split_by_parts methods</done>
</task>

<task type="auto">
  <name>Task 3: Add audio split configuration</name>
  <files>bot/config.py</files>
  <action>
    Add audio split configuration to bot/config.py:

    **New fields in BotConfig dataclass:**
    - MAX_AUDIO_SEGMENTS: int = 20 (maximum parts for audio splitting)
    - MIN_AUDIO_SEGMENT_SECONDS: int = 5 (minimum segment duration)

    **In __post_init__ validation:**
    - Add validation for MAX_AUDIO_SEGMENTS > 0
    - Add validation for MIN_AUDIO_SEGMENT_SECONDS > 0

    **In load_config():**
    - Load MAX_AUDIO_SEGMENTS from env (default 20)
    - Load MIN_AUDIO_SEGMENT_SECONDS from env (default 5)

    Place audio split config after existing audio config (after MP3_BITRATE).
  </action>
  <verify>
    python3 -c "from bot.config import config; print(f'MAX_AUDIO_SEGMENTS={config.MAX_AUDIO_SEGMENTS}'); print(f'MIN_AUDIO_SEGMENT_SECONDS={config.MIN_AUDIO_SEGMENT_SECONDS}')"
  </verify>
  <done>Configuration values are accessible via config.MAX_AUDIO_SEGMENTS and config.MIN_AUDIO_SEGMENT_SECONDS</done>
</task>

</tasks>

<verification>
- [ ] AudioSplitError exists in bot/error_handler.py
- [ ] bot/audio_splitter.py has AudioSplitter class
- [ ] AudioSplitter has split_by_duration method
- [ ] AudioSplitter has split_by_parts method
- [ ] Output files follow naming pattern: {name}_part{NNN}.{ext}
- [ ] config.MAX_AUDIO_SEGMENTS is defined
- [ ] config.MIN_AUDIO_SEGMENT_SECONDS is defined
- [ ] All imports work without errors
</verification>

<success_criteria>
1. AudioSplitter class can be imported and instantiated
2. split_by_duration creates segments of specified duration
3. split_by_parts creates specified number of equal parts
4. Files are named sequentially (part001, part002, etc.)
5. Spanish error messages for all error cases
6. Configuration values are validated at startup
</success_criteria>

<output>
After completion, create `.planning/phases/04-audio-split-join/04-01-SUMMARY.md`
</output>
