---
phase: 04-audio-split-join
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/audio_joiner.py
autonomous: true

must_haves:
  truths:
    - "AudioJoiner class exists with add_audio method"
    - "AudioJoiner class has join_audios method"
    - "Join supports multiple audio formats (MP3, OGG, WAV, AAC, FLAC)"
    - "Spanish error messages for all failure cases"
    - "English logging for debugging"
  artifacts:
    - path: "bot/audio_joiner.py"
      provides: "AudioJoiner class for joining audio files"
      min_lines: 200
      exports: ["AudioJoiner"]
  key_links:
    - from: "bot/audio_joiner.py"
      to: "bot/error_handler.py"
      via: "AudioJoinError exception"
      pattern: "from bot.error_handler import AudioJoinError"
---

<objective>
Create AudioJoiner class for joining multiple audio files into a single continuous audio file.

Purpose: Enable users to concatenate multiple audio files in sequence.
Output: bot/audio_joiner.py with AudioJoiner class following VideoJoiner patterns.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/join_processor.py
@bot/audio_processor.py
@bot/error_handler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AudioJoinError exception class</name>
  <files>bot/error_handler.py</files>
  <action>
    Add AudioJoinError exception class to bot/error_handler.py following the existing pattern:
    - Inherit from VideoProcessingError
    - Default Spanish message: "No pude unir los archivos de audio"
    - Add to ERROR_MESSAGES dict with user-friendly Spanish message
    - Place after AudioSplitError class (from plan 04-01)

    Follow the exact same pattern as VideoJoinError but for audio operations.
  </action>
  <verify>grep -n "class AudioJoinError" bot/error_handler.py</verify>
  <done>AudioJoinError class exists with proper inheritance and error message mapping</done>
</task>

<task type="auto">
  <name>Task 2: Create AudioJoiner class</name>
  <files>bot/audio_joiner.py</files>
  <action>
    Create bot/audio_joiner.py with AudioJoiner class following VideoJoiner patterns:

    **Class structure:**
    - __init__(self, output_path: str)
    - _check_ffmpeg() -> bool (static)
    - _check_ffprobe() -> bool (static)
    - add_audio(audio_path: str) -> None (adds audio to join list)
    - _get_audio_info(audio_path: str) -> Tuple[str, str] (codec, container)
    - _need_normalization() -> bool (check if formats differ)
    - _normalize_audios(temp_dir: str) -> List[str] (convert to common format)
    - _create_concat_file(audio_paths: List[str], concat_file_path: str) -> str
    - join_audios() -> bool (perform the join operation)
    - get_input_count() -> int
    - clear_audios() -> None

    **Implementation details:**
    - Use ffmpeg concat demuxer for joining (same as video)
    - Support common audio formats: MP3, OGG, WAV, AAC, FLAC
    - When formats differ, normalize to MP3 192k (consistent with MP3_BITRATE config)
    - Minimum 2 audio files required for joining
    - Maximum 20 audio files (same as MAX_AUDIO_SEGMENTS)

    **Format handling:**
    - If all inputs have same codec: use -c copy (lossless)
    - If codecs differ: normalize all to MP3 with libmp3lame at 192k
    - For MP3 output: use -id3v2_version 3 for metadata compatibility

    **Error handling:**
    - All error messages in Spanish
    - All logging in English
    - Raise AudioJoinError for operational failures

    **Follow VideoJoiner patterns from join_processor.py:**
    - Same method signatures where applicable
    - Same ffmpeg command structure
    - Same concat file creation pattern
  </action>
  <verify>
    python3 -c "from bot.audio_joiner import AudioJoiner; print('Import OK')"
  </verify>
  <done>AudioJoiner class exists with add_audio and join_audios methods</done>
</task>

<task type="auto">
  <name>Task 3: Add audio join configuration</name>
  <files>bot/config.py</files>
  <action>
    Add audio join configuration to bot/config.py:

    **New fields in BotConfig dataclass:**
    - JOIN_MAX_AUDIO_FILES: int = 20 (maximum audio files to join)
    - JOIN_MIN_AUDIO_FILES: int = 2 (minimum audio files required)
    - JOIN_AUDIO_TIMEOUT: int = 120 (timeout for join operation in seconds)

    **In __post_init__ validation:**
    - Add validation for JOIN_MAX_AUDIO_FILES > 0
    - Add validation for JOIN_MIN_AUDIO_FILES > 0
    - Add validation that JOIN_MIN_AUDIO_FILES < JOIN_MAX_AUDIO_FILES
    - Add validation for JOIN_AUDIO_TIMEOUT > 0

    **In load_config():**
    - Load JOIN_MAX_AUDIO_FILES from env (default 20)
    - Load JOIN_MIN_AUDIO_FILES from env (default 2)
    - Load JOIN_AUDIO_TIMEOUT from env (default 120)

    Place audio join config after audio split config (from plan 04-01).
  </action>
  <verify>
    python3 -c "from bot.config import config; print(f'JOIN_MAX_AUDIO_FILES={config.JOIN_MAX_AUDIO_FILES}'); print(f'JOIN_MIN_AUDIO_FILES={config.JOIN_MIN_AUDIO_FILES}'); print(f'JOIN_AUDIO_TIMEOUT={config.JOIN_AUDIO_TIMEOUT}')"
  </verify>
  <done>Configuration values are accessible and validated</done>
</task>

</tasks>

<verification>
- [ ] AudioJoinError exists in bot/error_handler.py
- [ ] bot/audio_joiner.py has AudioJoiner class
- [ ] AudioJoiner has add_audio method
- [ ] AudioJoiner has join_audios method
- [ ] AudioJoiner handles format normalization when needed
- [ ] config.JOIN_MAX_AUDIO_FILES is defined
- [ ] config.JOIN_MIN_AUDIO_FILES is defined
- [ ] config.JOIN_AUDIO_TIMEOUT is defined
- [ ] All imports work without errors
</verification>

<success_criteria>
1. AudioJoiner class can be imported and instantiated
2. add_audio adds files to the join list
3. join_audios concatenates all added files
4. Format normalization happens automatically when needed
5. Spanish error messages for all error cases
6. Configuration values are validated at startup
</success_criteria>

<output>
After completion, create `.planning/phases/04-audio-split-join/04-02-SUMMARY.md`
</output>
