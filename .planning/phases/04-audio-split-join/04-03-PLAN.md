---
phase: 04-audio-split-join
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "User can use /split_audio command to split audio by duration"
    - "User can use /split_audio command to split audio into N parts"
    - "User can use /join_audio command to start audio join session"
    - "Split generates files numbered sequentially (part1, part2, etc.)"
    - "Join accepts multiple audio files in sequence"
  artifacts:
    - path: "bot/handlers.py"
      provides: "Command handlers for /split_audio and /join_audio"
      exports: ["handle_split_audio_command", "handle_join_audio_start", "handle_join_audio_file", "handle_join_audio_done", "handle_join_audio_cancel"]
    - path: "bot/main.py"
      provides: "Handler registrations for split/join commands"
  key_links:
    - from: "bot/handlers.py"
      to: "bot/audio_splitter.py"
      via: "AudioSplitter import and usage"
      pattern: "from bot.audio_splitter import AudioSplitter"
    - from: "bot/handlers.py"
      to: "bot/audio_joiner.py"
      via: "AudioJoiner import and usage"
      pattern: "from bot.audio_joiner import AudioJoiner"
    - from: "bot/main.py"
      to: "bot/handlers.py"
      via: "CommandHandler registration"
      pattern: "CommandHandler.*split_audio|join_audio"
---

<objective>
Implement Telegram command handlers for /split_audio and /join_audio commands.

Purpose: Provide user-facing commands to split and join audio files via Telegram bot.
Output: Updated bot/handlers.py with split/join handlers and bot/main.py with registrations.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bot/handlers.py
@bot/main.py
@bot/audio_splitter.py
@bot/audio_joiner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement /split_audio command handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_split_audio_command function to bot/handlers.py following video split handler patterns:

    **Command syntax:**
    - /split_audio duration 30 - Split into 30-second segments
    - /split_audio parts 5 - Split into 5 equal parts
    - /split_audio (alone) - Split into 60-second segments (default)

    **Implementation requirements:**
    - Get audio from message (update.message.audio) or reply
    - Validate file size using config.MAX_AUDIO_FILE_SIZE_MB
    - Parse command arguments (same pattern as handle_split_command)
    - Use TempManager for automatic cleanup
    - Download audio file with retry logic
    - Validate audio using validate_audio_file
    - Check disk space before processing
    - Use AudioSplitter for splitting operation
    - Send segments sequentially with progress updates
    - Send completion message with total parts

    **Error handling:**
    - Handle DownloadError, AudioSplitError, ProcessingTimeoutError, ValidationError
    - Use handle_processing_error for consistent error messages
    - Delete processing message on success/error

    **User messages (Spanish):**
    - "Dividiendo audio en segmentos de {N} segundos..."
    - "Dividiendo audio en {N} partes iguales..."
    - "Enviando parte {i} de {total}..."
    - "춰Listo! El audio se dividi칩 en {N} partes."

    Add imports at top:
    - from bot.audio_splitter import AudioSplitter
    - Add AudioSplitError to error_handler imports
  </action>
  <verify>grep -n "handle_split_audio_command" bot/handlers.py | head -5</verify>
  <done>handle_split_audio_command function exists with full implementation</done>
</task>

<task type="auto">
  <name>Task 2: Implement /join_audio command handlers</name>
  <files>bot/handlers.py</files>
  <action>
    Add audio join command handlers to bot/handlers.py following video join handler patterns:

    **Functions to add:**
    1. handle_join_audio_start - Start join session
    2. handle_join_audio_file - Collect audio files during session
    3. handle_join_audio_done - Complete and join files
    4. handle_join_audio_cancel - Cancel session

    **Command flow:**
    - /join_audio - Start session, show instructions
    - User sends audio files one by one
    - /done - Join all collected files
    - /cancel - Cancel session and cleanup

    **Implementation requirements:**
    - Use context.user_data["join_audio_session"] for session state
    - Track: audio_files[], temp_mgr, last_activity
    - Session timeout: config.JOIN_SESSION_TIMEOUT (300s)
    - Min files: config.JOIN_MIN_AUDIO_FILES (2)
    - Max files: config.JOIN_MAX_AUDIO_FILES (20)
    - Use AudioJoiner for joining operation
    - Send joined audio as downloadable file

    **Session state structure:**
    ```python
    {
        "audios": [],  # List of file paths
        "temp_mgr": TempManager(),
        "last_activity": time,
    }
    ```

    **User messages (Spanish):**
    - "游꿧 *Modo uni칩n de audio activado*\n\nEnv칤ame los archivos de audio..."
    - "Audio {N} agregado. Env칤a m치s o usa /done para unir."
    - "Necesitas {N} audio(s) m치s para unir."
    - "Uniendo {N} audios... Esto puede tomar un momento."
    - "Audio unido ({N} partes)"
    - "Sesi칩n cancelada. {N} audio(s) descartados."

    Add imports at top:
    - from bot.audio_joiner import AudioJoiner
    - Add AudioJoinError to error_handler imports
  </action>
  <verify>
    grep -n "handle_join_audio_start\|handle_join_audio_file\|handle_join_audio_done\|handle_join_audio_cancel" bot/handlers.py
  </verify>
  <done>All four join audio handlers exist with full implementation</done>
</task>

<task type="auto">
  <name>Task 3: Register handlers in main.py</name>
  <files>bot/main.py</files>
  <action>
    Register audio split/join handlers in bot/main.py:

    **Import additions:**
    Add to the handlers import:
    - handle_split_audio_command
    - handle_join_audio_start
    - handle_join_audio_done
    - handle_join_audio_cancel

    **Handler registrations (add after existing handlers):**
    ```python
    # Audio split command
    application.add_handler(CommandHandler("split_audio", handle_split_audio_command))

    # Audio join commands
    application.add_handler(CommandHandler("join_audio", handle_join_audio_start))
    application.add_handler(CommandHandler("done", handle_join_audio_done))  # Note: may conflict with video join
    application.add_handler(CommandHandler("cancel", handle_join_audio_cancel))  # Note: may conflict with video join
    ```

    **Important:** The /done and /cancel commands are shared between video join and audio join.
    This is intentional - the handler should check context.user_data to determine which session
    is active and route accordingly. Document this in the code comments.

    **Update /start command help text:**
    Add to the help message in handle_start:
    - "/split_audio [duration|parts] <valor> - Divide un audio en segmentos"
    - "/join_audio - Une m칰ltiples archivos de audio"
  </action>
  <verify>
    grep -n "split_audio\|join_audio" bot/main.py
  </verify>
  <done>All handlers registered in main.py and help text updated</done>
</task>

</tasks>

<verification>
- [ ] handle_split_audio_command exists in bot/handlers.py
- [ ] handle_join_audio_start exists in bot/handlers.py
- [ ] handle_join_audio_file exists in bot/handlers.py
- [ ] handle_join_audio_done exists in bot/handlers.py
- [ ] handle_join_audio_cancel exists in bot/handlers.py
- [ ] Handlers are registered in bot/main.py
- [ ] /start help text includes new commands
- [ ] All imports work without errors
</verification>

<success_criteria>
1. /split_audio command splits audio files by duration or parts
2. /join_audio command starts audio join session
3. Users can send multiple audio files during join session
4. /done completes audio joining and sends result
5. /cancel cancels audio join session
6. Help text shows new commands
7. Error handling follows existing patterns
</success_criteria>

<output>
After completion, create `.planning/phases/04-audio-split-join/04-03-SUMMARY.md`
</output>
