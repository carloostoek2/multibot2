---
phase: 06-audio-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "User can send /bass_boost command and see intensity selection keyboard"
    - "User can send /treble_boost command and see intensity selection keyboard"
    - "Intensity selection uses inline keyboard with levels 1-10"
    - "Callback handlers process bass/treble enhancement with selected intensity"
    - "Processed audio is sent back to user with confirmation message"
    - "Help text includes /bass_boost and /treble_boost commands"
  artifacts:
    - path: "bot/handlers.py"
      provides: "handle_bass_boost_command and handle_treble_boost_command handlers"
      contains: ["def handle_bass_boost_command", "def handle_treble_boost_command", "def handle_intensity_selection"]
    - path: "bot/main.py"
      provides: "Handler registration for bass/treble commands"
      contains: ["bass_boost", "treble_boost", "CallbackQueryHandler.*intensity"]
  key_links:
    - from: "bot/handlers.py"
      to: "bot/audio_enhancer.py"
      via: "import AudioEnhancer"
      pattern: "from bot.audio_enhancer import AudioEnhancer"
    - from: "bot/handlers.py"
      to: "bot/error_handler.py"
      via: "import AudioEnhancementError"
      pattern: "from bot.error_handler import.*AudioEnhancementError"
    - from: "handle_bass_boost_command"
      to: "inline keyboard"
      via: "InlineKeyboardMarkup with intensity buttons"
      pattern: "callback_data=\"bass:\d+\""
    - from: "handle_treble_boost_command"
      to: "inline keyboard"
      via: "InlineKeyboardMarkup with intensity buttons"
      pattern: "callback_data=\"treble:\d+\""
---

<objective>
Implement /bass_boost and /treble_boost commands with inline keyboard intensity selection (1-10) for audio enhancement.

Purpose: Provide user-facing commands to apply bass and treble enhancement effects to audio files with adjustable intensity levels.
Output: Command handlers in handlers.py and registration in main.py with inline keyboard UI
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/data/data/com.termux/files/home/repos/multibot2/bot/handlers.py
@/data/data/com.termux/files/home/repos/multibot2/bot/main.py
@/data/data/com.termux/files/home/repos/multibot2/bot/audio_enhancer.py

Reference patterns from:
- handle_convert_audio_command (line 2163) for command structure
- handle_format_selection (line 2219) for callback handling
- Inline keyboard pattern: 3+2 layout from format conversion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement /bass_boost command handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_bass_boost_command function to handlers.py:

    1. Function signature: async def handle_bass_boost_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Input validation (follow handle_convert_audio_command pattern):
       - Get audio from message or reply using _get_audio_from_message helper
       - If no audio, reply: "Envía /bass_boost respondiendo a un archivo de audio o adjunta el audio al mensaje."
       - Validate file size using validate_file_size

    3. Store state in context.user_data:
       - "enhance_audio_file_id": audio.file_id
       - "enhance_audio_correlation_id": correlation_id
       - "enhance_type": "bass"

    4. Create inline keyboard for intensity selection (levels 1-10):
       - Layout: 5 buttons per row (2 rows: 1-5, 6-10)
       - Callback data format: "bass:1", "bass:2", etc.
       - Button text: "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"

    5. Send message: "Selecciona la intensidad del bass boost (1-10):"

    6. Import AudioEnhancer and AudioEnhancementError at top of file
  </action>
  <verify>grep -n "def handle_bass_boost_command" bot/handlers.py</verify>
  <done>handle_bass_boost_command exists with intensity keyboard, proper validation, and state storage</done>
</task>

<task type="auto">
  <name>Task 2: Implement /treble_boost command handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_treble_boost_command function to handlers.py:

    1. Function signature: async def handle_treble_boost_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Input validation (same pattern as bass_boost):
       - Get audio from message or reply
       - Validate file size
       - Store state with "enhance_type": "treble"

    3. Create inline keyboard for intensity selection:
       - Same layout as bass_boost: 5 buttons per row
       - Callback data format: "treble:1", "treble:2", etc.

    4. Send message: "Selecciona la intensidad del treble boost (1-10):"

    5. Both handlers should share the same state keys for file_id and correlation_id
       (user can only have one enhancement session at a time)
  </action>
  <verify>grep -n "def handle_treble_boost_command" bot/handlers.py</verify>
  <done>handle_treble_boost_command exists with intensity keyboard, mirroring bass_boost pattern</done>
</task>

<task type="auto">
  <name>Task 3: Implement intensity selection callback handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_intensity_selection function to handlers.py:

    1. Function signature: async def handle_intensity_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Parse callback data:
       - Format: "bass:5" or "treble:8"
       - Split by ":" to get enhance_type and intensity
       - Validate intensity is 1-10 integer

    3. Retrieve state from context.user_data:
       - file_id, correlation_id, enhance_type
       - Verify enhance_type matches callback prefix

    4. Processing flow (follow handle_format_selection pattern):
       - Update message to show processing: "Aplicando {effect} boost (intensidad {intensity})..."
       - Use TempManager for automatic cleanup
       - Download audio file with _download_with_retry
       - Validate audio with validate_audio_file
       - Check disk space with check_disk_space

    5. Apply enhancement:
       - Create AudioEnhancer instance
       - Call bass_boost(intensity) or treble_boost(intensity)
       - On success: send enhanced audio document
       - On error: raise AudioEnhancementError

    6. Success message: "¡Listo! Audio mejorado con {effect} boost (intensidad {intensity}/10)."

    7. Error handling:
       - Catch AudioEnhancementError, ValidationError, DownloadError
       - Use handle_processing_error for consistent error messages
  </action>
  <verify>grep -n "def handle_intensity_selection" bot/handlers.py</verify>
  <done>handle_intensity_selection callback handler exists with full processing flow</done>
</task>

<task type="auto">
  <name>Task 4: Register handlers and update help text</name>
  <files>bot/main.py, bot/handlers.py</files>
  <action>
    1. In bot/main.py:
       - Import handle_bass_boost_command, handle_treble_boost_command, handle_intensity_selection
       - Add CommandHandler("bass_boost", handle_bass_boost_command)
       - Add CommandHandler("treble_boost", handle_treble_boost_command)
       - Add CallbackQueryHandler(handle_intensity_selection, pattern="^(bass|treble):\\d+$")
       - Place handlers in appropriate order (after convert_audio handlers)

    2. In bot/handlers.py (help text):
       - Add to help_text: "/bass_boost - Aumenta los bajos del audio (intensidad ajustable)"
       - Add to help_text: "/treble_boost - Aumenta los agudos del audio (intensidad ajustable)"
       - Place after /convert_audio in the list
  </action>
  <verify>grep -n "bass_boost\|treble_boost" bot/main.py bot/handlers.py | head -20</verify>
  <done>Handlers registered in main.py, help text updated with new commands</done>
</task>

</tasks>

<verification>
1. /bass_boost command shows inline keyboard with intensity 1-10
2. /treble_boost command shows inline keyboard with intensity 1-10
3. Selecting intensity applies the effect and sends enhanced audio
4. Help text includes both commands
5. Error handling works for invalid files
</verification>

<success_criteria>
- handle_bass_boost_command exists and shows intensity keyboard (1-10)
- handle_treble_boost_command exists and shows intensity keyboard (1-10)
- handle_intensity_selection processes callbacks and applies enhancement
- Callback pattern "^(bass|treble):\d+$" properly registered
- Both commands listed in help text
- Handlers follow existing patterns from format conversion
- AudioEnhancer integration works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-audio-enhancement/06-02-SUMMARY.md`
</output>
