---
phase: 06-audio-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - bot/handlers.py
  - bot/main.py
autonomous: true

must_haves:
  truths:
    - "User can send /equalize command and see 3-band equalizer interface"
    - "Equalizer allows independent adjustment of bass, mid, and treble bands"
    - "Each band can be set from -10 to +10 (cut to boost)"
    - "Interface uses inline keyboard with + and - buttons for each band"
    - "User can preview current settings and apply when ready"
    - "Help text includes /equalize command"
  artifacts:
    - path: "bot/handlers.py"
      provides: "handle_equalize_command and handle_equalizer_adjustment handlers"
      contains: ["def handle_equalize_command", "def handle_equalizer_adjustment", "def handle_equalizer_apply"]
    - path: "bot/main.py"
      provides: "Handler registration for equalize command"
      contains: ["equalize", "CallbackQueryHandler.*eq_"]
  key_links:
    - from: "bot/handlers.py"
      to: "bot/audio_enhancer.py"
      via: "import AudioEnhancer"
      pattern: "from bot.audio_enhancer import AudioEnhancer"
    - from: "handle_equalize_command"
      to: "inline keyboard"
      via: "InlineKeyboardMarkup with eq_bass_up, eq_bass_down, etc."
      pattern: "callback_data=\"eq_(bass|mid|treble)_(up|down|reset)\""
    - from: "handle_equalizer_apply"
      to: "AudioEnhancer.equalize"
      via: "enhancer.equalize(bass, mid, treble)"
      pattern: "\.equalize\(.*bass.*mid.*treble"
---

<objective>
Implement /equalize command with interactive 3-band equalizer (bass/mid/treble) using inline keyboard adjustments.

Purpose: Provide users with fine-grained control over audio frequency response through an interactive equalizer interface.
Output: Equalizer command handler with +/- buttons for each band and apply functionality
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/data/data/com.termux/files/home/repos/multibot2/bot/handlers.py
@/data/data/com.termux/files/home/repos/multibot2/bot/main.py
@/data/data/com.termux/files/home/repos/multibot2/bot/audio_enhancer.py

Reference patterns:
- handle_convert_audio_command for command structure
- handle_format_selection for callback handling
- Session state management with context.user_data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement /equalize command handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_equalize_command function to handlers.py:

    1. Function signature: async def handle_equalize_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Input validation (follow existing pattern):
       - Get audio from message or reply using _get_audio_from_message
       - Validate file size
       - If no audio: "EnvÃ­a /equalize respondiendo a un archivo de audio o adjunta el audio al mensaje."

    3. Initialize equalizer state in context.user_data:
       - "eq_file_id": audio.file_id
       - "eq_correlation_id": correlation_id
       - "eq_bass": 0 (range -10 to +10)
       - "eq_mid": 0 (range -10 to +10)
       - "eq_treble": 0 (range -10 to +10)

    4. Create inline keyboard layout:
       ```
       Bass:   [-] [0] [+]    (callback: eq_bass_down, eq_bass_up)
       Mid:    [-] [0] [+]    (callback: eq_mid_down, eq_mid_up)
       Treble: [-] [0] [+]    (callback: eq_treble_down, eq_treble_up)
       [Reset] [Aplicar]      (callback: eq_reset, eq_apply)
       ```

    5. Display current values in message:
       "Ecualizador de 3 bandas:\nðŸŽµ Bass: 0\nðŸŽµ Mid: 0\nðŸŽµ Treble: 0\n\nAjusta cada banda y presiona Aplicar."

    6. Helper function _get_equalizer_keyboard(bass, mid, treble) to generate keyboard
  </action>
  <verify>grep -n "def handle_equalize_command" bot/handlers.py</verify>
  <done>handle_equalize_command exists with 3-band equalizer keyboard and state initialization</done>
</task>

<task type="auto">
  <name>Task 2: Implement equalizer adjustment callback handler</name>
  <files>bot/handlers.py</files>
  <action>
    Add handle_equalizer_adjustment function to handlers.py:

    1. Function signature: async def handle_equalizer_adjustment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None

    2. Register with pattern: "^eq_(bass|mid|treble)_(up|down|reset)$|^eq_apply$|^eq_reset_all$"

    3. Parse callback data:
       - "eq_bass_up", "eq_bass_down" - adjust bass by +/- 2
       - "eq_mid_up", "eq_mid_down" - adjust mid by +/- 2
       - "eq_treble_up", "eq_treble_down" - adjust treble by +/- 2
       - "eq_reset" - reset all bands to 0
       - "eq_apply" - apply current settings

    4. Value constraints:
       - Each band: minimum -10, maximum +10
       - Step size: 2 (so values go: -10, -8, -6, -4, -2, 0, 2, 4, 6, 8, 10)

    5. Update flow for adjustments (up/down/reset):
       - Get current values from context.user_data
       - Calculate new value with clamping
       - Store back to context.user_data
       - Update message text and keyboard inline
       - Use query.edit_message_text with new values

    6. Message format:
       ```
       Ecualizador de 3 bandas:
       ðŸŽµ Bass: -4
       ðŸŽµ Mid: +2
       ðŸŽµ Treble: 0

       Ajusta cada banda y presiona Aplicar.
       ```
       (Use + sign for positive values, nothing for zero)

    7. Reset sets all bands to 0 and updates message
  </action>
  <verify>grep -n "def handle_equalizer_adjustment" bot/handlers.py</verify>
  <done>handle_equalizer_adjustment exists with +/- logic, value clamping, and inline updates</done>
</task>

<task type="auto">
  <name>Task 3: Implement equalizer apply functionality</name>
  <files>bot/handlers.py</files>
  <action>
    Add equalizer apply logic to handle_equalizer_adjustment (when callback is "eq_apply"):

    1. Retrieve state:
       - file_id, correlation_id from context.user_data
       - bass, mid, treble values

    2. Check if all values are 0:
       - If yes, notify user: "No has hecho ajustes. Modifica al menos una banda antes de aplicar."
       - Return without processing

    3. Processing flow:
       - Update message: "Aplicando ecualizaciÃ³n (Bass: X, Mid: Y, Treble: Z)..."
       - Use TempManager for cleanup
       - Download audio with _download_with_retry
       - Validate with validate_audio_file
       - Check disk space

    4. Apply equalization:
       - Create AudioEnhancer instance
       - Call enhancer.equalize(bass=bass, mid=mid, treble=treble)
       - Map -10..+10 to appropriate dB values

    5. Success:
       - Send audio document
       - Edit message to: "Â¡Listo! EcualizaciÃ³n aplicada:\nðŸŽµ Bass: X\nðŸŽµ Mid: Y\nðŸŽµ Treble: Z"
       - Clear context.user_data equalizer keys

    6. Error handling:
       - Catch AudioEnhancementError, ValidationError, DownloadError
       - Use handle_processing_error
       - On error, keep state so user can retry
  </action>
  <verify>grep -A 20 "eq_apply" bot/handlers.py | grep -E "equalize|Aplicando|Listo"</verify>
  <done>Equalizer apply logic downloads, processes with AudioEnhancer.equalize, and sends result</done>
</task>

<task type="auto">
  <name>Task 4: Register handlers and update help text</name>
  <files>bot/main.py, bot/handlers.py</files>
  <action>
    1. In bot/main.py:
       - Import handle_equalize_command, handle_equalizer_adjustment
       - Add CommandHandler("equalize", handle_equalize_command)
       - Add CallbackQueryHandler(handle_equalizer_adjustment, pattern="^eq_")
       - Place after bass/treble handlers

    2. In bot/handlers.py (help text):
       - Add: "/equalize - Ecualizador de 3 bandas (bass, mid, treble)"
       - Place after /treble_boost in the list

    3. Ensure imports at top of handlers.py include AudioEnhancer and AudioEnhancementError
  </action>
  <verify>grep -n "equalize" bot/main.py bot/handlers.py | head -15</verify>
  <done>Equalize handlers registered, help text updated with /equalize command</done>
</task>

</tasks>

<verification>
1. /equalize command shows 3-band equalizer with +/- buttons
2. Adjusting values updates the display inline
3. Values are clamped to -10..+10 range
4. Apply button processes audio with equalize() method
5. Help text includes /equalize command
6. Reset button clears all adjustments
</verification>

<success_criteria>
- handle_equalize_command exists with interactive 3-band equalizer keyboard
- handle_equalizer_adjustment handles up/down/reset/apply callbacks
- Bass, mid, treble values clamped to -10..+10 range
- Step size of 2 for incremental adjustments
- Inline message updates show current values
- Apply button triggers AudioEnhancer.equalize() with current values
- Help text includes /equalize command description
- All state stored in context.user_data with "eq_" prefix
</success_criteria>

<output>
After completion, create `.planning/phases/06-audio-enhancement/06-03-SUMMARY.md`
</output>
