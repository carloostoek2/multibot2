---
phase: 06-audio-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/audio_enhancer.py
  - bot/error_handler.py
autonomous: true

must_haves:
  truths:
    - "AudioEnhancer class exists with bass_boost, treble_boost, and equalize methods"
    - "Bass boost uses ffmpeg firequalizer or equalizer filter with configurable gain"
    - "Treble boost uses ffmpeg treble filter with configurable gain"
    - "3-band equalizer allows independent control of bass/mid/treble frequencies"
    - "Intensity parameters are validated (clamped to safe ranges)"
    - "AudioEnhancementError exception exists with Spanish error message"
  artifacts:
    - path: "bot/audio_enhancer.py"
      provides: "AudioEnhancer class with bass_boost, treble_boost, equalize methods"
      min_lines: 200
    - path: "bot/error_handler.py"
      provides: "AudioEnhancementError exception class"
      contains: "class AudioEnhancementError"
  key_links:
    - from: "bot/audio_enhancer.py"
      to: "bot/error_handler.py"
      via: "import AudioEnhancementError"
      pattern: "from bot.error_handler import AudioEnhancementError"
    - from: "AudioEnhancer.bass_boost"
      to: "ffmpeg subprocess"
      via: "subprocess.run with firequalizer filter"
      pattern: "firequalizer.*gain"
    - from: "AudioEnhancer.equalize"
      to: "ffmpeg subprocess"
      via: "subprocess.run with multiple equalizer bands"
      pattern: "equalizer.*frequency"
---

<objective>
Create AudioEnhancer class with bass boost, treble boost, and 3-band equalizer functionality using ffmpeg filters.

Purpose: Provide the core audio enhancement infrastructure for Phase 6, enabling users to improve audio quality with adjustable bass, treble, and equalization effects.
Output: bot/audio_enhancer.py with AudioEnhancer class and AudioEnhancementError in error_handler.py
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/data/data/com.termux/files/home/repos/multibot2/bot/audio_format_converter.py
@/data/data/com.termux/files/home/repos/multibot2/bot/error_handler.py
@/data/data/com.termux/files/home/repos/multibot2/bot/audio_processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AudioEnhancementError exception</name>
  <files>bot/error_handler.py</files>
  <action>
    Add AudioEnhancementError exception class to error_handler.py following the existing pattern:
    - Inherit from VideoProcessingError
    - Default Spanish message: "Error aplicando mejora de audio"
    - Add to ERROR_MESSAGES dict with user-friendly message: "No pude aplicar la mejora de audio. Verifica que el archivo sea v√°lido."
    Follow the exact same pattern as AudioFormatConversionError (lines 122-127).
  </action>
  <verify>grep -n "class AudioEnhancementError" bot/error_handler.py</verify>
  <done>AudioEnhancementError class exists with proper inheritance and Spanish error message</done>
</task>

<task type="auto">
  <name>Task 2: Create AudioEnhancer class with bass and treble boost</name>
  <files>bot/audio_enhancer.py</files>
  <action>
    Create bot/audio_enhancer.py with AudioEnhancer class:

    1. Class structure following AudioFormatConverter pattern:
       - __init__(self, input_path: str, output_path: str)
       - _check_ffmpeg() static method
       - Input/output path validation

    2. bass_boost(intensity: float = 5.0) -> bool method:
       - intensity range: 1.0 to 10.0 (clamped)
       - Use ffmpeg firequalizer filter for bass enhancement
       - Filter: firequalizer=gain_entry='entry(0, gain)'
       - Gain calculation: intensity * 2 (maps 1-10 to 2-20dB boost)
       - Apply low-shelf filter around 100-200Hz
       - Example: -af "firequalizer=gain_entry='entry(0,10)':gain_entry='entry(200,0)':delay=0.01"
       - Or use: -af "bass=gain=10" (simpler, use this if firequalizer too complex)

    3. treble_boost(intensity: float = 5.0) -> bool method:
       - intensity range: 1.0 to 10.0 (clamped)
       - Use ffmpeg treble filter: -af "treble=gain=X"
       - Gain calculation: intensity * 1.5 (maps 1-10 to 1.5-15dB boost)
       - Frequency around 3000-10000Hz range

    4. Error handling:
       - Raise AudioEnhancementError on failure
       - Spanish error messages for user-facing errors
       - English logging for debugging

    5. Include module-level docstring and __all__ exports.
  </action>
  <verify>python -c "from bot.audio_enhancer import AudioEnhancer; print('Import OK')"</verify>
  <done>AudioEnhancer class exists with bass_boost and treble_boost methods, imports work</done>
</task>

<task type="auto">
  <name>Task 3: Add 3-band equalizer method</name>
  <files>bot/audio_enhancer.py</files>
  <action>
    Add equalize(bass: float = 0, mid: float = 0, treble: float = 0) -> bool method to AudioEnhancer:

    1. Parameters (each range -10 to +10, default 0):
       - bass: Low frequencies (20-250Hz)
       - mid: Mid frequencies (250Hz-4kHz)
       - treble: High frequencies (4kHz-20kHz)

    2. Use ffmpeg equalizer filter with multiple bands:
       - Band 1 (bass): equalizer=f=125:width_type=o:width=2:gain=X
       - Band 2 (mid): equalizer=f=1000:width_type=o:width=2:gain=Y
       - Band 3 (treble): equalizer=f=8000:width_type=o:width=2:gain=Z
       - Chain filters with comma: -af "equalizer=...,equalizer=...,equalizer=..."

    3. Gain mapping:
       - Input -10 to +10 maps to -15dB to +15dB
       - 0 = no change (0dB)
       - Positive = boost, negative = cut

    4. Validation:
       - Clamp each band to valid range
       - Log actual gain values applied

    5. Return True on success, raise AudioEnhancementError on failure.

    Reference ffmpeg equalizer documentation for proper syntax.
  </action>
  <verify>grep -n "def equalize" bot/audio_enhancer.py && python -c "from bot.audio_enhancer import AudioEnhancer; a = AudioEnhancer('/tmp/test.mp3', '/tmp/out.mp3'); print('equalize method exists:', hasattr(a, 'equalize'))"</verify>
  <done>equalize method exists with bass/mid/treble parameters, uses ffmpeg equalizer filter</done>
</task>

</tasks>

<verification>
1. All imports work: from bot.audio_enhancer import AudioEnhancer
2. AudioEnhancer has methods: bass_boost, treble_boost, equalize
3. AudioEnhancementError exists in error_handler.py
4. Each method has proper intensity/band parameter validation
5. ffmpeg filter syntax is correct for bass, treble, and equalizer
</verification>

<success_criteria>
- AudioEnhancer class exists in bot/audio_enhancer.py with 3 methods
- AudioEnhancementError added to bot/error_handler.py
- bass_boost uses ffmpeg bass filter with intensity 1-10 mapping to appropriate dB gain
- treble_boost uses ffmpeg treble filter with intensity 1-10 mapping to appropriate dB gain
- equalize uses ffmpeg equalizer filter with 3 bands (bass/mid/treble), range -10 to +10
- All methods validate parameters and raise AudioEnhancementError on failure
- Code follows existing patterns from audio_format_converter.py
</success_criteria>

<output>
After completion, create `.planning/phases/06-audio-enhancement/06-01-SUMMARY.md`
</output>
